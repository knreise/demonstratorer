<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet">

        <link href='../common/css/cesium_base.css' rel='stylesheet' />
        <link href='../common/css/cesium_sidebar.css' rel='stylesheet' />

    </head>
    <body>

<div id="topbar" class="navbar-header">

    
    
    
    <a class="navbar-brand" rel="home" href="#" title="Folgefonna">
        <img src="../common/img/Kulturradet_simple.png" class="navbar-logo"></img>
    </a>
    
    
    
</div>

<div id="cesium-sidebar">

<div class="close-sidebar">
    <div class="lr">
        <div class="rl">
        </div>
    </div>
</div>




<div class="cesium-sidebar-body"></div>

</div>


<div class="spinner-wrapper">
    <div class="spinner"></div>
    
</div>

<div id="cesium-viewer"></div>


<script type="text/template" id="cesium_sparql_kulturminne_template">
<h3><%= label %></h3>

<div class="cesium-sidebar-body">
    <p><%= loklab%></p>
    <p><%= beskrivelse%></p>
    <img class="fullwidth" src="<%= lokimg %>" />
</div>
</script>


<script type="text/template" id="cesium_wikipedia_template">

<h3><%= title %></h3>


<% if(images) { %>
    <img class="fullwidth" src="<%= images[0] %>" />
<% } %>

<p><%= content %></p>



<a href=\"<%= link %>\"></a>
</script>


<script type="text/template" id="cesium_arc_kulturminne_template">

<h3><%= Navn %></h3>


</script>




        <script src="../bower_components/jquery/dist/jquery.min.js" type="text/javascript"></script>
        <script src="../bower_components/underscore/underscore-min.js" type="text/javascript"></script>
        <script src="../bower_components/leaflet/dist/leaflet.js" type="text/javascript"></script>
        <script src="../bower_components/esri2geo/esri2geo.js" type="text/javascript"></script>
        <script src="../bower_components/KNreiseAPI/dist/KNreiseAPI.js" type="text/javascript"></script>
        <script src="../common/js/ErrorHandler.js" type="text/javascript"></script>
        <script src="../common/js/util.js" type="text/javascript"></script>
        <script src="../bower_components/cesium1.9/Build/CesiumUnminified/Cesium.js" type="text/javascript"></script>
        <script src="../bower_components/togeojson/togeojson.js" type="text/javascript"></script>
        <script src="../bower_components/wellknown/wellknown.js" type="text/javascript"></script>
        <script src="../bower_components/proj4/dist/proj4.js" type="text/javascript"></script>
        <script src="../bower_components/CryptoJS/build/components/core.js" type="text/javascript"></script>
        <script src="../bower_components/CryptoJS/build/components/md5.js" type="text/javascript"></script>
        <script src="../bower_components/jquery-ui/jquery-ui.min.js" type="text/javascript"></script>
        <script src="../common/js/CesiumMap.js" type="text/javascript"></script>
        <script src="../common/js/DatasetLoader.js" type="text/javascript"></script>

        <script type="text/javascript">
            (function () {
                'use strict';

                var cesiumOptions = {
    animation: false,
    baseLayerPicker: false,
    fullscreenButton: false,
    geocoder: false,
    homeButton: false,
    infoBox: false,
    sceneModePicker: false,
    selectionIndicator: false,
    timeline: false,
    navigationHelpButton: false,
    navigationInstructionsInitiallyVisible: false,
    orderIndependentTranslucency: false
};

var map = new KR.CesiumMap('cesium-viewer', cesiumOptions);

var viewer = map.viewer;
var scene = map.viewer.scene;
var globe = scene.globe;

// Depth test: If this isn't on, objects will be visible through the terrain.
globe.depthTestAgainstTerrain = true;

var $sidebar = $('#cesium-sidebar');
var $loader = $('.spinner-wrapper');


// Setting up API and retrieving the Folgefonna geojson
var api = new KR.API();

var tur = {
    api: 'utno',
    id: '2.8158',
    type: 'gpx'
};
var folgefonnaGeojson;

api.getData(tur, function (geojson) {
    folgefonnaGeojson = geojson;
    //addFolgefonna2D(folgefonnaGeojson);
    buildFolgefonna3D(folgefonnaGeojson);
    loadKulturminner(getBbox(folgefonnaGeojson));
    loadWikipedia(getBboxLimit(folgefonnaGeojson, 20));
});


var sparqlKulturminneTemplate = _.template($('#cesium_sparql_kulturminne_template').html());
var arcKulturminneTemplate = _.template($('#cesium_arc_kulturminne_template').html());
var wikipediaTemplate = _.template($('#cesium_wikipedia_template').html());

var folgefonna;
var handler;

function addFolgefonna2D(geojson) {
    var coordinates = geojson.features[0].geometry.coordinates;
    var folgefonnaPos = _.map(coordinates, function (coordinatePair) {
        return Cesium.Cartesian3.fromDegrees(coordinatePair[0], coordinatePair[1]);
    });

    viewer.entities.add({
        polyline: {
            positions: folgefonnaPos,
            width: 10.0,
            material: new Cesium.PolylineGlowMaterialProperty({
                color: Cesium.Color.DEEPSKYBLUE,
                glowPower: 0.25
            })
        }
    });
}

function buildFolgefonna3D(geojson) {

    var coordinates = geojson.features[0].geometry.coordinates;
    var folgefonnaPos = _.map(coordinates, function (coordinatePair) {
        return new Cesium.Cartographic.fromDegrees(coordinatePair[0], coordinatePair[1]);
    });

    var promise = Cesium.sampleTerrain(viewer.terrainProvider, 14, folgefonnaPos);
    Cesium.when(promise, function (updatedPositions) {
        var heightCurve = Cesium.Ellipsoid.WGS84.cartographicArrayToCartesianArray(updatedPositions);

        folgefonna = viewer.entities.add({
            polyline: {
                positions: heightCurve,
                width: 10.0,
                material: new Cesium.PolylineGlowMaterialProperty({
                    color: Cesium.Color.DEEPSKYBLUE,
                    glowPower: 0.25
                })
            }
        });
        viewer.zoomTo(folgefonna);
        stopLoading();
    });
}

function getHeightsForGeoJsonPoints(geojson, callback, zoomLevel, extraHeight) {
    var allCoordinates = [];
    if (!extraHeight) {
        extraHeight = 0;
    }
    _.each(geojson.features, function (feature) {
        var fgeom = feature.geometry.coordinates;
        allCoordinates.push(new Cesium.Cartographic.fromDegrees(fgeom[0], fgeom[1]));
    });

    var promise = Cesium.sampleTerrain(viewer.terrainProvider, zoomLevel = 14, allCoordinates);
    Cesium.when(promise, function (updatedPositions) {
        var allCoordinatesHeight = updatedPositions;
        _.each(geojson.features, function (feature, count) {
            var newCoor = allCoordinatesHeight[count];
            feature.geometry.coordinates = [Cesium.Math.toDegrees(newCoor.longitude), Cesium.Math.toDegrees(newCoor.latitude), newCoor.height + extraHeight ];
        });
        callback(geojson);
    });
}



function getBboxLimit(geojson, limit) {
    var coordinates = geojson.features[0].geometry.coordinates;
    var minLat, minLon, maxLat, maxLon;
    minLon = coordinates[0][0];
    minLat = coordinates[0][1];
    maxLon = coordinates[0][0];
    maxLat = coordinates[0][1];
    _.each(coordinates, function (coordinatePair) {
        if (coordinatePair[0] < minLon) {
            minLon = coordinatePair[0] - 0.05;
        } else if (coordinatePair[1] < minLat) {
            minLat = coordinatePair[1] - 0.05;
        } else if (coordinatePair[0] > maxLon) {
            maxLon = coordinatePair[0] + 0.05;
        } else if (coordinatePair[1] > minLat) {
            maxLat = coordinatePair[1] + 0.05;
        }
    });

    var bbox = minLon + ',' + minLat + ','  + maxLon + ',' + maxLat;
    return bbox;
}



function getBbox(geojson) {
    var coordinates = geojson.features[0].geometry.coordinates;
    var minLat, minLon, maxLat, maxLon;
    minLon = coordinates[0][0];
    minLat = coordinates[0][1];
    maxLon = coordinates[0][0];
    maxLat = coordinates[0][1];
    _.each(coordinates, function (coordinatePair) {
        if (coordinatePair[0] < minLon) {
            minLon = coordinatePair[0] - 0.05;
        } else if (coordinatePair[1] < minLat) {
            minLat = coordinatePair[1] - 0.05;
        } else if (coordinatePair[0] > maxLon) {
            maxLon = coordinatePair[0] + 0.05;
        } else if (coordinatePair[1] > minLat) {
            maxLat = coordinatePair[1] + 0.05;
        }
    });
    var bbox = minLon + ',' + minLat + ','  + maxLon + ',' + maxLat;
    return bbox;
}


// getting kulturminner in areas
function loadKulturminner(bbox) {
    var fangstgroper = {
        api: 'kulturminnedata',
        layer: 0
    };
    
    api.getBbox(fangstgroper, bbox, function (res) {
        getHeightsForGeoJsonPoints(res, function (data) {
            var dataSource = Cesium.GeoJsonDataSource.load(data);
            viewer.dataSources.add(dataSource);
        });
    });
    sethandler();
}


function loadWikipedia(bbox) {
    var wikipedia = {
        api: 'wikipedia'
    };

    api.getBbox(wikipedia, bbox, function (res) {
        getHeightsForGeoJsonPoints(res, function (data) {
            var dataSource = Cesium.GeoJsonDataSource.load(data);
            viewer.dataSources.add(dataSource);
        });
    });
}


function sethandler() {
    var pickedEntities = new Cesium.EntityCollection();
    
    handler = new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);
    handler.setInputAction(function(movement) {
        console.log(movement);
        // get an array of all primitives at the mouse position
        var pickedObjects = scene.drillPick(movement.position);
        var pickedObject = scene.pick(movement.position);
         
        if (Cesium.defined(pickedObjects)) {
            //Update the collection of picked entities.
            pickedEntities.removeAll();
            for (var i = 0; i < pickedObjects.length; ++i) {
                var entity = pickedObjects[i].id;
                pickedEntities.add(entity);
                console.log(entity);
                show(entity.properties);
            }
        }
    }, Cesium.ScreenSpaceEventType.LEFT_CLICK);
}

function show(properties) {
    $sidebar.show('slide', {direction: 'left'}, 100);
    if (properties.dataset == 'Wikipedia') {
        $('.cesium-sidebar-body').html($(wikipediaTemplate(properties)));
    } else {
        $('.cesium-sidebar-body').html($(arcKulturminneTemplate(properties)));
    }
}

function stopLoading() {
    $loader.delay(2000).fadeOut({duration: 200});
}

function close() {
    $sidebar.hide('slide', {direction: 'left'}, 100);
}

$('.close-sidebar').on('click', function(e) {
    console.log('close');
    close();
});

            }());
        </script>
    </body>
</html>
