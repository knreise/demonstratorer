/*! KNreiseAPI 1.0.0 2015-05-21 */
var KR=this.KR||{};KR.Config={contentIcons:{IMAGE:"camera-retro",VIDEO:"file-video-o",SOUND:"music",TEXT:"file-text","default":"file-o"},datasetIcons:{Artsdatabanken:"paw",Kulturminnesok:"archive",Naturbase:"tree",MUSIT_DiMu:"flag",Musit:"flag",DigitaltMuseum:"flag",fangstlokaliteter:"circle"},providerColors:{Artsdatabanken:{name:"darkpuple",hex:"#5B396B"},"Digitalt fortalt":{name:"orange",hex:"#F69730"},DigitaltMuseum:{name:"cadetblue",hex:"#436978"},Industrimuseum:{name:"darkred",hex:"#A23336"},MUSIT:{name:"darkred",hex:"#A23336"},"Kulturminnesøk":{name:"green",hex:"#72B026"},Naturbase:{name:"purple",hex:"#D252B9"},"Sentralt stedsnavnregister":{name:"darkgreen",hex:"#728224"},"default":{name:"blue",hex:"#38A9DC"}},templates:{}},KR.Util={},function(a){"use strict";function b(a){return a*Math.PI/180}function c(a,b){if(b.datasets){var c=_.find(b.datasets,function(b){return b._knreise_id===a.properties.datasetID});return c.template}return b.template}a.createQueryParameterString=function(a){return _.map(a,function(a,b){return encodeURIComponent(b)+"="+encodeURIComponent(a)}).join("&")},a.sendRequest=function(a,b,c,d){return $.ajax({type:"get",url:a,success:function(a){c(b?b(a):a)},error:d})},a.createGeoJSONFeature=function(a,b){return{type:"Feature",geometry:{type:"Point",coordinates:[a.lng,a.lat]},properties:b}},a.CreateFeatureCollection=function(a){return{type:"FeatureCollection",features:a}},a.templateForDataset=function(a){return _.has(KR.Config.templates,a)?KR.Config.templates[a]:void 0},a.iconForDataset=function(a){return _.isArray(a)&&(a=a.join("_")),_.has(KR.Config.datasetIcons,a)?KR.Config.datasetIcons[a]:void 0},a.iconForFeature=function(b){var c=a.iconForDataset(b.properties.dataset);if(c)return c;var d=b.properties.contentType;return _.has(KR.Config.contentIcons,d)?KR.Config.contentIcons[d]:KR.Config.contentIcons["default"]},a.colorForFeature=function(a,b){b=b||"name";var c=a.properties.provider;return _.has(KR.Config.providerColors,c)?KR.Config.providerColors[c][b]:KR.Config.providerColors["default"][b]},a.markerForFeature=function(b){var c=a.iconForFeature(b),d=a.colorForFeature(b);return L.AwesomeMarkers.icon({icon:c,markerColor:d,prefix:"fa"})},a.stamp=function(){var a=0,b="_knreise_id";return function(c){return c[b]=c[b]||++a,c[b]}}(),a.haversine=function(a,c,d,e){var f=6371e3,g=b(a),h=b(d),i=b(d-a),j=b(e-c),k=Math.sin(i/2)*Math.sin(i/2)+Math.cos(g)*Math.cos(h)*Math.sin(j/2)*Math.sin(j/2),l=2*Math.atan2(Math.sqrt(k),Math.sqrt(1-k));return f*l},a.splitBbox=function(a){return a.split(",").map(parseFloat)},a.featureClick=function(a){return function(b,c,d){c.on("click",function(){d?a.showFeature(b,d.template,d.getFeatureData):a.showFeature(b)})}},a.clusterClick=function(a){return function(b,d){b.on("clusterclick",function(b){var e=_.map(b.layer.getAllChildMarkers(),function(a){var b=a.feature;return b.template=c(b,d),b});a.showFeatures(e)})}},"undefined"!=typeof L&&(L.latLngBounds.fromBBoxString=function(a){return a=KR.Util.splitBbox(a),new L.LatLngBounds(new L.LatLng(a[1],a[0]),new L.LatLng(a[3],a[2]))})}(KR.Util);var KR=this.KR||{};KR.ArcgisAPI=function(a){"use strict";function b(a){return a=KR.Util.splitBbox(a),JSON.stringify({xmin:a[0],ymin:a[1],xmax:a[2],ymax:a[3]})}function c(a,b){a=JSON.parse(a),_.has(a,"error")&&b(KR.Util.CreateFeatureCollection([])),toGeoJSON(a,function(a,c){b(a?KR.Util.CreateFeatureCollection([]):c)})}function d(d,e,f,g){var h={geometry:b(e),geometryType:"esriGeometryEnvelope",inSR:4326,spatialRel:"esriSpatialRelIntersects",outFields:"*",returnGeometry:!0,outSR:4326,returnIdsOnly:!1,returnCountOnly:!1,outStatistics:"",returnZ:!1,returnM:!1,returnDistinctValues:!1,f:"json"};d.query&&(h.where=d.query);var i=d.layer,j=a+i+"/query?"+KR.Util.createQueryParameterString(h);KR.Util.sendRequest(j,null,function(a){c(a,f)},g)}return{getBbox:d}};var KR=this.KR||{};KR.CartodbAPI=function(a,b){"use strict";function c(a){return function(b){var c=_.map(b.rows,function(b){var c=JSON.parse(b.geom),d=_.reduce(b,function(b,c,d){if(_.has(a,d)){var e=a[d];_.isArray(e)?_.each(e,function(a){b[a]=c}):b[e]=c}return b},{});return{type:"Feature",geometry:c,properties:d}});return KR.Util.CreateFeatureCollection(c)}}function d(){return _.reduce(n,function(a,b,d){return a[d]=c(b),a},{cartodb_general:function(a){var b=_.map(a.rows,function(a){var b=JSON.parse(a.geom);return{type:"Feature",geometry:b,properties:_.omit(a,"geom")}});return KR.Util.CreateFeatureCollection(b)}})}function e(a,c,d,e){var f={q:a,api_key:b},g=m+"?"+KR.Util.createQueryParameterString(f);KR.Util.sendRequest(g,c,d,e)}function f(a){var b=a.rows[0].st_extent;return b.replace("BOX(","").replace(")","").replace(/ /g,",")}function g(a,b,c){var d=["SELECT "+a,"FROM "+b];return c&&d.push("WHERE "+c),d.join(" ")}function h(a,b){return"ST_DWithin(the_geom::geography,'POINT("+a.lng+" "+a.lat+")'::geography, "+b+");"}function i(a,b,c){_.isArray(a)||(a=[a]);var d=g("ST_Extent(the_geom)","kommuner","komm in ("+a.join(", ")+")");e(d,f,b,c)}function j(a,b,c){if(a.query)e(a.query,a.mapper,b,c);else if(a.table){var d=["*"];_.has(n,a.table)&&(d=_.keys(n[a.table])),d.push("ST_AsGeoJSON(the_geom) as geom");var f="SELECT "+d.join(", ")+" FROM "+a.table;e(f,a.mapper,b,c)}}function k(a,b,c,f){var h=a.columns;h||(h=["*"]),h.push("ST_AsGeoJSON(the_geom) as geom");var i=g(h.join(", "),a.table,"ST_Intersects(the_geom, ST_MakeEnvelope("+b+", 4326))"),j=a.mapper;j||(j=d().cartodb_general),e(i,j,c,f)}function l(a,b,c,d,f){var i=_.keys(n["default"]).concat(["ST_AsGeoJSON(the_geom) as geom"]).join(", "),j=g(i,a.table,h(b,c));e(j,o,d,f)}var m="http://"+a+".cartodb.com/api/v2/sql",n={"default":{delving_thumbnail:["images","thumbnail"],dc_title:"title",dc_description:"content",europeana_isshownat:"link",europeana_collectiontitle:"dataset",abm_contentProvider:"provider",europeana_type:"contentType",delving_landingpage:"video"},pilegrimsleden_dovre:{iid:"id",name:"name",omradenavn:"omradenavn"}},o=c(n["default"]);return{getBbox:k,getData:j,getWithin:l,getMunicipalityBounds:i,mappers:d}};var KR=this.KR||{};KR.NorvegianaAPI=function(){"use strict";function a(a){return a.lat+","+a.lng}function b(a){return a&&a.length?a[0]:null}function c(a){return a&&-1!==a.indexOf("www.youtube.com/watch")?"https://www.youtube.com/embed/"+a.substr(a.indexOf("watch?v=")+8):a}function d(a){return _.chain(a.item.fields).pairs().where(function(a){return"abm_latLong"!==a[0]}).reduce(function(a,b){return a[b[0]]=b[1],a},{}).value()}function e(a){return{thumbnail:b(a.delving_thumbnail),images:a.delving_thumbnail,title:b(a.dc_title),content:b(a.dc_description),link:b(a.europeana_isShownAt),dataset:b(a.europeana_collectionTitle),provider:b(a.abm_contentProvider),contentType:b(a.europeana_type),video:b(a.abm_videoUri),videoEmbed:c(b(a.abm_videoUri)),sound:b(a.abm_soundUri),allProps:a}}function f(a){var b=d(a),c=e(b),f=_.map(a.item.fields.abm_latLong[0].split(","),parseFloat),g=KR.Util.createGeoJSONFeature({lat:f[0],lng:f[1]},c);return g}function g(a){var b;a.result.pagination.hasNext&&(b=a.result.pagination.nextPage);var c=_.map(a.result.items,f),d=KR.Util.CreateFeatureCollection(c);return d.numFound=a.result.pagination.numFound,{geoJSON:d,nextPage:b}}function h(a,b,c){var d=[];return function e(f){if(d.push(f.geoJSON),f.nextPage)return void KR.Util.sendRequest(a+"&start="+f.nextPage,g,e,c);var h=_.reduce(d,function(a,b){return a.concat(b.features)},[]);b(KR.Util.CreateFeatureCollection(h))}}function i(a){return a=_.isArray(a)?a:[a],_.map(a,function(a){return"delving_spec:"+a}).join(" OR ")}function j(a){q[a]&&(q[a].abort(),q[a]=null)}function k(a,b,c){return KR.Util.sendRequest(a,g,function(a){b(a.geoJSON)},c)}function l(a,b,c){return KR.Util.sendRequest(a,g,h(a,b,c),c)}function m(a,b,c,d,e){var f=i(b.dataset);a=_.extend({query:f,format:"json",rows:1e3},a);var g=f;b.query&&(a.qf=b.query,g+=b.query),j(g);var h=r+"?"+KR.Util.createQueryParameterString(a);e.allPages?q[g]=l(h,c,d):q[g]=k(h,c,d)}function n(b,c,d,e,f){c=KR.Util.splitBbox(c);var g=c[0],h=c[1],i=c[2],j=c[3],k=(g+i)/2,l=(h+j)/2,n=_.max([KR.Util.haversine(j,k,l,k),KR.Util.haversine(l,g,l,k)]),o={pt:a({lat:l,lng:k}),d:n/1e3,geoType:"bbox"};m(o,b,d,e,f)}function o(b,c,d,e,f,g){var h={pt:a(c),d:d/1e3};m(h,b,e,f,g)}function p(a,b){var c={id:a,format:"json"},d=r+"?"+KR.Util.createQueryParameterString(c);KR.Util.sendRequest(d,function(a){return f(a.result)},b)}var q=[],r="http://kulturnett2.delving.org/api/search";return{getWithin:o,getItem:p,getBbox:n}};var KR=this.KR||{};KR.WikipediaAPI=function(){"use strict";function a(a,b){var c=h+"?"+KR.Util.createQueryParameterString(a);KR.Util.sendRequest(c,null,function(a){a=JSON.parse(a),b(a)})}function b(b,c){function d(f){if(_.each(f.query.pages,function(a,b){_.has(e,b)?e[b]=_.extend(e[b],a):e[b]=a}),_.has(f,"continue")){var g={};_.has(f["continue"],"picontinue")&&(g.picontinue=f["continue"].picontinue),_.has(f["continue"],"excontinue")&&(g.excontinue=f["continue"].excontinue);var h=_.extend(g,b);a(h,d)}else c(e)}var e={};a(b,d)}function c(a){var b="http://upload.wikimedia.org/wikipedia/commons/",c=CryptoJS.MD5(a).toString();return b+c.substr(0,1)+"/"+c.substr(0,2)+"/"+a}function d(a,c){var d={action:"query",prop:"extracts|pageimages",exlimit:"max",exintro:"",pilimit:"max",pageids:a,format:"json","continue":""};b(d,c)}function e(a,b){var d,e=b[a.pageid];_.has(e,"thumbnail")&&(d=e.thumbnail.source);var f={thumbnail:d,images:[c(e.pageimage)],title:a.title,content:e.extract,link:"http://no.wikipedia.org/?curid="+a.pageid,dataset:"Wikipedia",provider:"Wikipedia",contentType:"TEXT"};return KR.Util.createGeoJSONFeature({lat:a.lat,lng:a.lon},f)}function f(a,b,c){a=JSON.parse(a);try{var f=_.pluck(a.query.geosearch,"pageid").join("|");d(f,function(c){var d=_.map(a.query.geosearch,function(a){return e(a,c)});b(KR.Util.CreateFeatureCollection(d))})}catch(g){c(a)}}function g(a,b,c,d,e){var g={action:"query",list:"geosearch",gsradius:c,gscoord:b.lat+"|"+b.lng,format:"json",gslimit:50},i=h+"?"+KR.Util.createQueryParameterString(g);KR.Util.sendRequest(i,null,function(a){f(a,d,e)},e)}var h="http://crossorigin.me/https://no.wikipedia.org/w/api.php";return{getWithin:g}};var KR=this.KR||{};KR.API=function(a){"use strict";function b(a,b,c,d,e,f){c=KR.Util.splitBbox(c);var g=c[0],h=c[1],i=c[2],j=c[3],k=(g+i)/2,l=(h+j)/2,m=_.max([KR.Util.haversine(h,g,l,k),KR.Util.haversine(j,i,l,k)]),n={lat:l,lng:k};a.getWithin(b,n,m,d,e,f)}function c(a){var b=l[a];if(b)return b;throw new Error("Unknown API")}function d(a,b,d,e){e=e||{};var f=c(a.api);f.getData(a,b,d,e)}function e(a,d,e,f,g){g=g||{};var h=c(a.api);_.has(h,"getBbox")?h.getBbox(a,d,e,f,g):b(h,a,d,e,f,g)}function f(a,b,d,e,f,g){g=g||{},d=d||5e3;var h=c(a.api);h.getWithin(a,b,d,e,f,g)}function g(a,b,c){if(!k)throw new Error("CartoDB api not configured!");k.getMunicipalityBounds(a,b,c)}var h,i=new KR.NorvegianaAPI;KR.WikipediaAPI&&(h=new KR.WikipediaAPI);var j;KR.ArcgisAPI&&(j=new KR.ArcgisAPI("http://husmann.ra.no/arcgis/rest/services/Husmann/Husmann/MapServer/"));var k;_.has(a,"cartodb")&&(k=new KR.CartodbAPI(a.cartodb.user,a.cartodb.apikey),_.extend(KR.API.mappers,k.mappers()));var l={norvegiana:i,wikipedia:h,cartodb:k,kulturminnedata:j},m={Artsdatabanken:{name:"Artsdatabanken",dataset:{api:"norvegiana",dataset:"Artsdatabanken"}},difo:{name:"Digitalt fortalt",dataset:{api:"norvegiana",dataset:"difo"}},DiMu:{name:"DigitaltMuseum",dataset:{api:"norvegiana",dataset:"DiMu"}},Industrimuseum:{name:"Industrimuseum",dataset:{api:"norvegiana",dataset:"Industrimuseum"}},"Kulturminnesøk":{name:"Kulturminnesøk",dataset:{api:"norvegiana",dataset:"Kulturminnesøk"}},MUSIT:{name:"Universitetsmuseene",dataset:{api:"norvegiana",dataset:"MUSIT"}},Naturbase:{name:"Naturbase",dataset:{api:"norvegiana",dataset:"Naturbase"}},Stedsnavn:{name:"Stedsnavn",dataset:{api:"norvegiana",dataset:"Stedsnavn"}},wikipedia:{name:"Wikipedia",dataset:{api:"wikipedia"}},search_1:{name:"Byantikvaren i Oslo",dataset:{api:"cartodb",table:"search_1"}}};return{getWithin:f,datasets:function(){return _.extend({},m)},getMunicipalityBounds:g,getData:d,getBbox:e,getNorvegianaItem:function(a,b){l.norvegiana.getItem(a,b)}}},KR.API.mappers={};