/*! KNreiseAPI 1.8.7 2016-05-26 */
var KR=this.KR||{};KR.Util={},function(a){"use strict";function b(a){return a*Math.PI/180}a.dictWithout=function(a){var b=_.without(_.keys(a),Array.prototype.slice.call(arguments,1));return _.reduce(b,function(b,c){return b[c]=a[c],b},{})},a.createQueryParameterString=function(a){return _.map(a,function(a,b){return encodeURIComponent(b)+"="+encodeURIComponent(a)}).join("&")},a.handleError=function(a,b,c){if(a)return void a({error:b,data:c});throw new Error(b)},a.sendRequest=function(b,c,d,e,f,g,h){h=h||{},f=f||{};var i={method:g||"get",beforeSend:function(a){_.each(f,function(b,c){a.setRequestHeader(c,b)})},url:b,success:function(b){if(c){var f;try{f=c(b,e)}catch(g){return void a.handleError(e,g.message,b)}_.isUndefined(f)||d(f)}else d(b)},error:e};return $.ajax(_.extend(i,h))},a.createGeoJSONFeature=function(a,b,c){return b=b||{},{type:"Feature",geometry:{type:"Point",coordinates:[a.lng,a.lat]},properties:b,id:c}},a.createGeoJSONFeatureFromGeom=function(a,b,c){return b=b||{},{type:"Feature",geometry:a,properties:b,id:c}},a.createFeatureCollection=function(a){return{type:"FeatureCollection",features:a}},a.stamp=function(){var a=0,b="_knreise_id";return function(c){return c[b]=c[b]||++a,c[b]}}(),a.haversine=function(a,c,d,e){var f=6371e3,g=b(a),h=b(d),i=b(d-a),j=b(e-c),k=Math.sin(i/2)*Math.sin(i/2)+Math.cos(g)*Math.cos(h)*Math.sin(j/2)*Math.sin(j/2),l=2*Math.atan2(Math.sqrt(k),Math.sqrt(1-k));return f*l},a.splitBbox=function(a){return a.split(",").map(parseFloat)},a.addCrossorigin=function(a){return 0!==a.indexOf("http://www.knreise.no/miniProxy/miniProxy.php/")?"http://www.knreise.no/miniProxy/miniProxy.php/"+a:a}}(KR.Util);var KR=this.KR||{};KR.ArcgisAPI=function(a,b){"use strict";function c(a){return a=KR.Util.splitBbox(a),JSON.stringify({xmin:a[0],ymin:a[1],xmax:a[2],ymax:a[3]})}function d(a,b,c){b=JSON.parse(b);var d=b.features,e=_.map(a.features,function(a){var b=_.find(d,function(b){return b.attributes[c.matchId]===a.properties[c.matchId]});b&&(b=b.attributes,a.properties.thumbnail=b.UrlTilBilde);var e=_.extend(a.properties,{extra:b});return KR.Util.createGeoJSONFeatureFromGeom(a.geometry,e,a.id)});return KR.Util.createFeatureCollection(e)}function e(a,b,c,e){var f=_.map(a.features,function(a){return a.properties[b.matchId]}),g={where:b.matchId+" IN ("+f.join(",")+")",outFields:"*",returnGeometry:!1,returnIdsOnly:!1,returnCountOnly:!1,returnZ:!1,returnM:!1,returnDistinctValues:!1,f:"pjson"},i=h+b.extraDataLayer+"/query";$.ajax({type:"POST",url:i,data:KR.Util.createQueryParameterString(g),success:function(e){c(d(a,e,b))},error:function(b){c(a)}})}function f(b,c,d,f){try{b=JSON.parse(b)}catch(g){}return _.has(b,"error")?void KR.Util.handleError(d,b.error.message):void esri2geo.toGeoJSON(b,function(b,g){b?c(KR.Util.createFeatureCollection([])):(_.each(g.features,function(b){_.has(b.properties,"Navn")&&(b.properties.title=b.properties.Navn),b.id=a+"_"+b.properties.OBJECTID}),f.getExtraData?e(g,f,c,d):c(g))})}function g(a,b,d,e){var g={geometry:c(b),geometryType:"esriGeometryEnvelope",inSR:4326,spatialRel:"esriSpatialRelIntersects",outFields:"*",returnGeometry:!0,outSR:4326,returnIdsOnly:!1,returnCountOnly:!1,outStatistics:"",returnZ:!1,returnM:!1,returnDistinctValues:!1,f:"json"};a.query&&(g.where=a.query);var i=a.layer,j=h+i+"/query?"+KR.Util.createQueryParameterString(g);KR.Util.sendRequest(j,null,function(b){f(b,d,e,a)},e)}var h=b.url;return{getBbox:g}};var KR=this.KR||{};KR.CartodbAPI=function(a,b){"use strict";function c(a){return"http://"+a+".cartodb.com/api/v2/sql"}function d(a){return function(b){var c=_.map(b.rows,function(b){var c=JSON.parse(b.geom),d=_.reduce(b,function(b,c,d){if(_.has(a,d)){var e=a[d];_.isArray(e)?_.each(e,function(a){b[a]=c}):b[e]=c}return b},{});return{type:"Feature",geometry:c,properties:d}});return KR.Util.createFeatureCollection(c)}}function e(){return _.reduce(r,function(a,b,c){return a[c]=d(b),a},{cartodb_general:function(a){var b=_.map(a.rows,function(a){var b=JSON.parse(a.geom);return{type:"Feature",geometry:b,properties:_.omit(a,"geom")}});return KR.Util.createFeatureCollection(b)}})}function f(a,b,d,e,f){var g={q:a},h=f||q,i=c(h)+"?"+KR.Util.createQueryParameterString(g);KR.Util.sendRequest(i,b,d,e)}function g(a){var b=a.rows[0].st_extent;return b.replace("BOX(","").replace(")","").replace(/ /g,",")}function h(a,b,c){var d=["SELECT "+a,"FROM "+b];return c&&d.push("WHERE "+c),d.join(" ")}function i(a,b){return"ST_DWithin(the_geom::geography,'POINT("+a.lng+" "+a.lat+")'::geography, "+b+");"}function j(a){var b=a.mapper;return b||(b=e().cartodb_general),b}function k(a){return _.isArray(a)?a:[a]}function l(a,b,c){var d=h("ST_Extent(the_geom)","kommuner","komm in ("+k(a).join(", ")+")");f(d,g,b,c,"knreise")}function m(a,b,c){var d=h("ST_Extent(the_geom)","fylker","fylkesnr in ("+k(a).join(", ")+")");f(d,g,b,c,"knreise")}function n(a,b,c){var d,e=j(a);if(a.query)d=a.query;else if(a.table){var g=a.columns;g||(g=["*"]),_.has(r,a.table)&&(g=_.keys(r[a.table])),g.push("ST_AsGeoJSON(the_geom) as geom"),d="SELECT "+g.join(", ")+" FROM "+a.table}else a.county?d=h("ST_AsGeoJSON(the_geom) as geom","fylker","fylkesnr in ("+k(a.county).join(", ")+")"):a.municipality&&(d=h("ST_AsGeoJSON(the_geom) as geom","kommuner","komm in ("+k(a.municipality).join(", ")+")"));d&&f(d,e,b,c)}function o(a,b,c,d){var e=a.columns;e||(e=["*"]),e.push("ST_AsGeoJSON(the_geom) as geom");var g=h(e.join(", "),a.table,"ST_Intersects(the_geom, ST_MakeEnvelope("+b+", 4326))"),i=j(a);f(g,i,c,d)}function p(a,b,c,d,e){var g=_.keys(r["default"]).concat(["ST_AsGeoJSON(the_geom) as geom"]).join(", "),j=h(g,a.table,i(b,c));f(j,s,d,e)}var q=b.user,r={"default":{delving_thumbnail:["images","thumbnail"],dc_title:"title",dc_description:"content",europeana_isshownat:"link",europeana_collectiontitle:"dataset",abm_contentProvider:"provider",europeana_type:"contentType",delving_landingpage:"video"},pilegrimsleden_dovre:{iid:"id",name:"name",omradenavn:"omradenavn"}},s=d(r["default"]);return{getBbox:o,getData:n,getWithin:p,getMunicipalityBounds:l,getCountyBounds:m,mappers:e}};var KR=this.KR||{};KR.NorvegianaAPI=function(a){"use strict";function b(a){return a.lat+","+a.lng}function c(a){return a&&a.length?a[0]:null}function d(a){return a&&-1!==a.indexOf("www.youtube.com/watch")?"https://www.youtube.com/embed/"+a.substr(a.indexOf("watch?v=")+8):a}function e(a){return _.chain(a.item.fields).pairs().where(function(a){return"abm_latLong"!==a[0]}).reduce(function(a,b){return a[b[0]]=b[1],a},{}).value()}function f(a){var b=75;return a&&a.indexOf("width=")>-1&&a.indexOf("height=")>-1?a.replace(/(width=)(\d+)/g,"$1"+b).replace(/(height=)(\d+)/g,"$1"+b):a}function g(a,b){return _.chain(b).reduce(function(b,c){return _.has(a,c)&&(b=b.concat(a[c])),b},[]).uniq().value()}function h(a){return _.chain(a).map(function(a,b){return _.map(a,function(a){return{type:b,url:a}})}).flatten().value()}function i(a){var b=c(a.delving_thumbnail),e=g(a,["delving_thumbnail","abm_imageUri"]),i={video:_.map(a.abm_videoUri,d),sound:a.abm_soundUri,image:e};return{thumbnail:f(b),images:e,title:c(a.dc_title),content:_.map(a.dc_description,function(a){return"<p>"+a+"</p>"}).join("\n"),link:c(a.europeana_isShownAt),dataset:c(a.europeana_collectionTitle),provider:c(a.abm_contentProvider),contentType:c(a.europeana_type),video:c(a.abm_videoUri),videoEmbed:d(c(a.abm_videoUri)),sound:c(a.abm_soundUri),allProps:a,media:h(i)}}function j(b){var c,d=e(b),f=i(d),g=_.map(b.item.fields.abm_latLong[0].split(","),parseFloat);_.has(d,"delving_hubId")&&(c=a+"_"+d.delving_hubId[0]);var h=KR.Util.createGeoJSONFeature({lat:g[0],lng:g[1]},f,c);return h}function k(a){var b;a.result.pagination.hasNext&&(b=a.result.pagination.nextPage);var c=_.map(a.result.items,j),d=KR.Util.createFeatureCollection(c);return d.numFound=a.result.pagination.numFound,{geoJSON:d,nextPage:b}}function l(a,b,c){var d=[];return function e(f){if(d.push(f.geoJSON),f.nextPage)return void KR.Util.sendRequest(a+"&start="+f.nextPage,k,e,c);var g=_.reduce(d,function(a,b){return a.concat(b.features)},[]);b(KR.Util.createFeatureCollection(g))}}function m(a){return a=_.isArray(a)?a:[a],_.map(a,function(a){return"delving_spec:"+a}).join(" OR ")}function n(a){x[a]&&(x[a].abort(),x[a]=null)}function o(a,b,c){return KR.Util.sendRequest(a,k,function(a){b(a.geoJSON)},c)}function p(a,b,c){return KR.Util.sendRequest(a,k,l(a,b,c),c)}function q(a,b,c,d,e){e=_.extend({checkCancel:!0},e||{});var f=m(b.dataset);a=_.extend({query:f,format:"json",rows:1e3},a),a.query+=" delving_hasGeoHash:true";var g=f;b.query&&(a.qf=b.query,g+=b.query),e.checkCancel&&n(g);var h=y+"?"+KR.Util.createQueryParameterString(a);e.allPages?x[g]=p(h,c,d):x[g]=o(h,c,d)}function r(a,c,d,e,f){c=KR.Util.splitBbox(c);var g=c[0],h=c[1],i=c[2],j=c[3],k=(g+i)/2,l=(h+j)/2,m=_.max([KR.Util.haversine(j,k,l,k),KR.Util.haversine(l,g,l,k)]),n={pt:b({lat:l,lng:k}),d:m/1e3,geoType:"bbox"};q(n,a,d,e,f)}function s(a,c,d,e,f,g){var h={pt:b(c),d:d/1e3};q(h,a,e,f,g)}function t(a,b,c,d){if(a.query&&_.isArray(a.query)){var e="delving_spec:"+a.dataset+" AND ("+a.query.join(" OR ")+") AND delving_hasGeoHash:true",f={query:e,format:"json",rows:1e3},g=e;n(g);var h=y+"?"+KR.Util.createQueryParameterString(f);return void(d.allPages?x[g]=p(h,b,c):x[g]=o(h,b,c))}q({},a,b,c,d)}function u(a,b,c){var d={id:a.id,format:"json"},e=y+"?"+KR.Util.createQueryParameterString(d);KR.Util.sendRequest(e,function(a){return j(a.result)},b,c)}function v(b){var c=_.map(b.geo_json.features,function(b){var c,d=i(b.properties);return _.has(d.allProps,"delving_hubId")&&(c=a+"_"+d.allProps.delving_hubId),b.properties=d,b.id=c,b});return b.geo_json=KR.Util.createFeatureCollection(c),b}function w(a,b,c){var d=z+a;KR.Util.sendRequest(d,v,b,c)}var x=[],y="http://kulturnett2.delving.org/api/search",z="http://acc.norvegiana.delving.org/en/api/knreise-collection/";return{getWithin:s,getItem:u,getBbox:r,getData:t,getCollection:w}};var KR=this.KR||{};KR.WikipediaAPI=function(a,b){"use strict";function c(a,b){var c=n+"?"+KR.Util.createQueryParameterString(a);KR.Util.sendRequest(c,null,function(a){try{a=JSON.parse(a)}catch(c){}b(a)})}function d(a,b){function d(f){if(_.each(f.query.pages,function(a,b){_.has(e,b)?e[b]=_.extend(e[b],a):e[b]=a}),_.has(f,"continue")){var g={};_.has(f["continue"],"picontinue")&&(g.picontinue=f["continue"].picontinue),_.has(f["continue"],"excontinue")&&(g.excontinue=f["continue"].excontinue);var h=_.extend(g,a);c(h,d)}else b(e)}var e={};c(a,d)}function e(a){var b="http://upload.wikimedia.org/wikipedia/commons/",c=CryptoJS.MD5(a).toString();return b+c.substr(0,1)+"/"+c.substr(0,2)+"/"+a}function f(a,b){var c={action:"query",prop:"extracts|pageimages",exlimit:"max",exintro:"",pilimit:"max",pageids:a,format:"json","continue":""};d(c,b)}function g(b,c){c=c||{};var d=c[b.pageid];d&&(b=_.extend(b,d));var f;_.has(b,"thumbnail")&&(f=b.thumbnail.source);var g=null;b.pageimage&&(g=[e(b.pageimage)]);var h=o+b.pageid,i={thumbnail:f,images:g,title:b.title,content:b.extract,link:h,dataset:"Wikipedia",provider:"Wikipedia",contentType:"TEXT",id:b.pageid};return KR.Util.createGeoJSONFeature({lat:b.lat,lng:b.lon},i,a+"_"+b.pageid)}function h(a,b,c){try{a=JSON.parse(a)}catch(d){}try{var e=_.pluck(a.query.geosearch,"pageid");e.length?f(e.join("|"),function(c){var d=_.map(a.query.geosearch,function(a){return g(a,c)});b(KR.Util.createFeatureCollection(d))}):b(KR.Util.createFeatureCollection([]))}catch(h){KR.Util.handleError(c,a.error.info)}}function i(a,b,c,d,e){if(c>m)return void KR.Util.handleError(e,"to wide search radius (max is "+m+")");var f={action:"query",list:"geosearch",gsradius:c,gscoord:b.lat+"|"+b.lng,format:"json",gslimit:50},g=n+"?"+KR.Util.createQueryParameterString(f);KR.Util.sendRequest(g,null,function(a){h(a,d,e)},e)}function j(a){var b=_.chain(a).reduce(function(a,b){return _.each(b,function(b,c){_.has(a,c)?a[c]=_.extend(a[c],b):a[c]=b}),a},{}).filter(function(a){return _.has(a,"coordinates")}).map(function(a){return a.lat=a.coordinates[0].lat,a.lon=a.coordinates[0].lon,a}).map(g).value();return KR.Util.createFeatureCollection(b)}function k(a,b,c,d){function e(a){var d=_.extend({},f,a),h=n+"?"+KR.Util.createQueryParameterString(d);KR.Util.sendRequest(h,null,function(a){g.push(a.query.pages),_.has(a,"continue")?e(a["continue"]):b(j(g))},c)}var f={action:"query",generator:"categorymembers",gcmtitle:"Kategori:"+a.category,prop:"coordinates",format:"json"},g=[];e({"continue":""})}function l(a,b,c){var d={action:"query",pageids:a.id,prop:"coordinates|pageimages|extracts",format:"json"},e=n+"?"+KR.Util.createQueryParameterString(d);KR.Util.sendRequest(e,function(b){return g(b.query.pages[a.id])},b,c)}var m=b.maxRadius||1e4,n=b.url,o=b.linkBase;return{getWithin:i,getData:k,getItem:l}};var KR=this.KR||{};KR.UtnoAPI=function(a){"use strict";function b(a,b,c){if("undefined"==typeof toGeoJSON)throw new Error("toGeoJSON not found!");if("gpx"===a.type){var d="http://ut.no/tur/"+a.id+"/gpx/";KR.Util.sendRequest(d,toGeoJSON.gpx,b,c)}else KR.Util.handleError(c,"Unknown type "+a.type)}return{getData:b}};var KR=this.KR||{};KR.FolketellingAPI=function(a){"use strict";function b(b){var c=_.map(b.results,function(b){var c=KR.Util.dictWithout(b,"latitude","longitude"),d={lat:parseFloat(b.latitude),lng:parseFloat(b.longitude)};return KR.Util.createGeoJSONFeature(d,c,a+"_"+b.autoid)});return KR.Util.createFeatureCollection(c)}function c(a,c,d,e,f,i){var j=a.limit||1e3;if("property"!==a.dataset)return void KR.Util.handleError(f,"unknown dataset "+a.dataset);if(d>h)return void KR.Util.handleError(f,"to wide search radius");var k={latitude:c.lat,longitude:c.lng,precision:d,limit:j},l=g+"search_property_geo?"+KR.Util.createQueryParameterString(k);KR.Util.sendRequest(l,b,e,f)}function d(a,b,c){if(0===a.property.id.indexOf("gf")){if(!a.apartments)return a.apartments=null,void b({properties:a});var d=[],e=_.after(a.apartments.length,function(){a.apartments=d,b({properties:a})});return void _.each(a.apartments,function(a){f({type:"apartmentData",apartmentId:a.id},function(a){d.push(a),e()})})}b({properties:a})}function e(a){return a.apartments||(a.apartments=null),{properties:a}}function f(a,b,c,f){var h;"propertyData"===a.type&&a.propertyId?(h=g+"property/"+a.propertyId,a.withPersons?KR.Util.sendRequest(h,null,function(a){d(a,b,c)},c):KR.Util.sendRequest(h,e,b,c)):"apartmentData"===a.type&&a.apartmentId?(h=g+"property/"+a.apartmentId,KR.Util.sendRequest(h,null,b,c)):KR.Util.handleError(c,"Not enough parameters")}var g="http://api.digitalarkivet.arkivverket.no/v1/census/1910/",h=5e3;return{getData:f,getWithin:c}};var KR=this.KR||{};KR.SparqlAPI=function(a,b){"use strict";function c(a){if(_.isUndefined(window.proj4))throw new Error("Proj4js not found!");return proj4("EPSG:32633","EPSG:4326",a)}function d(a){return a=wellknown.parse(a.value),"Point"===a.type&&(a.coordinates=c(a.coordinates)),"Polygon"===a.type&&(a.coordinates=_.map(a.coordinates,function(a){return _.map(a,c)})),"MultiPolygon"===a.type&&(a.coordinates=_.map(a.coordinates,function(a){return _.map(a.coordinates,function(a){return _.map(a,c)})})),a}function e(b,c){var e=_.chain(b.results.bindings).map(function(b){var c=_.without(_.keys(b),"point","omraade"),e=_.reduce(c,function(a,c){return a[c]=b[c].value,a},{});return e.img||(e.img=!1),e.title=e.name,e.license||(e.license=t),_.has(b,"point")?KR.Util.createGeoJSONFeatureFromGeom(d(b.point),e,a+"_"+e.id):_.has(b,"omraade")?KR.Util.createGeoJSONFeatureFromGeom(d(b.omraade),e,a+"_"+e.id):null}).filter(function(a){return!!a}).value();return KR.Util.createFeatureCollection(e)}function f(a,b,c,d){var e={"default-graph-uri":"",query:a,format:"application/sparql-results+json",timeout:0,debug:"off"},f=u,g=new FormData;_.each(e,function(a,b){g.append(b,a)});var h={data:g,processData:!1,contentType:!1,cache:!1,method:"POST"};KR.Util.sendRequest(f,b,c,d,{},"POST",h)}function g(a){if(a.kommune){var b="select distinct ?id ?name ?description ?loccatlabel ?locartlabel ?orglabel ?img ?thumbnail (SAMPLE(?point) as ?point) ?url as ?link ?picture ?picturelabel ?picturedescription ?picturelicence {  ?id a ?type ;  rdfs:label ?name ;  <https://data.kulturminne.no/askeladden/schema/lokalitetskategori> ?loccat ;  <https://data.kulturminne.no/askeladden/schema/lokalitetsart> ?locart ;  <https://data.kulturminne.no/askeladden/schema/ansvarligorganisasjon> ?org ;  ?p <https://data.kulturminne.no/askeladden/kommune/"+a.kommune+'> ;  <https://data.kulturminne.no/askeladden/schema/geo/point/etrs89> ?point .  optional { ?loccat rdfs:label ?loccatlabel .}  optional { ?locart rdfs:label ?locartlabel .}  optional { ?org rdfs:label ?orglabel .}  optional { ?id <https://data.kulturminne.no/askeladden/schema/beskrivelse> ?description .}  BIND(REPLACE(STR(?id), "https://data.kulturminne.no/askeladden/lokalitet/", "") AS ?lokid)  BIND(bif:concat("http://www.kulturminnesok.no/kulturminnesok/kulturminne/?LOK_ID=", ?lokid) AS ?url)  optional {  {select sample(?picture) as ?picture ?id where {?picture <https://data.kulturminne.no/bildearkivet/schema/lokalitet> ?id}}   ?picture <https://data.kulturminne.no/bildearkivet/schema/lokalitet> ?id .   ?picture <https://data.kulturminne.no/schema/source-link> ?link .   ?picture rdfs:label ?picturelabel .   ?picture dc:description ?picturedescription .   ?picture <https://data.kulturminne.no/bildearkivet/schema/license> ?picturelicence .   BIND(REPLACE(STR(?link), "http://kulturminnebilder.ra.no/fotoweb/default.fwx\\\\?search\\\\=", "") AS ?linkid)   BIND(bif:concat("http://kulturminnebilder.ra.no/fotoweb/cmdrequest/rest/PreviewAgent.fwx?ar=5001&sz=600&rs=0&pg=0&sr=", ?linkid) AS ?img)   BIND(bif:concat("http://kulturminnebilder.ra.no/fotoweb/cmdrequest/rest/PreviewAgent.fwx?ar=5001&sz=75&rs=0&pg=0&sr=", ?linkid) AS ?thumbnail) } ';return a.filter&&(b+=" "+a.filter),b+="}",a.limit&&(b+="LIMIT "+a.limit),b}}function h(a){if(a.fylke){var b=parseInt(a.fylke,10);10>b&&(b="0"+b);var c=' select distinct ?id ?name ?description ?loccatlabel ?locartlabel ?orglabel ?img ?thumbnail (SAMPLE(?point) as ?point) ?url as ?link ?picture ?picturelabel ?picturedescription ?picturelicence {  ?id a ?type ;  rdfs:label ?name ;  <https://data.kulturminne.no/askeladden/schema/lokalitetskategori> ?loccat ;  <https://data.kulturminne.no/askeladden/schema/lokalitetsart> ?locart ;  <https://data.kulturminne.no/askeladden/schema/ansvarligorganisasjon> ?org ;  <https://data.kulturminne.no/askeladden/schema/kommune> ?kommune ;  <https://data.kulturminne.no/askeladden/schema/geo/point/etrs89> ?point .  optional { ?loccat rdfs:label ?loccatlabel .}  optional { ?locart rdfs:label ?locartlabel .}  optional { ?org rdfs:label ?orglabel .}  optional { ?id <https://data.kulturminne.no/askeladden/schema/beskrivelse> ?description .}  BIND(REPLACE(STR(?id), "https://data.kulturminne.no/askeladden/lokalitet/", "") AS ?lokid)  BIND(bif:concat("http://www.kulturminnesok.no/kulturminnesok/kulturminne/?LOK_ID=", ?lokid) AS ?url)  optional {  {select sample(?picture) as ?picture ?id where {?picture <https://data.kulturminne.no/bildearkivet/schema/lokalitet> ?id}}   ?picture <https://data.kulturminne.no/bildearkivet/schema/lokalitet> ?id .   ?picture <https://data.kulturminne.no/schema/source-link> ?link .   ?picture rdfs:label ?picturelabel .   ?picture dc:description ?picturedescription .   ?picture <https://data.kulturminne.no/bildearkivet/schema/license> ?picturelicence .   BIND(REPLACE(STR(?id), "https://data.kulturminne.no/askeladden/lokalitet/", "") AS ?lokid)   BIND(bif:concat("http://kulturminnebilder.ra.no/fotoweb/cmdrequest/rest/PreviewAgent.fwx?ar=5001&sz=600&rs=0&pg=0&sr=", ?lokid) AS ?img)   BIND(bif:concat("http://kulturminnebilder.ra.no/fotoweb/cmdrequest/rest/PreviewAgent.fwx?ar=5001&sz=75&rs=0&pg=0&sr=", ?lokid) AS ?thumbnail)  }  FILTER regex(?kommune, "^.*'+b+'[1-9]{2}") . ';return a.filter&&(c+=" "+a.filter),c+=" } order by ?img",a.limit&&(c+="LIMIT "+a.limit),c}}function i(a){return"SELECT ?enk as ?id ?name ?desc as ?content ?area as ?omraade ?enkcatlabel where { ?enk a <https://data.kulturminne.no/askeladden/schema/Enkeltminne> . ?enk rdfs:label ?name . ?enk <https://data.kulturminne.no/askeladden/schema/lokalitet> <"+a.trim()+"> . ?enk <https://data.kulturminne.no/askeladden/schema/ksok> ?desc . ?enk <https://data.kulturminne.no/askeladden/schema/geo/area/etrs89> ?area . ?enk <https://data.kulturminne.no/askeladden/schema/enkeltminnekategori> ?enkcat . ?enkcat rdfs:label ?enkcatlabel . } "}function j(a,b){return a.slice(0,b.length)===b}function k(a,b){return""===b||a.slice(-b.length)===b}function l(a){return j(a,"<")||(a="<"+a),k(a,">")||(a+=">"),a}function m(a,b){var c=_.map(a,function(a){return a.poly.type="Polygon",KR.Util.createGeoJSONFeatureFromGeom(d(a.poly),{})}),e=_.map(c,function(a){return a.geometry}),f={type:"GeometryCollection",geometries:e};return KR.Util.createGeoJSONFeatureFromGeom(f,{lok:b})}function n(a){var b=_.reduce(a.results.bindings,function(a,b){var c=b.lok.value;return _.has(a,c)||(a[c]=[]),a[c].push(b),a},{});return _.map(b,m)}function o(a,b,c){var d=[];_.isArray(a.lokalitet)?d=a.lokalitet:d.push(a.lokalitet);var e="select ?lok ?poly where {  ?lok <https://data.kulturminne.no/askeladden/schema/geo/area/etrs89> ?poly  filter (?lok in ("+_.map(d,l).join(", ")+"))}";f(e,n,function(a){b(KR.Util.createFeatureCollection(a))},c)}function p(a,b,c){var d=[];_.isArray(a.lokalitet)?d=a.lokalitet:d.push(a.lokalitet);var g=[],h=_.after(d.length,function(){b(KR.Util.createFeatureCollection(g))});_.each(d,function(a){f(i(a),e,function(b){var c=_.map(b.features,function(b){return b.properties.lokalitet=a,b});g=g.concat(c),h()},c)})}function q(a){return _.map(a.results.bindings,function(a){return _.reduce(a,function(a,b,c){return a[c]=b.value,a})})}function r(a,b,c){var d=d=a.lokalitet,e='select distinct ?id ?img ?img_fullsize ?url ?link ?linkid ?picturelabel ?picturedescription ?picturelicence {?id a ?type . BIND(REPLACE(STR(?id), "https://data.kulturminne.no/askeladden/lokalitet/", "") AS ?lokid) BIND(bif:concat("http://www.kulturminnesok.no/kulturminnesok/kulturminne/?LOK_ID=", ?lokid) AS ?url) ?picture <https://data.kulturminne.no/bildearkivet/schema/lokalitet> ?id . ?picture <https://data.kulturminne.no/schema/source-link> ?link . ?picture rdfs:label ?picturelabel . optional {?picture dc:description ?picturedescription .}?picture <https://data.kulturminne.no/bildearkivet/schema/license> ?picturelicence . BIND(REPLACE(STR(?link), "http://kulturminnebilder.ra.no/fotoweb/default.fwx\\\\?search\\\\=", "") AS ?linkid) . BIND(bif:concat("http://kulturminnebilder.ra.no/fotoweb/cmdrequest/rest/PreviewAgent.fwx?ar=5001&sz=600&rs=0&pg=0&sr=", ?linkid) AS ?img) . BIND(bif:concat("http://kulturminnebilder.ra.no/fotoweb/cmdrequest/rest/PreviewAgent.fwx?ar=5001&sz=1000&rs=0&pg=0&sr=", ?linkid) AS ?img_fullsize) . filter(?id='+l(d)+") } ";f(e,q,b,c)}function s(a,b,c,d){if(a=_.extend({},{geomType:"point"},a),a.kommune){var i=g(a,c);f(i,e,b,c)}else if(a.fylke){var i=h(a,c);f(i,e,b,c)}else a.lokalitet&&"lokalitetpoly"===a.type?o(a,b,c):a.lokalitet&&"enkeltminner"===a.type?p(a,b,c):a.lokalitet&&"images"===a.type?r(a,b,c):a.sparqlQuery?f(a.sparqlQuery,e,b,c):KR.Util.handleError(c,"not enough parameters")}var t=b.licenseText||"http://data.norge.no/nlod/no",u=b.url;return _.isUndefined(window.proj4)||proj4.defs([["EPSG:32633","+proj=utm +zone=33 +datum=WGS84 +units=m +no_defs"]]),{getData:s}};var KR=this.KR||{};KR.FlickrAPI=function(a,b){"use strict";function c(a,b){return l(_.extend({size:b},a))}function d(b,d){if(b.stat&&"fail"===b.stat)return void KR.Util.handleError(d,b.message,b);var e=_.chain(b.photos.photo).filter(function(a){var b=parseFloat(a.latitude),c=parseFloat(a.longitude);return 0!=b||0!=c}).map(function(b){var d=KR.Util.dictWithout(b,"latitude","longitude");return d.thumbnail=c(b,"s"),d.image=c(b,"z"),KR.Util.createGeoJSONFeature({lat:parseFloat(b.latitude),lng:parseFloat(b.longitude)},d,a+"_"+b.id)}).value();return KR.Util.createFeatureCollection(e)}function e(a,b,c){function e(e){var h=d(e,c);if(h&&h.features&&(g=g.concat(h.features)),e.photos&&e.photos.page<e.photos.pages)a.page=e.photos.page+1,f(a);else{var h=KR.Util.createFeatureCollection(g);b(h)}}function f(a){var b=j+"?"+KR.Util.createQueryParameterString(a);KR.Util.sendRequest(b,e)}var g=[];f(a)}function f(a,b,c,d,f){return _.has(a,"user_id")||_.has(a,"group_id")?(_.has(a,"user_id")&&(b=_.extend(b,{method:"flickr.photos.search",user_id:a.user_id})),_.has(a,"group_id")&&(b=_.extend(b,{method:"flickr.groups.pools.getPhotos",group_id:a.group_id})),b=_.extend(b,{api_key:k,has_geo:!0,per_page:500,extras:"geo,tags",format:"json",nojsoncallback:1,accuracy:a.accuracy||11}),_.has(a,"tags")&&(b.tags=a.tags.join(","),b.tag_mode=a.tag_mode||"all"),void e(b,c,d)):void KR.Util.handleError(d,"must specify user_id or group_id")}function g(a,b,c,d,e,g){var h={lat:b.lat,lon:b.lng,radius:c/1e3};f(a,h,d,e,g)}function h(a,c,d,e){var g={bbox:c};f(a,g,d,e,b)}function i(a,c,d){f(a,{},c,d,b)}var j="https://api.flickr.com/services/rest/",k=b.apikey,l=_.template("https://farm<%= farm %>.staticflickr.com/<%= server %>/<%= id %>_<%= secret %>_<%= size %>.jpg");return{getData:i,getWithin:g,getBbox:h}};var KR=this.KR||{};KR.KmlAPI=function(a){"use strict";function b(a,b,c){if("undefined"==typeof toGeoJSON)throw new Error("toGeoJSON not found!");var d=KR.Util.addCrossorigin(a.url);KR.Util.sendRequest(d,toGeoJSON.kml,b,c)}return{getData:b}};var KR=this.KR||{};KR.GpxAPI=function(a){"use strict";function b(a,b,c){if("undefined"==typeof toGeoJSON)throw new Error("toGeoJSON not found!");var d=KR.Util.addCrossorigin(a.url);KR.Util.sendRequest(d,toGeoJSON.gpx,b,c)}return{getData:b}};var KR=this.KR||{};KR.GeoJsonAPI=function(a){"use strict";function b(a,b,c){var d=KR.Util.addCrossorigin(a.url);KR.Util.sendRequest(d,JSON.parse,b,c)}return{getData:b}};var KR=this.KR||{};KR.JernbanemuseetAPI=function(a,b){"use strict";function c(a){return _.has(a,"group")?a.group:l}function d(){return{"api-key":o}}function e(b){var c=_.map(b.data.records,function(b){var c,d=_.extend(b.contents[m],{id:b.record_id});return _.has(b,"latitude")&&_.has(b,"longitude")?c={lat:b.latitude,lng:b.longitude}:_.has(b,"location")?c={lat:b.location.latitude,lng:b.location.longitude}:console.error("no geometry"),KR.Util.createGeoJSONFeature(c,d,a+"_"+b.record_id)});return KR.Util.createFeatureCollection(c)}function f(a){return _.map(a.blocks,function(a){if("text"===a.type)return{text:a.data,type:a.type};if("image_video"===a.type||"audio"===a.type){var b=_.map(a.data,function(a){var b;"image"===a.type&&(b=a.url),"video"===a.type&&(b=a.url.mp4),"audio"===a.type&&(b=a.url.ogg);var c="",d="";return _.has(a.contents,m)&&(c=a.contents[m].description,d=a.contents[m].title),{title:d,description:c,type:a.type,url:b}});return{media:b,type:a.type}}return"links"===a.type?{links:a.data,type:"links"}:void 0})}function g(b){var c,d,e=b.data.contents[m],g={lat:b.data.location.latitude,lng:b.data.location.longitude},h=b.data.id,i=_.map(e.pages,function(a){return{title:a.title,blocks:f(a)}});b.data.images.length&&(c=_.pluck(b.data.images,"url"),d=b.data.images[0].thumbnail);var j={license:b.data.license.description,id:h,thumbnail:d,images:c,title:e.title,description:e.description,pages:i};return KR.Util.createGeoJSONFeature(g,j,a+"_"+h)}function h(a,b,e){var f=n+"/groups/"+c(a)+"/records/"+a.id+"?strip_html=true";KR.Util.sendRequest(f,g,b,e,d())}function i(a,b,c){var d=e(a),f=[],g=_.after(d.features.length,function(){b(KR.Util.createFeatureCollection(f))});_.each(d.features,function(a){h(a.properties.id,function(a){f.push(a),g()},function(){g()})})}function j(a,b,f,g,h,j){var k={lat:b.lat,"long":b.lng,radius:f},l=n+"/groups/"+c(a)+"/nearby?"+KR.Util.createQueryParameterString(k);j.getDetails?KR.Util.sendRequest(l,null,function(a){i(a,g,h)},null,d()):KR.Util.sendRequest(l,e,g,h,d())}function k(a,b,f,g){var h=n+"/groups/"+c(a)+"/geography";g.getDetails?KR.Util.sendRequest(h,null,function(a){i(a,b,f)},null,d()):(a.presentation&&(h="https://api.kulturpunkt.org/v2/owners/54/presentations/"+a.presentation),KR.Util.sendRequest(h,e,b,f,d()))}var l=192,m=b.lang||"no",n="https://api.kulturpunkt.org/v2/owners/54",o=b.apikey;return{getData:k,getWithin:j,getItem:h}};var KR=this.KR||{};KR.API=function(a){"use strict";function b(){return _.reduce(k,function(b,c,d){var e=c.params;return c.extend&&(e=_.extend(e,a[d])),b[d]=new c.api(d,e),b},{})}function c(a,b,c,d,e,f){c=KR.Util.splitBbox(c);var g=c[0],h=c[1],i=c[2],j=c[3],k=(g+i)/2,l=(h+j)/2,m=_.max([KR.Util.haversine(h,g,l,k),KR.Util.haversine(j,i,l,k)]),n={lat:l,lng:k};a.getWithin(b,n,m,d,e,f)}function d(a){var b=l[a];if(b)return b;throw new Error("Unknown API")}function e(a,b,c,e){e=e||{};var f=d(a.api);f.getData(a,b,c,e)}function f(a,b,e,f,g){g=g||{};var h=d(a.api);_.has(h,"getBbox")?h.getBbox(a,b,e,f,g):c(h,a,b,e,f,g)}function g(a,b,c,e,f,g){g=g||{},c=c||5e3;var h=d(a.api);h.getWithin(a,b,c,e,f,g)}function h(a,b,c){var e=d("cartodb");if(!e)throw new Error("CartoDB api not configured!");e.getMunicipalityBounds(a,b,c)}function i(a,b,c){var e=d("cartodb");if(!e)throw new Error("CartoDB api not configured!");e.getCountyBounds(a,b,c)}function j(a,b,c){var e=d(a.api);if(_.has(e,"getItem"))e.getItem(a,b,c);else{if(!c)throw new Error("No getItem function for api "+a.api);c("No getItem function for api "+a.api)}}a=a||{};var k={norvegiana:{api:KR.NorvegianaAPI,params:{}},wikipedia:{api:KR.WikipediaAPI,params:{url:"http://www.knreise.no/miniProxy/miniProxy.php/https://no.wikipedia.org/w/api.php",linkBase:"http://no.wikipedia.org/?curid="}},wikipediaNN:{api:KR.WikipediaAPI,params:{url:"http://www.knreise.no/miniProxy/miniProxy.php/https://nn.wikipedia.org/w/api.php",linkBase:"http://nn.wikipedia.org/?curid="}},cartodb:{api:KR.CartodbAPI,extend:!0,params:{user:"knreise"}},kulturminnedata:{api:KR.ArcgisAPI,params:{url:"http://husmann.ra.no/arcgis/rest/services/Husmann/Husmann/MapServer/"}},kulturminnedataSparql:{api:KR.SparqlAPI,params:{url:"https://sparql.kulturminne.no/"}},utno:{api:KR.UtnoAPI,params:{}},folketelling:{api:KR.FolketellingAPI,params:{}},flickr:{api:KR.FlickrAPI,extend:!0,params:{}},kml:{api:KR.KmlAPI,params:{}},gpx:{api:KR.GpxAPI,params:{}},geojson:{api:KR.GeoJsonAPI,params:{}},lokalhistoriewiki:{api:KR.WikipediaAPI,params:{url:"http://www.knreise.no/miniProxy/miniProxy.php/http://test.lokalhistoriewiki.no:8080/api.php",linkBase:"http://lokalhistoriewiki.no/?curid=",maxRadius:1e5}},jernbanemuseet:{api:KR.JernbanemuseetAPI,extend:!0,params:{lang:"no"}}},l=b();return{getData:e,getWithin:g,getBbox:f,getMunicipalityBounds:h,getCountyBounds:i,getItem:j,getCollection:function(a,b,c){var e=d("norvegiana");e.getCollection(a,b,c)},addApi:function(a,c,d){if(_.has(k,a))throw new Error("API with name "+a+" already exists");d=d||{},k[a]={api:c,params:d},l=b()}}},KR.API.mappers={};