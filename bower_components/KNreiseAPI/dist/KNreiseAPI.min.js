/*! KNreiseAPI 1.6.1 2015-08-13 */
var KR=this.KR||{};KR.Util={},function(a){"use strict";function b(a){return a*Math.PI/180}a.dictWithout=function(a){var b=_.without(_.keys(a),Array.prototype.slice.call(arguments,1));return _.reduce(b,function(b,c){return b[c]=a[c],b},{})},a.createQueryParameterString=function(a){return _.map(a,function(a,b){return encodeURIComponent(b)+"="+encodeURIComponent(a)}).join("&")},a.handleError=function(a,b,c){if(a)return void a({error:b,data:c});throw new Error(b)},a.sendRequest=function(b,c,d,e,f){return f=f||{},$.ajax({type:"get",beforeSend:function(a){_.each(f,function(b,c){a.setRequestHeader(c,b)})},url:b,success:function(b){if(c){var f;try{f=c(b,e)}catch(g){return void a.handleError(e,g.message,b)}_.isUndefined(f)||d(f)}else d(b)},error:e})},a.createGeoJSONFeature=function(a,b,c){return b=b||{},{type:"Feature",geometry:{type:"Point",coordinates:[a.lng,a.lat]},properties:b,id:c}},a.createGeoJSONFeatureFromGeom=function(a,b,c){return b=b||{},{type:"Feature",geometry:a,properties:b,id:c}},a.createFeatureCollection=function(a){return{type:"FeatureCollection",features:a}},a.stamp=function(){var a=0,b="_knreise_id";return function(c){return c[b]=c[b]||++a,c[b]}}(),a.haversine=function(a,c,d,e){var f=6371e3,g=b(a),h=b(d),i=b(d-a),j=b(e-c),k=Math.sin(i/2)*Math.sin(i/2)+Math.cos(g)*Math.cos(h)*Math.sin(j/2)*Math.sin(j/2),l=2*Math.atan2(Math.sqrt(k),Math.sqrt(1-k));return f*l},a.splitBbox=function(a){return a.split(",").map(parseFloat)}}(KR.Util);var KR=this.KR||{};KR.ArcgisAPI=function(a,b){"use strict";function c(a){return a=KR.Util.splitBbox(a),JSON.stringify({xmin:a[0],ymin:a[1],xmax:a[2],ymax:a[3]})}function d(a,b,c){return a=JSON.parse(a),_.has(a,"error")?void KR.Util.handleError(c,a.error.message):void esri2geo.toGeoJSON(a,function(a,c){b(a?KR.Util.createFeatureCollection([]):c)})}function e(b,e,f,g){var h={geometry:c(e),geometryType:"esriGeometryEnvelope",inSR:4326,spatialRel:"esriSpatialRelIntersects",outFields:"*",returnGeometry:!0,outSR:4326,returnIdsOnly:!1,returnCountOnly:!1,outStatistics:"",returnZ:!1,returnM:!1,returnDistinctValues:!1,f:"json"};b.query&&(h.where=b.query);var i=b.layer,j=a+i+"/query?"+KR.Util.createQueryParameterString(h);KR.Util.sendRequest(j,null,function(a){d(a,f,g)},g)}return{getBbox:e}};var KR=this.KR||{};KR.CartodbAPI=function(a,b){"use strict";function c(a){return function(b){var c=_.map(b.rows,function(b){var c=JSON.parse(b.geom),d=_.reduce(b,function(b,c,d){if(_.has(a,d)){var e=a[d];_.isArray(e)?_.each(e,function(a){b[a]=c}):b[e]=c}return b},{});return{type:"Feature",geometry:c,properties:d}});return KR.Util.createFeatureCollection(c)}}function d(){return _.reduce(q,function(a,b,d){return a[d]=c(b),a},{cartodb_general:function(a){var b=_.map(a.rows,function(a){var b=JSON.parse(a.geom);return{type:"Feature",geometry:b,properties:_.omit(a,"geom")}});return KR.Util.createFeatureCollection(b)}})}function e(a,b,c,d){var e={q:a},f=p+"?"+KR.Util.createQueryParameterString(e);KR.Util.sendRequest(f,b,c,d)}function f(a){var b=a.rows[0].st_extent;return b.replace("BOX(","").replace(")","").replace(/ /g,",")}function g(a,b,c){var d=["SELECT "+a,"FROM "+b];return c&&d.push("WHERE "+c),d.join(" ")}function h(a,b){return"ST_DWithin(the_geom::geography,'POINT("+a.lng+" "+a.lat+")'::geography, "+b+");"}function i(a){var b=a.mapper;return b||(b=d().cartodb_general),b}function j(a){return _.isArray(a)?a:[a]}function k(a,b,c){var d=g("ST_Extent(the_geom)","kommuner","komm in ("+j(a).join(", ")+")");e(d,f,b,c)}function l(a,b,c){var d=g("ST_Extent(the_geom)","fylker","fylkesnr in ("+j(a).join(", ")+")");e(d,f,b,c)}function m(a,b,c){var d,f=i(a);if(a.query)d=a.query;else if(a.table){var h=["*"];_.has(q,a.table)&&(h=_.keys(q[a.table])),h.push("ST_AsGeoJSON(the_geom) as geom"),d="SELECT "+h.join(", ")+" FROM "+a.table}else a.county?d=g("ST_AsGeoJSON(the_geom) as geom","fylker","fylkesnr in ("+j(a.county).join(", ")+")"):a.municipality&&(d=g("ST_AsGeoJSON(the_geom) as geom","kommuner","komm in ("+j(a.municipality).join(", ")+")"));d&&e(d,f,b,c)}function n(a,b,c,d){var f=a.columns;f||(f=["*"]),f.push("ST_AsGeoJSON(the_geom) as geom");var h=g(f.join(", "),a.table,"ST_Intersects(the_geom, ST_MakeEnvelope("+b+", 4326))"),j=i(a);e(h,j,c,d)}function o(a,b,c,d,f){var i=_.keys(q["default"]).concat(["ST_AsGeoJSON(the_geom) as geom"]).join(", "),j=g(i,a.table,h(b,c));e(j,r,d,f)}var p="http://"+a+".cartodb.com/api/v2/sql",q={"default":{delving_thumbnail:["images","thumbnail"],dc_title:"title",dc_description:"content",europeana_isshownat:"link",europeana_collectiontitle:"dataset",abm_contentProvider:"provider",europeana_type:"contentType",delving_landingpage:"video"},pilegrimsleden_dovre:{iid:"id",name:"name",omradenavn:"omradenavn"}},r=c(q["default"]);return{getBbox:n,getData:m,getWithin:o,getMunicipalityBounds:k,getCountyBounds:l,mappers:d}};var KR=this.KR||{};KR.NorvegianaAPI=function(a){"use strict";function b(a){return a.lat+","+a.lng}function c(a){return a&&a.length?a[0]:null}function d(a){return a&&-1!==a.indexOf("www.youtube.com/watch")?"https://www.youtube.com/embed/"+a.substr(a.indexOf("watch?v=")+8):a}function e(a){return _.chain(a.item.fields).pairs().where(function(a){return"abm_latLong"!==a[0]}).reduce(function(a,b){return a[b[0]]=b[1],a},{}).value()}function f(a){var b=75;return a&&a.indexOf("width=")>-1&&a.indexOf("height=")>-1?a.replace(/(width=)(\d+)/g,"$1"+b).replace(/(height=)(\d+)/g,"$1"+b):a}function g(a){var b=c(a.delving_thumbnail);return{thumbnail:f(b),images:a.delving_thumbnail,title:c(a.dc_title),content:c(a.dc_description),link:c(a.europeana_isShownAt),dataset:c(a.europeana_collectionTitle),provider:c(a.abm_contentProvider),contentType:c(a.europeana_type),video:c(a.abm_videoUri),videoEmbed:d(c(a.abm_videoUri)),sound:c(a.abm_soundUri),allProps:a}}function h(b){var c,d=e(b),f=g(d),h=_.map(b.item.fields.abm_latLong[0].split(","),parseFloat);_.has(d,"delving_hubId")&&(c=a+"_"+d.delving_hubId[0]);var i=KR.Util.createGeoJSONFeature({lat:h[0],lng:h[1]},f,c);return i}function i(a){var b;a.result.pagination.hasNext&&(b=a.result.pagination.nextPage);var c=_.map(a.result.items,h),d=KR.Util.createFeatureCollection(c);return d.numFound=a.result.pagination.numFound,{geoJSON:d,nextPage:b}}function j(a,b,c){var d=[];return function e(f){if(d.push(f.geoJSON),f.nextPage)return void KR.Util.sendRequest(a+"&start="+f.nextPage,i,e,c);var g=_.reduce(d,function(a,b){return a.concat(b.features)},[]);b(KR.Util.createFeatureCollection(g))}}function k(a){return a=_.isArray(a)?a:[a],_.map(a,function(a){return"delving_spec:"+a}).join(" OR ")}function l(a){t[a]&&(t[a].abort(),t[a]=null)}function m(a,b,c){return KR.Util.sendRequest(a,i,function(a){b(a.geoJSON)},c)}function n(a,b,c){return KR.Util.sendRequest(a,i,j(a,b,c),c)}function o(a,b,c,d,e){var f=k(b.dataset);a=_.extend({query:f,format:"json",rows:1e3},a),a.query+=" delving_hasGeoHash:true";var g=f;b.query&&(a.qf=b.query,g+=b.query),l(g);var h=u+"?"+KR.Util.createQueryParameterString(a);e.allPages?t[g]=n(h,c,d):t[g]=m(h,c,d)}function p(a,c,d,e,f){c=KR.Util.splitBbox(c);var g=c[0],h=c[1],i=c[2],j=c[3],k=(g+i)/2,l=(h+j)/2,m=_.max([KR.Util.haversine(j,k,l,k),KR.Util.haversine(l,g,l,k)]),n={pt:b({lat:l,lng:k}),d:m/1e3,geoType:"bbox"};o(n,a,d,e,f)}function q(a,c,d,e,f,g){var h={pt:b(c),d:d/1e3};o(h,a,e,f,g)}function r(a,b,c,d){if(a.query&&_.isArray(a.query)){var e="delving_spec:"+a.dataset+" AND ("+a.query.join(" OR ")+") AND delving_hasGeoHash:true",f={query:e,format:"json",rows:1e3},g=e;l(g);var h=u+"?"+KR.Util.createQueryParameterString(f);return void(d.allPages?t[g]=n(h,b,c):t[g]=m(h,b,c))}o({},a,b,c,d)}function s(a,b,c){var d={id:a,format:"json"},e=u+"?"+KR.Util.createQueryParameterString(d);KR.Util.sendRequest(e,function(a){return h(a.result)},b,c)}var t=[],u="http://kulturnett2.delving.org/api/search";return{getWithin:q,getItem:s,getBbox:p,getData:r}};var KR=this.KR||{};KR.WikipediaAPI=function(a,b,c,d){"use strict";function e(b,c){var d=a+"?"+KR.Util.createQueryParameterString(b);KR.Util.sendRequest(d,null,function(a){try{a=JSON.parse(a)}catch(b){}c(a)})}function f(a,b){function c(f){if(_.each(f.query.pages,function(a,b){_.has(d,b)?d[b]=_.extend(d[b],a):d[b]=a}),_.has(f,"continue")){var g={};_.has(f["continue"],"picontinue")&&(g.picontinue=f["continue"].picontinue),_.has(f["continue"],"excontinue")&&(g.excontinue=f["continue"].excontinue);var h=_.extend(g,a);e(h,c)}else b(d)}var d={};e(a,c)}function g(a){var b="http://upload.wikimedia.org/wikipedia/commons/",c=CryptoJS.MD5(a).toString();return b+c.substr(0,1)+"/"+c.substr(0,2)+"/"+a}function h(a,b){var c={action:"query",prop:"extracts|pageimages",exlimit:"max",exintro:"",pilimit:"max",pageids:a,format:"json","continue":""};f(c,b)}function i(a,b){b=b||{};var e=b[a.pageid];e&&(a=_.extend(a,e));var f;_.has(a,"thumbnail")&&(f=a.thumbnail.source);var h=null;a.pageimage&&(h=[g(a.pageimage)]);var i=c+a.pageid,j={thumbnail:f,images:h,title:a.title,content:a.extract,link:i,dataset:"Wikipedia",provider:"Wikipedia",contentType:"TEXT",id:a.pageid};return KR.Util.createGeoJSONFeature({lat:a.lat,lng:a.lon},j,d+"_"+i)}function j(a,b,c){try{a=JSON.parse(a)}catch(d){}try{var e=_.pluck(a.query.geosearch,"pageid");e.length?h(e.join("|"),function(c){var d=_.map(a.query.geosearch,function(a){return i(a,c)});b(KR.Util.createFeatureCollection(d))}):b(KR.Util.createFeatureCollection([]))}catch(f){KR.Util.handleError(c,a.error.info)}}function k(c,d,e,f,g){if(e>b)return void KR.Util.handleError(g,"to wide search radius (max is "+b+")");var h={action:"query",list:"geosearch",gsradius:e,gscoord:d.lat+"|"+d.lng,format:"json",gslimit:50},i=a+"?"+KR.Util.createQueryParameterString(h);KR.Util.sendRequest(i,null,function(a){j(a,f,g)},g)}function l(a){var b=_.chain(a).reduce(function(a,b){return _.each(b,function(b,c){_.has(a,c)?a[c]=_.extend(a[c],b):a[c]=b}),a},{}).filter(function(a){return _.has(a,"coordinates")}).map(function(a){return a.lat=a.coordinates[0].lat,a.lon=a.coordinates[0].lon,a}).map(i).value();return KR.Util.createFeatureCollection(b)}function m(b,c,d,e){function f(b){var e=_.extend({},g,b),i=a+"?"+KR.Util.createQueryParameterString(e);KR.Util.sendRequest(i,null,function(a){h.push(a.query.pages),_.has(a,"continue")?f(a["continue"]):c(l(h))},d)}var g={action:"query",generator:"categorymembers",gcmtitle:"Kategori:"+b.category,prop:"coordinates",format:"json"},h=[];f({"continue":""})}function n(b,c,d){var e={action:"query",pageids:b,prop:"coordinates|pageimages|extracts",format:"json"},f=a+"?"+KR.Util.createQueryParameterString(e);KR.Util.sendRequest(f,function(a){return i(a.query.pages[b])},c,d)}return b=b||1e4,{getWithin:k,getData:m,getItem:n}};var KR=this.KR||{};KR.UtnoAPI=function(a){"use strict";function b(a,b,c){if("undefined"==typeof toGeoJSON)throw new Error("toGeoJSON not found!");if("gpx"===a.type){var d="http://ut.no/tur/"+a.id+"/gpx/";KR.Util.sendRequest(d,toGeoJSON.gpx,b,c)}else KR.Util.handleError(c,"Unknown type "+a.type)}return{getData:b}};var KR=this.KR||{};KR.FolketellingAPI=function(a){"use strict";function b(b){var c=_.map(b.results,function(b){var c=KR.Util.dictWithout(b,"latitude","longitude"),d={lat:b.latitude,lng:b.longitude};return KR.Util.createGeoJSONFeature(d,c,a+"_"+b.autoid)});return KR.Util.createFeatureCollection(c)}function c(a,c,d,e,f,i){var j=a.limit||1e3;if("property"!==a.dataset)return void KR.Util.handleError(f,"unknown dataset "+a.dataset);if(d>h)return void KR.Util.handleError(f,"to wide search radius");var k={latitude:c.lat,longitude:c.lng,precision:d,limit:j},l=g+"search_property_geo?"+KR.Util.createQueryParameterString(k);KR.Util.sendRequest(l,b,e,f)}function d(a,b,c){if(0===a.property.id.indexOf("gf")){if(!a.apartments)return a.apartments=null,void b({properties:a});var d=[],e=_.after(a.apartments.length,function(){a.apartments=d,b({properties:a})});return void _.each(a.apartments,function(a){f({type:"apartmentData",apartmentId:a.id},function(a){d.push(a),e()})})}b({properties:a})}function e(a){return a.apartments||(a.apartments=null),{properties:a}}function f(a,b,c,f){var h;"propertyData"===a.type&&a.propertyId?(h=g+"property/"+a.propertyId,a.withPersons?KR.Util.sendRequest(h,null,function(a){d(a,b,c)},c):KR.Util.sendRequest(h,e,b,c)):"apartmentData"===a.type&&a.apartmentId?(h=g+"property/"+a.apartmentId,KR.Util.sendRequest(h,null,b,c)):KR.Util.handleError(c,"Not enough parameters")}var g="http://api.digitalarkivet.arkivverket.no/v1/census/1910/",h=5e3;return{getData:f,getWithin:c}};var KR=this.KR||{};KR.SparqlAPI=function(a,b){"use strict";function c(a){if("undefined"==typeof proj4)throw new Error("Proj4js not found!");return proj4("EPSG:32633","EPSG:4326",a)}function d(a){return a=wellknown.parse(a.value),"Point"===a.type&&(a.coordinates=c(a.coordinates)),"Polygon"===a.type&&(a.coordinates=_.map(a.coordinates,function(a){return _.map(a,c)})),a}function e(a,c){var e=_.map(a.results.bindings,function(a){var c=_.without(_.keys(a),"point","omraade"),e=_.reduce(c,function(b,c){return b[c]=a[c].value,b},{});return e.img||(e.img=!1),e.title=e.name,_.has(a,"point")?KR.Util.createGeoJSONFeatureFromGeom(d(a.point),e,b+"_"+e.id):_.has(a,"omraade")?KR.Util.createGeoJSONFeatureFromGeom(d(a.omraade),e,b+"_"+e.id):null});return KR.Util.createFeatureCollection(e)}function f(a,b){var c=a.results.bindings;return c&&0!==c.length?(c[0].lok.type="Polygon",KR.Util.createGeoJSONFeatureFromGeom(d(c[0].lok),{})):void KR.Util.handleError(b)}function g(b,c,d,e){var f={"default-graph-uri":"",query:b,format:"application/sparql-results+json",timeout:0,debug:"off"},g=a+"?"+KR.Util.createQueryParameterString(f);KR.Util.sendRequest(g,c,d,e)}function h(a){if(a.kommune){var b="select distinct ?id ?name ?description ?loccatlabel ?img ?thumbnail (SAMPLE(?point) as ?point) ?url as ?link { ?id a ?type ; rdfs:label ?name ; <https://data.kulturminne.no/askeladden/schema/beskrivelse> ?description ; <https://data.kulturminne.no/askeladden/schema/lokalitetskategori> ?loccat ; ?p <https://data.kulturminne.no/difi/geo/kommune/"+a.kommune+'> ; <https://data.kulturminne.no/askeladden/schema/geo/point/etrs89> ?point . ?loccat rdfs:label ?loccatlabel . BIND(REPLACE(STR(?id), "https://data.kulturminne.no/askeladden/lokalitet/", "") AS ?lokid) BIND(bif:concat("http://www.kulturminnesok.no/kulturminnesok/kulturminne/?LOK_ID=", ?lokid) AS ?url) optional {  ?picture <https://data.kulturminne.no/bildearkivet/schema/lokalitet> ?id .  ?picture <https://data.kulturminne.no/schema/source-link> ?link  BIND(REPLACE(STR(?id), "https://data.kulturminne.no/askeladden/lokalitet/", "") AS ?lokid)  BIND(bif:concat("http://kulturminnebilder.ra.no/fotoweb/cmdrequest/rest/PreviewAgent.fwx?ar=5001&sz=600&rs=0&pg=0&sr=", ?lokid) AS ?img)  BIND(bif:concat("http://kulturminnebilder.ra.no/fotoweb/cmdrequest/rest/PreviewAgent.fwx?ar=5001&sz=75&rs=0&pg=0&sr=", ?lokid) AS ?thumbnail) }}';return a.limit&&(b+="LIMIT "+a.limit),b}}function i(a){if(a.fylke){var b=parseInt(a.fylke,10);10>b&&(b="0"+b);var c='select  ?id ?name ?description ?loccatlabel (SAMPLE(?point) as ?point) ?img ?thumbnail ?url  as ?link { ?id a ?type . ?id rdfs:label ?name . ?id <https://data.kulturminne.no/askeladden/schema/i-kommune> ?kommune . ?id <https://data.kulturminne.no/askeladden/schema/beskrivelse> ?description . ?id <https://data.kulturminne.no/askeladden/schema/lokalitetskategori> ?lokalitetskategori . ?lokalitetskategori rdfs:label ?loccatlabel . BIND(REPLACE(STR(?id), "https://data.kulturminne.no/askeladden/lokalitet/", "") AS ?lokid) BIND(bif:concat("http://www.kulturminnesok.no/kulturminnesok/kulturminne/?LOK_ID=", ?lokid) AS ?url) ?id <https://data.kulturminne.no/askeladden/schema/geo/point/etrs89> ?point . optional {  ?picture <https://data.kulturminne.no/bildearkivet/schema/lokalitet> ?id .  ?picture <https://data.kulturminne.no/schema/source-link> ?link  BIND(REPLACE(STR(?id), "https://data.kulturminne.no/askeladden/lokalitet/", "") AS ?lokid)  BIND(bif:concat("http://kulturminnebilder.ra.no/fotoweb/cmdrequest/rest/PreviewAgent.fwx?ar=5001&sz=400&rs=0&pg=0&sr=", ?lokid) AS ?img)  BIND(bif:concat("http://kulturminnebilder.ra.no/fotoweb/cmdrequest/rest/PreviewAgent.fwx?ar=5001&sz=75&rs=0&pg=0&sr=", ?lokid) AS ?thumbnail)  } FILTER regex(?kommune, "^.*'+b+'[0-9]{2}") . } order by ?img';return a.limit&&(c+="LIMIT "+a.limit),c}}function j(a){return"SELECT ?lok where {   <"+a+"> <https://data.kulturminne.no/askeladden/schema/geo/area/etrs89> ?lok . }"}function k(a,b,c){var d=[];_.isArray(a.lokalitet)?d=a.lokalitet:d.push(a.lokalitet);var e=[],h=_.after(d.length,function(){b(KR.Util.createFeatureCollection(e))});_.each(d,function(a){g(j(a),f,function(b){b.properties.lok=a,e.push(b),h()},c)})}function l(a,b,c,d){if(a=_.extend({},{geomType:"point"},a),a.kommune){var f=h(a,c);g(f,e,b,c)}else if(a.fylke){var f=i(a,c);g(f,e,b,c)}else a.lokalitet&&"lokalitetpoly"===a.type?k(a,b,c):a.sparqlQuery?g(a.sparqlQuery,e,b,c):KR.Util.handleError(c,"not enough parameters")}return"undefined"!=typeof proj4&&proj4.defs([["EPSG:32633","+proj=utm +zone=33 +datum=WGS84 +units=m +no_defs"]]),{getData:l}};var KR=this.KR||{};KR.FlickrAPI=function(a,b){"use strict";function c(a,b){return h(_.extend({size:b},a))}function d(a){var d=_.map(a.photos.photo,function(a){var d=KR.Util.dictWithout(a,"latitude","longitude");return d.thumbnail=c(a,"s"),d.image=c(a,"z"),KR.Util.createGeoJSONFeature({lat:parseFloat(a.latitude),lng:parseFloat(a.longitude)},d,b+"_"+a.id)});return KR.Util.createFeatureCollection(d)}function e(b,c,e,f,h,i){if(!_.has(b,"user_id"))return void KR.Util.handleError(h,"must specify user_id");var j={method:"flickr.photos.search",user_id:b.user_id,api_key:a,lat:c.lat,lon:c.lng,radius:e/1e3,has_geo:!0,extras:"geo,tags",format:"json",nojsoncallback:1};_.has(b,"tags")&&(j.tags=b.tags.join(","),j.tag_mode=b.tag_mode||"all");var k=g+"?"+KR.Util.createQueryParameterString(j);KR.Util.sendRequest(k,d,f,h)}function f(b,c,e,f){if(!_.has(b,"user_id"))return void KR.Util.handleError(f,"must specify user_id");var h={method:"flickr.photos.search",user_id:b.user_id,api_key:a,bbox:c,has_geo:!0,extras:"geo,tags",format:"json",nojsoncallback:1};_.has(b,"tags")&&(h.tags=b.tags.join(","),h.tag_mode=b.tag_mode||"all");var i=g+"?"+KR.Util.createQueryParameterString(h);KR.Util.sendRequest(i,d,e,f)}var g="https://api.flickr.com/services/rest/",h=_.template("https://farm<%= farm %>.staticflickr.com/<%= server %>/<%= id %>_<%= secret %>_<%= size %>.jpg");return{getWithin:e,getBbox:f}};var KR=this.KR||{};KR.KmlAPI=function(a){"use strict";function b(a,b,c){if("undefined"==typeof toGeoJSON)throw new Error("toGeoJSON not found!");var d=a.url;KR.Util.sendRequest(d,toGeoJSON.kml,b,c)}return{getData:b}};var KR=this.KR||{};KR.JernbanemuseetAPI=function(a,b,c){"use strict";function d(){return{"api-key":a}}function e(a){var d=_.map(a.data.records,function(a){var d=_.extend(a.contents[b],{id:a.record_id}),e={lat:a.latitude,lng:a.longitude};return KR.Util.createGeoJSONFeature(e,d,c+"_"+a.record_id)});return KR.Util.createFeatureCollection(d)}function f(a){return _.map(a.blocks,function(a){if("text"===a.type)return{text:a.data,type:a.type};if("image_video"===a.type){var c=_.map(a.data,function(a){var c;"image"===a.type&&(c=a.url),"video"===a.type&&(c=a.url.mp4);var d="",e="";return _.has(a.contents,b)&&(d=a.contents[b].description,e=a.contents[b].title),{title:e,description:d,type:a.type,url:c}});return{media:c,type:a.type}}})}function g(a){var d,e,g=a.data.contents[b],h={lat:a.data.location.latitude,lng:a.data.location.longitude},i=a.data.id,j=_.map(g.pages,function(a){return{title:a.title,blocks:f(a)}});a.data.images&&(d=_.pluck(a.data.images,"url"),e=a.data.images[0].thumbnail);var k={license:a.data.license.description,id:i,thumbnail:e,images:d,title:g.title,description:g.description,pages:j};return KR.Util.createGeoJSONFeature(h,k,c+"_"+i)}function h(a,b,c){var e=l+"/records/"+a;KR.Util.sendRequest(e,g,b,c,d())}function i(a,b,c){var d=e(a),f=[],g=_.after(d.features.length,function(){b(KR.Util.createFeatureCollection(f))});_.each(d.features,function(a){h(a.properties.id,function(a){f.push(a),g()},function(){g()})})}function j(a,b,c,f,g,h){var j={lat:b.lat,"long":b.lng,radius:c},k=l+"/nearby?"+KR.Util.createQueryParameterString(j);h.getDetails?KR.Util.sendRequest(k,null,function(a){i(a,f,g)},null,d()):KR.Util.sendRequest(k,e,f,g,d())}function k(a,b,c,f){var g=l+"/geography";f.getDetails?KR.Util.sendRequest(g,null,function(a){i(a,b,c)},null,d()):KR.Util.sendRequest(g,e,b,c,d())}b=b||"no";var l="https://api.kulturpunkt.org/v2/owners/54/groups/192";return{getData:k,getWithin:j,getItem:h}};var KR=this.KR||{};KR.API=function(a){"use strict";function b(a,b,c,d,e,f){c=KR.Util.splitBbox(c);var g=c[0],h=c[1],i=c[2],j=c[3],k=(g+i)/2,l=(h+j)/2,m=_.max([KR.Util.haversine(h,g,l,k),KR.Util.haversine(j,i,l,k)]),n={lat:l,lng:k};a.getWithin(b,n,m,d,e,f)}function c(a){var b=v[a];if(b)return b;throw new Error("Unknown API")}function d(a,b,d,e){e=e||{};var f=c(a.api);f.getData(a,b,d,e)}function e(a,d,e,f,g){g=g||{};var h=c(a.api);_.has(h,"getBbox")?h.getBbox(a,d,e,f,g):b(h,a,d,e,f,g)}function f(a,b,d,e,f,g){g=g||{},d=d||5e3;var h=c(a.api);h.getWithin(a,b,d,e,f,g)}function g(a,b,c){if(!n)throw new Error("CartoDB api not configured!");n.getMunicipalityBounds(a,b,c)}function h(a,b,c){if(!n)throw new Error("CartoDB api not configured!");n.getCountyBounds(a,b,c)}function i(a,b,d){var e=c(a.api);if(_.has(e,"getItem"))e.getItem(a.id,b,d);else{if(!d)throw new Error("No getItem function for api "+a.api);d("No getItem function for api "+a.api)}}var j,k=new KR.NorvegianaAPI("norvegiana");KR.WikipediaAPI&&(j=new KR.WikipediaAPI("http://crossorigin.me/https://no.wikipedia.org/w/api.php",null,"http://no.wikipedia.org/?curid=","wikipedia"));var l;KR.ArcgisAPI&&(l=new KR.ArcgisAPI("http://crossorigin.me/http://husmann.ra.no/arcgis/rest/services/Husmann/Husmann/MapServer/","husmann"));var m;KR.SparqlAPI&&(m=new KR.SparqlAPI("https://sparql.kulturminne.no/","kulturminne-sparql"));var n;if(KR.CartodbAPI){var o="knreise";_.has(a,"cartodb")&&(o=a.cartodb.user),n=new KR.CartodbAPI(o,"cartodb-"+o),_.extend(KR.API.mappers,n.mappers())}var p;KR.UtnoAPI&&(p=new KR.UtnoAPI("utno"));var q;KR.FolketellingAPI&&(q=new KR.FolketellingAPI("folketelling1910"));var r;KR.FlickrAPI&&_.has(a,"flickr")&&(r=new KR.FlickrAPI(a.flickr.apikey,"flickr"));var s;KR.KmlAPI&&(s=new KR.KmlAPI);var t;KR.WikipediaAPI&&(t=new KR.WikipediaAPI("http://crossorigin.me/http://test.lokalhistoriewiki.no:8080/api.php",null,"http://lokalhistoriewiki.no/?curid=","lokalhistoriewiki"));var u;KR.JernbanemuseetAPI&&_.has(a,"jernbanemuseet")&&(u=new KR.JernbanemuseetAPI(a.jernbanemuseet.apikey,"no","jernbanemuseet"));var v={norvegiana:k,wikipedia:j,cartodb:n,kulturminnedata:l,kulturminnedataSparql:m,utno:p,folketelling:q,flickr:r,kml:s,lokalhistoriewiki:t,jernbanemuseet:u},w={Artsdatabanken:{name:"Artsdatabanken",dataset:{api:"norvegiana",dataset:"Artsdatabanken"}},difo:{name:"Digitalt fortalt",dataset:{api:"norvegiana",dataset:"difo"}},DiMu:{name:"DigitaltMuseum",dataset:{api:"norvegiana",dataset:"DiMu"}},Industrimuseum:{name:"Industrimuseum",dataset:{api:"norvegiana",dataset:"Industrimuseum"}},"Kulturminnesøk":{name:"Kulturminnesøk",dataset:{api:"norvegiana",dataset:"Kulturminnesøk"}},MUSIT:{name:"Universitetsmuseene",dataset:{api:"norvegiana",dataset:"MUSIT"}},Naturbase:{name:"Naturbase",dataset:{api:"norvegiana",dataset:"Naturbase"}},Stedsnavn:{name:"Stedsnavn",dataset:{api:"norvegiana",dataset:"Stedsnavn"}},wikipedia:{name:"Wikipedia",dataset:{api:"wikipedia"}},search_1:{name:"Byantikvaren i Oslo",dataset:{api:"cartodb",table:"search_1"}}};return{getData:d,getWithin:f,getBbox:e,getMunicipalityBounds:g,getCountyBounds:h,datasets:function(){return _.extend({},w)},getItem:i}},KR.API.mappers={};