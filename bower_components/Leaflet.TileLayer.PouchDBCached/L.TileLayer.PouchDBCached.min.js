L.TileLayer.addInitHook(function(){if(!this.options.useCache){this._db=null;this._canvas=null;return}this._db=new PouchDB("offline-tiles");this._canvas=document.createElement("canvas");if(!(this._canvas.getContext&&this._canvas.getContext("2d"))){this._canvas=null}});L.TileLayer.prototype.options.useCache=false;L.TileLayer.prototype.options.saveToCache=true;L.TileLayer.prototype.options.useOnlyCache=false;L.TileLayer.prototype.options.cacheMaxAge=24*3600*1e3;L.TileLayer.include({_loadTile:function(tile,tilePoint){tile._layer=this;tile.onerror=this._tileOnError;this._adjustTilePoint(tilePoint);var tileUrl=this.getTileUrl(tilePoint);this.fire("tileloadstart",{tile:tile,url:tileUrl});if(this.options.useCache&&this._canvas){this._db.get(tileUrl,{revs_info:true},this._onCacheLookup(tile,tileUrl))}else{tile.onload=this._tileOnLoad;tile.src=tileUrl}},_onCacheLookup:function(tile,tileUrl){return function(err,data){if(data){this.fire("tilecachehit",{tile:tile,url:tileUrl});if(Date.now()>data.timestamp+this.options.cacheMaxAge&&!this.options.useOnlyCache){if(this.options.saveToCache){tile.onload=this._saveTile(tileUrl,data._revs_info[0].rev)}tile.crossOrigin="Anonymous";tile.src=tileUrl;tile.onerror=function(ev){this.src=data.dataUrl}}else{tile.onload=this._tileOnLoad;tile.src=data.dataUrl}}else{this.fire("tilecachemiss",{tile:tile,url:tileUrl});if(this.options.useOnlyCache){tile.onload=this._tileOnLoad;tile.src=L.Util.emptyImageUrl}else{if(this.options.saveToCache){tile.onload=this._saveTile(tileUrl)}else{tile.onload=this._tileOnLoad}tile.crossOrigin="Anonymous";tile.src=tileUrl}}}.bind(this)},_saveTile:function(tileUrl,existingRevision){return function(ev){if(this._canvas===null)return;var img=ev.target;L.TileLayer.prototype._tileOnLoad.call(img,ev);this._canvas.width=img.naturalWidth||img.width;this._canvas.height=img.naturalHeight||img.height;var context=this._canvas.getContext("2d");context.drawImage(img,0,0);var dataUrl=this._canvas.toDataURL("image/png");var doc={dataUrl:dataUrl,timestamp:Date.now()};if(existingRevision){this._db.remove(tileUrl,existingRevision)}this._db.put(doc,tileUrl,doc.timestamp)}.bind(this)},seed:function(bbox,minZoom,maxZoom){if(minZoom>maxZoom)return;if(!this._map)return;var queue=[];for(var z=minZoom;z<maxZoom;z++){var northEastPoint=this._map.project(bbox.getNorthEast(),z);var southWestPoint=this._map.project(bbox.getSouthWest(),z);var tileSize=this._getTileSize();var tileBounds=L.bounds(northEastPoint.divideBy(tileSize)._floor(),southWestPoint.divideBy(tileSize)._floor());for(var j=tileBounds.min.y;j<=tileBounds.max.y;j++){for(var i=tileBounds.min.x;i<=tileBounds.max.x;i++){point=new L.Point(i,j);point.z=z;queue.push(this.getTileUrl(point))}}}var seedData={bbox:bbox,minZoom:minZoom,maxZoom:maxZoom,queueLength:queue.length};this.fire("seedstart",seedData);var tile=this._createTile();tile._layer=this;this._seedOneTile(tile,queue,seedData)},_seedOneTile:function(tile,remaining,seedData){if(!remaining.length){this.fire("seedend",seedData);return}this.fire("seedprogress",{bbox:seedData.bbox,minZoom:seedData.minZoom,maxZoom:seedData.maxZoom,queueLength:seedData.queueLength,remainingLength:remaining.length});var url=remaining.pop();this._db.get(url,function(err,data){if(!data){tile.onload=function(ev){this._saveTile(url)(ev);this._seedOneTile(tile,remaining,seedData)}.bind(this);tile.crossOrigin="Anonymous";tile.src=url}else{this._seedOneTile(tile,remaining,seedData)}}.bind(this))}});
