function getRandomInt(e,t){return Math.floor(Math.random()*(t-e+1))+e}function _loadDatasetMock(e,t,i){setTimeout(function(){i(null,e)},getRandomInt(500,3e3))}function toDict(e,t,i){return _.reduce(e,function(e,n){return e[n[t]]=_.isFunction(i)?i(n):i,e},{})}function ApiLoader(e,t){return function(i,n,r){var a=t[i];if(a.bbox||a.isStatic&&a.fixedBbox){var o=a.fixedBbox?a.fixedBbox:n;e.getBbox(a.dataset,o,function(e){r(null,e)},function(e){r(e,null)})}else e.getData(a.dataset,function(e){r(null,e)},function(e){r(e,null)})}}function DatasetLoader(e,t,i,n,r){function a(e,t,i,n){if(v[t]&&k[t]){var r=_.chain(e).map(function(e){return h[e]}).filter(function(e){return n||!e.static}).value();if(0!==r.length){y[t]=!0,b[t]=i,_.each(S,function(e){e(t)});var a=_.after(r.length,function(){y[t]=!1,_.each(D,function(e){e(t)})}),o=i.toBBoxString();_.each(r,function(e){g(e._id,o,function(t,i){!function(e,t,i){i?K[e]=i:(K[e]=null,C[e]=t);_.each(x,function(n){n(i,e,t)})}(e._id,i,t),a()})})}}}function o(e,t){_.each(m,_.partial(a,_,_,e,t))}function s(e){return!e.minZoom||p>e.minZoom}function l(e,t){var i=_.isString(e)?L.latLngBounds.fromBBoxString(e):e,n=_.isString(e)?L.latLngBounds.fromBBoxString(t):t;return!i.equals(n)&&!i.contains(n)}function u(e,t){var i=_.uniq(_.keys(e).concat(_.keys(t)));return _.reduce(i,function(i,n){return _.has(e,n)?_.isObject(e[n])&&_.has(t,n)?i[n]=u(e[n],t[n]):i[n]=e[n]:i[n]=_.clone(t[n]),i},{})}function c(e,t){return _.map(e,function(e){return e.datasets&&(e.datasets=c(e.datasets,e)),t?u(u(e,_.omit(t,"datasets","grouped")),DATASET_DEFAULTS):u(e,DATASET_DEFAULTS)})}function d(e){return{_id:e._id,name:e.name,isLoading:y[e._id],isAvailable:k[e._id],isEnabled:v[e._id],style:e.style,template:e.template?e.template:KR.Util.getDatasetTemplate("popup"),description:e.description,provider:e.provider,feedbackForm:e.feedbackForm,getFeatureData:e.getFeatureData,noListThreshold:e.noListThreshold}}var f=n;e=c(e),console.log(e);var p=t.getZoom();!function(e){_.each(e,function(e,t){e.grouped&&_.each(e.datasets,function(e,i){e._id="dataset_"+t+"_"+i}),e._id="dataset_"+t})}(e);var m=function(e){return _.reduce(e,function(e,t){return e[t._id]=t.grouped?_.pluck(t.datasets,"_id"):[t._id],e},{})}(e),h=function(e){return _.reduce(e,function(e,t){return t.grouped?e=_.extend({},e,_.reduce(t.datasets,function(e,i){return i.group=t._id,e[i._id]=i,e},{})):e[t._id]=t,e},{})}(e),g=ApiLoader(i,h),v=toDict(e,"_id",!0),y=toDict(e,"_id",!1),k=toDict(e,"_id",s),b=toDict(e,"_id",n),C=toDict(h,"_id",null),K=toDict(h,"_id",null),S=[],D=[],w=[],R=[],x=[];return t.on("moveend",function(i){t.getZoom()!==p&&(p=t.getZoom(),_.each(e,function(e){var t=s(e);return t!==k[e._id]&&(k[e._id]=t,_.each(R,function(i){i(e._id,t)})),t}));var n=t.getBounds();l(f,n)&&o(n,!1),f=n}),{onLoadStart:function(e){S.push(e)},onLoadEnd:function(e){D.push(e)},onDataLoadEnd:function(e){x.push(e)},onEnabledChange:function(e){w.push(e)},onAvailableChange:function(e){R.push(e)},init:function(){o(f,!0)},toggleEnabled:function(e){var t=v[e];v[e]=!t,_.each(w,function(i){i(e,!t)}),!t&&l(b[e],f)&&a(m[e],e,f,!1)},getData:function(e){return{error:K[e],data:C[e]}},datasetIdMapping:_.extend({},m),getLayers:function(){return _.map(e,d)},getDataset:function(e){var t=_.find(h,function(t){return t._id===e});return t?d(t):null}}}function getMarker(e,t,i,n){var r;if(e.properties&&e.properties.title&&(r=e.properties.title),i.isThumbnail&&e.properties&&e.properties.thumbnail){var a=i.get("fillcolor",e,n),o='<div class="outer"><div class="circle" style="background-image: url(\''+KR.Util.getImageCache(e.properties.thumbnail,50,50)+"');border-color:"+a+';"></div></div>';return L.marker(t,{icon:new L.DivIcon({className:"leaflet-marker-circle",html:o,iconSize:[50,50],iconAnchor:[25,25]}),title:r,clickable:i.get("clickable",e,n)})}return i.isCircle?L.circleMarker(t,{radius:i.get("radius",e,n),weight:1,opacity:1,color:i.get("bordercolor",e,n),fillColor:i.get("fillcolor",e,n),fillOpacity:.4,title:r,clickable:i.get("clickable",e,n)}):L.marker(t,{icon:L.Knreise.icon({markerColor:i.get("fillcolor",e,n)}),title:r,clickable:i.get("clickable",e,n)})}function LayerManager(e,t,i){function n(n,r,o){n?console.log("err",r):function(n,r){var o=t.getDataset(n);if(!o)return void console.error("did not find dataset",n);var s=Style(o.style),l=a[n];e.removeLayer(l),a[n]=L.geoJson(r,{pointToLayer:function(e,t){return getMarker(e,t,s,!1)},style:function(e){return{fillColor:s.get("fillcolor",e,!1),color:s.get("bordercolor",e,!1),weight:s.get("weight",e,!1),fillOpacity:s.get("fillOpacity",e,!1),title:"test"}},onEachFeature:function(e,r){r.on("click",function(r){return function(e,n,r){console.log("click",e,n,r),i(n,t.getDataset(r))}(r,e,n)})}}).addTo(e)}(r,o)}function r(i,n){_.each(t.datasetIdMapping[i],function(t){var i=a[t];n&&!e.hasLayer(i)&&e.addLayer(i),!n&&e.hasLayer(i)&&e.removeLayer(i)})}var a={};return{init:function(){t.onDataLoadEnd(n),t.onEnabledChange(r),a=_.reduce(t.datasetIdMapping,function(t,i,n){return _.extend(t,_.reduce(i,function(t,i){return t[i]=L.featureGroup([]).addTo(e),t},{}))},{})}}}!function(e){"use strict";e.parseError=function(e){if(e.responseJSON){if(e.responseJSON.error)return e.responseJSON.error.join(", ");if(e.responseJSON.status)return e.responseJSON.status}return e.statusText?e.statusText:e.error?e.error.info?e.error.info:e.error.error?e.error.error:e.error:"Unknown error"},e.errorHandler=function(t){var i=$(t);i.find(".close").on("click",function(){i.find(".content").html(""),i.remove()});var n=_.template("<div><strong><%= dataset %>:</Strong> <%= error %></div>");return function(t){var r=n({dataset:t.dataset,error:e.parseError(t.error)});i.parent()?i.find(".content").append(r):i.find(".content").html(r),$("body").append(i)}}}(KR=this.KR||{});(KR=this.KR||{}).Config={contentIcons:{IMAGE:"camera-retro",VIDEO:"file-video-o",SOUND:"music",TEXT:"file-text",default:"file-o"},templates:{}},KR.Config.ImageCaheUrl="http://egbtmre.cloudimg.io",KR.Util=KR.Util||{},function(e){"use strict";function t(e,t){var i=e.lastIndexOf(t);return-1!==i&&i+t.length===e.length}e.iconForContentType=function(e){var t=e.properties.contentType;return _.has(KR.Config.contentIcons,t)?KR.Config.contentIcons[t]:KR.Config.contentIcons.default},e.getDatasetTemplate=function(e){var t=$("#"+e+"_template").html();if(t)return _.template(t)},e.templateForDataset=function(e){if(_.has(KR.Config.templates,e))return KR.Config.templates[e]},e.createStyleString=function(e){return _.map(e,function(e,t){return t+": "+e}).join(";")},e.colorForProvider=function(e,t){var i=!0;"hex"!==t&&(i=!1);var n={properties:{datasetId:e}};return KR.Style.colorForFeature(n,i,!0)},e.featureClick=function(e){return function(t,i,n){i.on("click",function(i){n&&n.toPoint&&n.toPoint.stopPolyClick&&!i.parent||(n?e.showFeature(t,n.template,n.getFeatureData):e.showFeature(t))})}},e.getTemplateForFeature=function(e,t){if(t){if(t.datasets){return _.find(t.datasets,function(t){return t._knreise_id===e.properties.datasetID}).template}return t.template}},e.clusterClick=function(t){return function(i,n){i.on("clusterclick",function(i){var r=_.map(i.layer.getAllChildMarkers(),function(t){var i=t.feature;return n&&!i.template&&(i.template=e.getTemplateForFeature(i,n)),i}),a=_.extend({},{template:null,getFeatureData:null,noListThreshold:null},n);t.showFeatures(r,a.template,a.getFeatureData,a.noListThreshold)})}},e.hexToRgba=function(e,t){t=t||1;var i=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);if(!i)return 0;return"rgba("+parseInt(i[1],16)+","+parseInt(i[2],16)+","+parseInt(i[3],16)+","+t+")"},e.filterByBbox=function(e,t){var i=turf.featurecollection([turf.bboxPolygon(KR.Util.splitBbox(t))]);return turf.within(e,i)},e.getDatasetId=function(e){return"norvegiana"===e.dataset.api?e.dataset.dataset:"wikipedia"===e.dataset.api?"wikipedia":e.id?e.id:KR.Util.stamp(e)},"undefined"!=typeof L&&(L.latLngBounds.fromBBoxArray=function(e){return new L.LatLngBounds(new L.LatLng(e[1],e[0]),new L.LatLng(e[3],e[2]))},L.latLngBounds.fromBBoxString=function(e){return L.latLngBounds.fromBBoxArray(KR.Util.splitBbox(e))},L.rectangle.fromBounds=function(e){return L.rectangle([e.getSouthWest(),e.getNorthEast()])}),e.parseQueryString=function(e){var t=decodeURIComponent(e);if(""!==t)return _.reduce(t.replace("?","").split("&"),function(e,t){var i=(t=t.split("="))[1];return"true"===i?i=!0:"false"===i&&(i=!1),e[t[0]]=i,e},{})};var i=_.template("<%= totalt %> (<%= menn %> menn, <%= kvinner %> kvinner)");e.formatPersons=function(e){var t=e.split("-");return t.length<2?e:i({totalt:t[0],menn:t[1],kvinner:t[2]})},e.getBaseLayer=function(e,t){var i={nib:KR.getNibLayer,hist:function(e){e(L.tileLayer.wms("http://wms.geonorge.no/skwms1/wms.historiskekart",{layers:"historiskekart",format:"image/png",attribution:"Kartverket"}))}};if(_.has(i,e))i[e](t);else{var n=!(navigator.userAgent.indexOf("Safari")>-1);t(L.tileLayer.kartverket(e,{useCache:n}))}},e.getLine=function(e,i,n){if(_.isFunction(i))i(function(e){n(e)});else{var r;if(0===i.indexOf("utno/")){r={api:"utno",id:i.replace("utno/",""),type:"gpx"}}else 0===i.indexOf("http")&&(t(i,"kml")?r={api:"kml",url:i}:t(i,"gpx")||-1!==i.indexOf("http://ut.no/tur/")?r={api:"gpx",url:i}:t(i,"geojson")&&(r={api:"geojson",url:i}));r?e.getData(r,function(e){n(e)}):alert("Kunne ikke laste linjegeometri")}},e.messageDisplayer=function(e){return function(t,i){var n=$(e);n.find(".close").on("click",function(){n.find(".content").html(""),n.remove()}),n.addClass("alert-"+t),n.find(".content").html(i),$("body").append(n)}},e.mostlyCoveringMunicipality=function(e,t,i){var n="ST_MakeEnvelope("+t+", 4326)",r={api:"cartodb",query:"SELECT komm FROM kommuner WHERE ST_Intersects(the_geom, "+n+")ORDER BY st_area(st_intersection(the_geom, "+n+")) DESC LIMIT 1",mapper:function(e){return e.rows[0].komm}};e.getData(r,i)},e.sparqlBbox=function(e,t,i,n,r){KR.Util.mostlyCoveringMunicipality(e,i,function(i){t.kommune=function(e){return e<1e3?"0"+e:e}(i),e.getData(t,n,r)})},e.distanceAndSort=function(e,t){var i=_.map(e.features,function(e){return e.properties.distance=turf.distance(t,e),e});return turf.featurecollection(i.sort(function(e,t){return e.properties.distance<t.properties.distance?-1:e.properties.distance>t.properties.distance?1:0}))},e.round=function(e,t){_.isUndefined(t)&&(t=2);var i=Math.pow(10,t);return Math.round(e*i)/i};var n=_.template("#<%= zoom %>/<%= lat %>/<%= lon %>");e.getPositionHash=function(t,i,r){return n({zoom:r,lat:e.round(t,4),lon:e.round(i,4)})},e.WORLD={type:"Feature",geometry:{type:"Polygon",coordinates:[[[-180,-90],[-180,90],[180,90],[180,-90],[-180,-90]]]}},e.createMap=function(t,i){i=i||{};var n=L.map(t,{minZoom:i.minZoom||3,maxZoom:i.maxZoom||18,maxBounds:L.geoJson(e.WORLD).getBounds()}),r=i.layer||"norges_grunnkart_graatone";return _.isString(r)?KR.Util.getBaseLayer(r,function(e){e.addTo(n)}):r.addTo(n),i.showScaleBar&&L.control.scale({imperial:!1}).addTo(n),n},e.setupSidebar=function(e,t){t=t||{};var i=KR.Util.getDatasetTemplate("popup"),n=_.template($("#list_item_template").html()),r=_.template($("#marker_template").html()),a=_.template($("#thumbnail_template").html()),o=_.template($("#footer_template").html()),s=_.extend({},{position:"left",template:i,listElementTemplate:n,markerTemplate:r,thumbnailTemplate:a,footerTemplate:o},t),l=L.Knreise.Control.sidebar("sidebar",s);return e.addControl(l),l},e.distanceAndBearing=function(e,t){return{distance:1e3*turf.distance(e,t,"kilometers"),bearing:turf.bearing(e,t)}};var r=_.template("<%= service %>/s/crop/<%= width %>x<%= height %>/<%= image %>");e.getImageCache=function(e,t,i){return KR.Config.ImageCaheUrl?r({service:KR.Config.ImageCaheUrl,width:t,height:i,image:e}):e},e.isInIframe=function(){try{return window.self!==window.top}catch(e){return!0}},e.checkThresholdPassed=function(e,t,i){var n;e.on("zoomstart",function(t){n=e.getZoom()}),e.on("zoomend",function(r){var a=e.getZoom();n>t&&a<=t&&i("up"),n<=t&&a>t&&i("down")})}}(KR.Util);(KR=this.KR||{}).Style={},function(e){"use strict";function t(e){var t=e.properties.vernef_id;return _.find(d,function(e){return-1!==e.ids.indexOf(t)})}function i(e){return m[e]||"blue"}function n(e,t,i,n){return _.isFunction(e[t])?n?e[t]():e[t](i):e[t]}function r(e,t,i){return i?n(e,"fillcolor",t,!0):n(e,"fillcolor",t)}function a(e,t){return e.bordercolor?n(e,"bordercolor",t):r(e,t)}function o(t){return e.groups[t]}function s(t){var i;return t.properties&&t.properties.groupId?o(t.properties.groupId):(t.properties&&t.properties.datasetId&&(i=e.getDatasetStyle(t.properties.datasetId)),i||_.extend({},f))}function l(e,t,i){return i=i||9,{radius:i,weight:1,opacity:1,color:e,fillColor:t,fillOpacity:.4}}function u(e,t,i){var n="";return e.properties&&e.properties.title&&(n=e.properties.title),L.marker(t,{icon:i,title:n})}function c(e,t,i){if(e.properties&&e.properties.thumbnail){var n={"border-color":t,"background-image":"url('"+e.properties.thumbnail+"')"};i&&(n["border-width"]="3px");var r='<div class="outer"><div class="circle" style="background-image: url(\''+KR.Util.getImageCache(e.properties.thumbnail,50,50)+"');border-color:"+t+';"></div></div>';return new L.DivIcon({className:"leaflet-marker-circle",html:r,iconSize:[50,50],iconAnchor:[25,25]})}}var d={landskapsvern:{ids:["LVO","LVOD","LVOP","LVOPD","BV","MAV","P","GVS","MIV","NM","BVV","PO","DO","D"],style:{fillColor:"#d8cb7a",color:"#9c8f1b"}},nasjonalpark:{ids:["NP","NPS"],style:{fillColor:"#7f9aac",color:"#b3a721"}},naturreservat:{ids:["NR","NRS"],style:{fillColor:"#ef9874",color:"#ef9873"}}},f={fillcolor:"#38A9DC",circle:!1,thumbnail:!0},p={difo:"Digitalt fortalt",Kulturminnesok:"Kulturminnesok",DiMu:"DigitaltMuseum",MUSIT:"Musit",Artsdatabanken:"Artsdatabanken",wikipedia:"wikipedia",riksantikvaren:"riksantikvaren"};e.datasets={"Digitalt fortalt":{fillcolor:"#F69730",circle:!1,thumbnail:!0},Kulturminnesok:{fillcolor:"#436978",circle:!1,thumbnail:!1},DigitaltMuseum:{fillcolor:"#436978",circle:!1,thumbnail:!1},Musit:{fillcolor:"#436978",circle:!1,thumbnail:!1},Artsdatabanken:{fillcolor:"#5B396B",thumbnail:!1,circle:!0},riksantikvaren:{fillcolor:"#436978",circle:!1,thumbnail:!0},verneomraader:{fillcolor:function(e){if(e){var i=t(e);if(i)return i.style.fillColor}return"#009300"},bordercolor:function(e){if(e){var i=t(e);if(i)return i.style.color}return"#009300"},thumbnail:!1,circle:!0},wikipedia:{fillcolor:"#D14020",thumbnail:!0}},e.groups={},e.getDatasetStyle=function(t){var i=e.datasets[p[t]];return i||(i=e.datasets[t]),i},e.setDatasetStyle=function(t,i){_.has(p,t)||(p[t]=t);var n=e.getDatasetStyle(t);n||(n=f),e.datasets[p[t]]=_.extend({},n,i)};var m={"#F69730":"orange","#38A9DC":"blue","#A23336":"darkred","#72B026":"green","#436978":"cadetblue","#5B396B":"darkpurple","#728224":"darkgreen","#D252B9":"purple","#D14020":"red"};e.getClusterIcon=function(e,t){var i,n=e.getAllChildMarkers(),a=_.uniq(_.map(n,function(e){return e.feature.properties.groupId})),l=s(n[0].feature);if(_.compact(a).length>1){var u=_.compact(a);u.length>1&&(i=_.map(u,_.compose(r,o)))}else i=r(l,n[0].feature);if(t&&(i="#72B026"),l.thumbnail){var c=function(e,t,i){var n=_.filter(e,function(e){return e.feature.properties.thumbnail});if(n.length){var r;_.isArray(t)&&(r=_.rest(t),t=t[0]);var a={"border-color":t,"background-image":"url('"+KR.Util.getImageCache(n[0].feature.properties.thumbnail,50,50)+"');"};r&&(a["box-shadow"]=_.map(r,function(e,t){return"0 0 0 "+2*(t+1)+"px "+e}).join(",")+";"),i&&(a["border-width"]="3px");var o='<div class="outer"><div class="circle" style="'+KR.Util.createStyleString(a)+'"></div></div><b>'+e.length+"</b>";return new L.DivIcon({className:"leaflet-marker-photo",html:o,iconSize:[60,60],iconAnchor:[30,30]})}}(n,i,t);if(c)return c}return function(e,t){var i=KR.Util.hexToRgba(t,.4);return new L.DivIcon({className:"leaflet-marker-circle",html:'<div class="outer"><div class="circle" style="background-color: '+i+";border-color:"+t+';"></div></div><b>'+e.length+"</b>",iconSize:[20,20],iconAnchor:[10,10]})}(n,i)},e.getIcon=function(e,t){var i=s(e),n=t?"#72B026":r(i,e),o=t?"#72B026":a(i,e);if(i.thumbnail){var u=c(e,o,t);if(u)return u}return i.circle?l(o,n,i.radius):function(e){return L.Knreise.icon({markerColor:e})}(n)},e.getMarker=function(t,i){var n=s(t);if(n.thumbnail){var o=c(t,a(n,t),!1);if(o)return u(t,i,o)}return n.circle?function(e,t,i){return L.circleMarker(e,l(t,i))}(i,a(n,t),r(n,t)):u(t,i,e.getIcon(t,!1))},e.colorForFeature=function(e,t,n){var a=s(e);if(a)return t?r(a,e,n):i(r(a,e))},e.colorForDataset=function(t,n,a){var o,l;if(t.grouped?(o=e.groups[KR.Util.stamp(t)])||(l=t.datasets[0].extras.datasetId):(l||(l=t.extras.datasetId),o=s({properties:{datasetId:l}})),o)return n?r(o,null,a):i(r(o,null))},e.getPathStyle=function(e,t){t=t||!1;var i=s(e),n=r(i,e);return{weight:1,color:a(i,e),fillColor:n,clickable:t,opacity:.8,fillOpacity:.4}},e.getPathStyleForGroup=function(t,i){var n={properties:{groupId:t}};return e.getPathStyle(n,i)}}(KR.Style),L.Knreise=L.Knreise||{},L.Knreise.MarkerClusterGroup=L.MarkerClusterGroup.extend({options:{zoomToBoundsOnClick:!1,spiderfyOnMaxZoom:!1,polygonOptions:{fillColor:"#ddd",weight:2,color:"#999",fillOpacity:.6}},initialize:function(e){L.Util.setOptions(this,e),this.options.iconCreateFunction||(this.options.iconCreateFunction=this._iconCreator.bind(this)),this._featureGroup=L.featureGroup(),this._featureGroup.on(L.FeatureGroup.EVENTS,this._propagateEvent,this),this._nonPointGroup=L.featureGroup(),this._nonPointGroup.on(L.FeatureGroup.EVENTS,this._propagateEvent,this),this._inZoomAnimation=0,this._needsClustering=[],this._needsRemoving=[],this._currentShownBounds=null,this._queue=[],this.on("clusterclick",this._clusterClicked,this),this.isUnclustred=!1},onAdd:function(e){L.MarkerClusterGroup.prototype.onAdd.apply(this,arguments),e.on("layerSelected",this._deselectAll,this),this._map=e,_.has(this.options,"unclusterCount")&&(this._unclustred=L.featureGroup().addTo(e),this._unclustred.on("click",_.bind(function(e){this.fire("click",e)},this)),this.on("hide",function(){e.removeLayer(this._unclustred)}),this.on("show",function(){e.addLayer(this._unclustred)}))},getVisibleLayers:function(e){var t=this._map.getBounds();return _.chain(e).filter(function(e){return!e.getLatLng||t.contains(e.getLatLng())}).value()},getLayers:function(){return this.isUnclustred?this.getUnclustredLayers():L.MarkerClusterGroup.prototype.getLayers.apply(this,arguments)},getUnclustredLayers:function(){return this._unclustred.getLayers()},addLayers:function(e){var t=this.getLayers(),i=this.options.unclusterCount,n=this.getVisibleLayers(e);this._unclustred&&this._unclustred.clearLayers(),n.length<=i?(this.isUnclustred=!0,_.each(n,function(e){this._unclustred.addLayer(e)},this)):(this.isUnclustred=!1,L.MarkerClusterGroup.prototype.addLayers.apply(this,arguments)),this.fire("dataloaded",{prevLayers:t})},_deselectAll:function(){_.each(this._gridClusters,function(e){_.each(e._grid,function(e){_.each(e,function(e){_.each(e,function(e){e.selected&&(e.createIcon=_.bind(L.MarkerCluster.prototype.createIcon,e),e._updateIcon(),e.selected=!1)})})})}),this.eachLayer(function(e){e.selected&&(e.createIcon=_.bind(L.MarkerCluster.prototype.createIcon,e),e.setIcon(_.bind(L.Knreise.GeoJSON.prototype._createFeatureIcon,this)(e.feature)),e.selected=!1)},this)},_clusterClicked:function(e){this._map.fire("layerSelected");var t=e.layer,i=_.bind(this._iconCreator,this);t.createIcon=function(){return i(this,!0).createIcon()},t.selected=!0,t._updateIcon()},_iconCreator:function(e,t){return KR.Style.getClusterIcon(e,t)}}),L.Knreise.markerClusterGroup=function(e){return new L.Knreise.MarkerClusterGroup(e)},L.Knreise=L.Knreise||{},L.Knreise.GeoJSON=L.GeoJSON.extend({initialize:function(e,t){L.setOptions(this,t),this._layers={},this.options.pointToLayer=this._pointToLayer.bind(this),e&&this.addData(e),this.on("click",this._featureClicked,this),this.on("dblclick",this._featureDblClicked,this),this._selectedLayer=null},removedPaths:[],isCollapsed:function(e,t){var i=this.options.dataset.toPoint.minSize||20,n=e.getBounds(),r=this._map.project(n.getNorthEast(),t),a=this._map.project(n.getSouthWest(),t),o=r.x-a.x;return a.y-r.y<i||o<i},_deselectAll:function(){if(this._selectedLayer){var e=this._selectedLayer;if(e.setIcon&&(e.setIcon(this._createFeatureIcon(e.feature,!1)),e.setZIndexOffset(0)),e.setStyle){var t=e.feature;if(!t){t=this.getParentLayer(e._leaflet_id).feature}if(e.setStyle(this._createFeatureIcon(t,!1)),e.getParent){e.getParent().setStyle(this._createFeatureIcon(t,!1))}}this._selectedLayer=null}},deselectAllNew:function(){_.each(this.getLayers(),function(e){if(e.setIcon&&(e.setIcon(this._createFeatureIcon(e.feature,!1)),e.setZIndexOffset(0)),e.setStyle){var t=e.feature;if(!t){t=this.getParentLayer(e._leaflet_id).feature}if(e.setStyle(this._createFeatureIcon(t,!1)),e.getParent){e.getParent().setStyle(this._createFeatureIcon(t,!1))}}},this)},setLayerSelected:function(e){if(e.setIcon&&(e.setIcon(this._createFeatureIcon(e.feature,!0)),e.setZIndexOffset(1e3)),e.setStyle){var t=e.feature;if(!t){t=this.getParentLayer(e._leaflet_id).feature}if(t&&(e.setStyle(this._createFeatureIcon(t,!0)),e.bringToFront()),e.getParent){e.getParent().setStyle(this._createFeatureIcon(t,!0))}}this._selectedLayer=e},_featureClicked:function(e){if(!(this.options.dataset&&this.options.dataset.toPoint&&this.options.dataset.toPoint.stopPolyClick&&"Point"!==e.layer.toGeoJSON().geometry.type)){e.layer._map&&e.layer._map.fire("layerSelected");var t=e.layer;this.setLayerSelected(t)}},_featureDblClicked:function(e){this.options.dataset&&this.options.dataset.toPoint&&this.options.dataset.toPoint.stopPolyClick&&"Point"!==e.layer.toGeoJSON().geometry.type&&e.layer._map&&e.layer._map.zoomIn()},getParentLayer:function(e){var t=this._layers[e];if(t)return t;var i,n;for(i in this._layers)if(this._layers.hasOwnProperty(i)&&(n=this._layers[i]).getLayer&&n.getLayer(e))return n},getZoomThreshold:function(e){var t=null,i=this._map.getZoom();if(this.isCollapsed(e,this._map.getZoom()))for(;!t;)i+=1,this.isCollapsed(e,i)||(t=i-1);else for(;!t;)i-=1,this.isCollapsed(e,i)&&(t=i);return t},_zoomend:function(){if(this.options.dataset.toPoint&&this.shouldLoad){var e,t,i=[];for(this.eachLayer(function(e){this._map.getZoom()<=e.zoomThreshold&&(this.removeLayer(e),this.options.dataset.toPoint.showAlways||this.addLayer(e.marker),i.push(e))},this),t=0;t<this.removedPaths.length;t++)e=this.removedPaths[t],this._map.getZoom()>e.zoomThreshold&&(this.options.dataset.toPoint.showAlways||this.removeLayer(e.marker),this.addLayer(e),this.removedPaths.splice(t,1),t-=1);this.removedPaths=this.removedPaths.concat(i)}},_getCenter:function(e){if("undefined"!=typeof turf){var t=turf.pointOnSurface(e.toGeoJSON());return L.latLng(t.geometry.coordinates.reverse())}return e.getBounds().getCenter()},_layeradd:function(e){var t=e.layer;if("Point"===t.feature.geometry.type||t.isMarker||(t.setStyle(KR.Style.getPathStyle(t.feature)),t.bringToBack()),this.options.dataset.toPoint){if(t.isMarker)return;if(t.getBounds&&!t.zoomThreshold&&!t.marker){var i=this.getZoomThreshold(t),n=this._pointToLayer(t.feature,this._getCenter(t));n.feature=t.feature,n.on("click",function(e){t.fire("click",{containerPoint:e.containerPoint,latlng:e.latlng,layerPoint:e.layerPoint,originalEvent:e.originalEvent,target:e.target,type:e.type,parent:!0})}),t.zoomThreshold=i,this.removedPaths.push(t),t.marker=n,t.marker.isMarker=!0,t.marker.getParent=function(){return t},this._map.getZoom()<=i&&(this.removeLayer(t),this.options.dataset.toPoint.showAlways||this.addLayer(t.marker)),this.options.dataset.toPoint.showAlways&&this.addLayer(t.marker)}}},setMap:function(e){e.on("layerSelected",this._deselectAll,this)},onAdd:function(e){L.GeoJSON.prototype.onAdd.apply(this,arguments),this.options.dataset&&this.options.dataset.toPoint&&(this._zoomend(),e.on("zoomend",this._zoomend,this),this.on("layeradd",this._layeradd,this)),this.setMap(e)},_createFeatureIcon:function(e,t){return KR.Style.getIcon(e,t)},_pointToLayer:function(e,t){return KR.Style.getMarker(e,t)}}),L.Knreise.geoJson=function(e,t){return new L.Knreise.GeoJSON(e,t)},L.Knreise=L.Knreise||{},L.Knreise.Control=L.Knreise.Control||{},L.Knreise.Control.Sidebar=L.Control.Sidebar.extend({initialize:function(e,t){(t=t||{}).autoPan=!1,L.setOptions(this,t);var i=L.DomUtil.get(e);L.DomEvent.on(i,"click",function(e){L.DomEvent.stopPropagation(e)}),i.parentNode.removeChild(i);var n=L.DomUtil.create("div","top-menu",i);this._contentContainer=L.DomUtil.create("div","sidebar-content",i),this.on("hide",this._removeContent,this);var r=this._container=L.DomUtil.create("div","leaflet-sidebar knreise-sidebar "+this.options.position);if(this.options.closeButton){(this._closeButton=L.DomUtil.create("a","close pull-right",n)).innerHTML="&times;"}this._top=L.DomUtil.create("span","",n),L.DomUtil.addClass(i,"leaflet-control"),r.appendChild(i),this.on("hide",function(){this._map&&(this._map.fire("layerSelected"),this._map.fire("layerDeselect"))},this),this.sidebar=new KR.SidebarContent(this._container,this._contentContainer,this._top,this.options,this._map)},addTo:function(e){return this.sidebar.setMap(e),L.Control.Sidebar.prototype.addTo.apply(this,arguments)},showFeature:function(e,t,i,n,r){if(this.show(),this.sidebar.showFeature(e,t,t.getFeatureData,i,n,r),KR.UrlFunctions){var a=$("<div></div>"),o={id:e.id,url:KR.UrlFunctions.getFeatureLink(e),provider:t.provider};t.feedbackForm&&($(this._contentContainer).append(a),KR.ResponseForm(a,o)),e.id&&this.options.featureHash&&KR.UrlFunctions.setFeatureHash(e.id)}},showFeatures:function(e,t,i){this.show(),this.sidebar.showFeatures(e,t,t.getFeatureData,t.noListThreshold,i)},_removeContent:function(){$(this.getContainer()).html(""),KR.UrlFunctions&&KR.UrlFunctions.setFeatureHash()}}),L.Knreise.Control.sidebar=function(e,t){return new L.Knreise.Control.Sidebar(e,t)};(KR=this.KR||{}).UrlFunctions={},function(e){"use strict";e.setupLocationUrl=function(e){var t=function(){try{var t=e.getCenter()}catch(e){return}var i=KR.Util.getPositionHash(t.lat,t.lng,e.getZoom()),n=window.location.hash.split(":");if(n.length>1){i+=":"+_.rest(n).join(":")}window.location.hash=i};e.on("moveend",t),t()},e.getLocationUrl=function(){var e=window.location.hash;if(e&&""!==e&&1!==e.indexOf(":")){var t=e.replace("#","").split("/"),i=parseInt(t[0],10);return{lat:parseFloat(t[1]),lon:parseFloat(t[2]),zoom:i}}},e.getHashFeature=function(){var e=window.location.hash.split(":");if(e.length>1)return _.rest(e).join(":")},e.setFeatureHash=function(e){var t=window.location.hash.split(":")[0];window.location.hash=e?t+":"+encodeURIComponent(e):t},e.getFeatureLink=function(e){var t=window.location.href.replace(window.location.hash,""),i=e.geometry.coordinates,n=t+KR.Util.getPositionHash(i[1],i[0],16);return e.id&&(n=n+":"+encodeURIComponent(e.id)),n}}(KR.UrlFunctions);(KR=this.KR||{}).MediaCarousel={},function(e){"use strict";function t(e,t){_.isUndefined(e.fullsize)||(t.attr("data-fullsize-url",e.fullsize),t.parent().addClass("image-fullscreen-link"))}function i(e){if(_.has(n,e.type)){var t=n[e.type](e);return t.attr("data-type",e.type),t.attr("data-created",!0),t}}var n={image:function(e){var i=e.url,n=$('<img data-type="image" class="fullwidth img-thumbnail" src="'+i+'" />');return t(e,n),n},video:function(e){var t=e.url;return-1!==t.indexOf("mp4")?$('<video data-type="video" class="video-js vjs-default-skin fullwidth" controls preload="auto" height="315" data-setup="{}"><source src="'+t+'" type="video/mp4"></video>'):$('<iframe data-type="video" class="fullwidth" height="315" src="'+t+'" frameborder="0" allowfullscreen></iframe>')},sound:function(e){var t=e.url;return $('<audio data-type="sound" src="'+t+'" preload="auto"></audio>')},captioned_image:function(e){var i=$('<div class="image with-caption"></div>'),n=$('<img class="thumbnail fullwidth" src="'+e.url+'" />');return i.append(n),t(e,n),i.append("<p>"+e.caption+' (<a href="'+e.license+'" target="_blank">Lisens</a>)</p>'),i}};e.SetupMediaCarousel=function(e,t){function n(n){r=e.find(".media-list").children();var o=$(r[n]);if(r.addClass("hidden"),o.attr("data-created")||o.hasClass("audiojs"))o.removeClass("hidden");else{var s={type:o.attr("data-type"),url:o.attr("data-src")},l=i(s=_.extend(s,function(e){var t={},i=/^data-own\-(.+)$/;return $.each(e.get(0).attributes,function(e,n){if(i.test(n.nodeName)){var r=n.nodeName.match(i)[1];t[r]=n.nodeValue}}),t}(o)));o.replaceWith(l),t&&t(l),l.is("audio")&&audiojs.create(l)}a.hasPrev()?e.find(".prev").addClass("active"):e.find(".prev").removeClass("active"),a.hasNext()?e.find(".next").addClass("active"):e.find(".next").removeClass("active")}var r=e.find(".media-list").children(),a=new function(e,t){t=t||0;var i=function(){return t<e-1},n=function(){return t>0};return{prev:function(){return n()?--t:t},next:function(){return i()?++t:t},hasNext:i,hasPrev:n}}(r.length);e.find(".next").on("click",function(){a.hasNext()&&n(a.next())}),e.find(".prev").on("click",function(){a.hasPrev()&&n(a.prev())})},e.CreateMediaListMarkup=function(e){var t=$('<div class="media-container"></div>'),n=$('<div class="media-list"></div>');return n.append(_.map(e,function(e,t){return 0===t?i(e):function(e){var t=$('<div class="hidden"> </div>').attr("data-src",e.url).attr("data-type",e.type);return _.each(e,function(e,i){t.attr("data-own-"+i,e)}),t}(e)})),t.append(n),e.length>1&&t.append($('<div class="media-navigation"><a class="prev circle"><span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span></a><a class="next circle active"><span class="glyphicon glyphicon-chevron-right" aria-hidden="true"></span></a></div>')),t[0].outerHTML}}(KR.MediaCarousel);var KR=this.KR||{};!function(){"use strict";function e(){function e(){if(i&&t&&t.userPosition&&n){r&&r.remove();var e=i.find("h3").eq(0),o=function(e){if(t&&t.userPosition){var i=turf.point([t.userPosition.lng,t.userPosition.lat]),n=KR.Util.distanceAndBearing(i,e),r=n.distance;return r=r<1e3?KR.Util.round(r,0)+" Meter":KR.Util.round(r/1e3,2)+" Kilometer",{dist:r,rot:n.bearing-45}}}(n);r=$(a({distanceBearing:o})),e.length?e.after(r):i.prepend(r)}}var t,i,n,r,a=_.template($("#user_position_template").html());return{setMap:function(i){(t=i).on("locationChange",e)},selectFeature:function(t,r){i=r,n=t,e()}}}KR.SidebarContent=function(t,i,n,r){function a(e){i.html(e)}function o(e,t,i,n,a,s){var c;t>0&&(c=function(r){r&&r.preventDefault();var u=o(e=a[t-=1],t,i,n,a,s);l(e,i,n,u,t,a.length)});var d;return t<a.length-1&&(d=function(r){r&&r.preventDefault();var u=o(e=a[t+=1],t,i,n,a,s);l(e,i,n,u,t,a.length)}),s||(s=function(){u(a,i,n,r.noListThreshold,!0)}),{prev:c,close:s,next:d}}function s(e){e.find('img[data-fullsize-url!=""]').click(function(){var e=$(this).attr("data-fullsize-url");e&&$("#overlay").removeClass("hidden").html($('<img src="'+e+'" />')).click(function(){$("#overlay").addClass("hidden").html("")})})}function l(e,o,u,d,f,p){var m=o.template;if(u){var h="";return e.properties.title&&(h+="<h3>"+e.properties.title+"</h3>"),h+='<i class="fa fa-spinner fa-pulse fa-3x"></i>',a(h),void u(e,function(t){t.properties=_.extend(e.properties,t.properties),l(t,o,null,d,f,p)})}var g=e.properties.images;_.isArray(g)&&(g=g[0]),e.properties.images||(e.properties.images=null),e.properties.allProps&&e.properties.allProps.europeana_rights?e.properties.license=e.properties.allProps.europeana_rights[0]:e.properties.license=e.properties.license;h='<span class="providertext" style="color:'+o.style.fillcolor+';">'+e.properties.provider+"</span>";if(h+=m(_.extend({image:null},e.properties)),r.footerTemplate&&e.properties.link&&(h+=r.footerTemplate(e.properties)),h=$(["<div>",h,"</div>"].join(" ")),KR.Util.isInIframe()&&h.find("a").attr("target","_blank"),c.selectFeature(e,h),a(h),function(e){e&&i.swipe({swipe:function(){},allowPageScroll:"vertical"}).off("swipeLeft").on("swipeLeft",function(){e.next&&e.next()}).off("swipeRight").on("swipeRight",function(){e.prev&&e.prev()})}(d),t.find(".prev-next-arrows").remove(),n.html(""),d){var v=$('<a class="pull-left list-btn"><i class="fa fa-bars"></i></a>');n.append(v),v.click(d.close);var y=f+1;n.append($('<div class="top-text pull-left"><b>'+y+"</b> av "+p+"</div>"));var k=$('<a class="prev-next-arrows prev circle"><span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span></a>');t.append(k),d.prev&&k.click(d.prev).addClass("active");var L=$('<a class="prev-next-arrows next circle"><span class="glyphicon glyphicon-chevron-right" aria-hidden="true"></span></a>');t.append(L),d.next&&L.click(d.next).addClass("active"),t.append($('<div id="overlay" class="hidden"></div>'))}s(t);var b=i.find(".media-container");b.length&&KR.MediaCarousel.SetupMediaCarousel(b,s),"undefined"!=typeof audiojs&&audiojs.createAll(),i.scrollTop(0)}function u(e,t,a,s,u){s=void 0===s?r.noListThreshold:s;if(e.length<=s&&!0!==u){var c=e[0];i.html("");var d=o(c,0,t,a,e);this.showFeature(c,t,a,d,0,e.length)}else{var f=$('<span class="circle">'+e.length+"</span>");n.html(f);var p=_.chain(e).groupBy(function(e){return e.properties.provider}).map(function(i,n){var s=$("<div></div>"),u=$('<div class="list-group"></ul>'),c=_.map(i,function(i){var n=_.findIndex(e,function(e){return e===i});return function(e,t,i,n,a){var s,u=KR.Style.colorForFeature(e,!0);s=e.properties.thumbnail?r.thumbnailTemplate({thumbnail:KR.Util.getImageCache(e.properties.thumbnail,80,60),thumbnail2x:KR.Util.getImageCache(e.properties.thumbnail,120,90),color:u}):r.markerTemplate({icon:"",color:u});var c=$(r.listElementTemplate({title:e.properties.title,marker:s}));return c.on("click",function(r){r.preventDefault();var s=o(e,t,i,n,a);return l(e,i,n,s,t,a.length),!1}),c}(i,n,t,a,e)},this);return u.append(c),s.append('<h5 class="providertext">'+n+"</h5>"),s.append(u),s}).value();i.html(p),i.scrollTop(0)}}var c=new e;return i=$(i),t=$(t),n=$(n),{showFeature:l,showFeatures:u,setMap:function(e){c.setMap(e)}}}}(),function(){"use strict";L.Knreise=L.Knreise||{},L.Knreise.Control=L.Knreise.Control||{},L.Control.Datasets2=L.Control.extend({initialize:function(e,t){L.setOptions(this,t),this.loader=e,this.numLoading=0,e.onLoadStart(_.bind(function(e){this.numLoading+=1,this._update()},this)),e.onLoadEnd(_.bind(function(e){this.numLoading-=1,this._update()},this)),e.onEnabledChange(_.bind(function(e){this._update()},this)),e.onAvailableChange(_.bind(function(e){this._update()},this))},onAdd:function(e){return this._map=e,this._initLayout(),this._update(),this._container},_checkSpinner:function(){this._btnIcon&&(0===this.numLoading?this._btnIcon.className=this._btnIcon.className.replace(" fa-spinner fa-pulse"," fa-bars"):(this._errorIcon.className.indexOf("hidden")<0&&(this._errorIcon.className+=" hidden"),this._btnIcon.className=this._btnIcon.className.replace(" fa-bars"," fa-spinner fa-pulse")))},_update:function(){if(this._container){this._checkSpinner();var e=document.createDocumentFragment();for(_.each(this.loader.getLayers(),function(t){var i=function(e){var t=document.createElement("label");e.isAvailable||(t.className="disabled");var i=document.createElement("i");i.className="layericon fa",e.isEnabled?i.className+=" fa-check-square-o":i.className+=" fa-square-o",e.isLoading&&(i.className="layericon fa fa-spinner fa-pulse"),e.isAvailable?i.style.color=e.style.fillcolor:i.style.color="#ddd",t.appendChild(i);var n=document.createElement("span");return n.innerHTML=" "+e.name,t.appendChild(n),t}(t);e.appendChild(i),i.addEventListener("click",_.bind(function(e){this.loader.toggleEnabled(t._id)},this))},this);this._overlaysList.firstChild;){var t=this._overlaysList.firstChild;this._overlaysList.removeChild(t)}this._overlaysList.appendChild(e)}},_initLayout:function(){var e="leaflet-control-layers";this._container=L.DomUtil.create("div",""),this._container.setAttribute("aria-haspopup",!0),L.Browser.touch?L.DomEvent.on(this._container,"click",L.DomEvent.stopPropagation):L.DomEvent.disableClickPropagation(this._container).disableScrollPropagation(this._container),this._form=L.DomUtil.create("form",e+"-list"),this._map.on("click",this._collapse,this),this._overlaysList=L.DomUtil.create("div",e+"-overlays",this._form),this._closeDiv=L.DomUtil.create("div","clearfix");var t=L.DomUtil.create("button","btn btn-default pull-right",this._closeDiv);t.title="Kartlag",L.DomEvent.on(t,"click",function(){this._toggle()},this),this._errorIcon=L.DomUtil.create("i","error-icon fa fa-exclamation-triangle hidden",t),t.appendChild(document.createTextNode(" ")),this.numLoading>0?this._btnIcon=L.DomUtil.create("i","fa fa-spinner fa-pulse",t):this._btnIcon=L.DomUtil.create("i","fa fa-bars",t),this._container.appendChild(this._closeDiv),this._listContainer=L.DomUtil.create("div",e+" hidden"),this._listContainer.appendChild(this._form),this._container.appendChild(this._listContainer)},_toggle:function(){this.expanded?this._collapse():this._expand()},_expand:function(){L.DomUtil.addClass(this._listContainer,"leaflet-control-layers-expanded"),this.expanded=!0,this._listContainer.className=this._listContainer.className.replace(" hidden","")},_collapse:function(){this._listContainer.className=this._listContainer.className.replace(" leaflet-control-layers-expanded",""),L.DomUtil.addClass(this._listContainer,"hidden"),this.expanded=!1}}),L.control.datasets2=function(e,t){return new L.Control.Datasets2(e,t)}}(),L.Knreise=L.Knreise||{},L.Knreise.Icon=L.KNreiseMarkers.Icon.extend({options:{icon:null}}),L.Knreise.icon=function(e){return new L.Knreise.Icon(e)};(KR=this.KR||{}).DatasetLoader=function(e,t,i,n,r,a){"use strict";function o(e,t){var i={dataset:t,onEachFeature:function(e,i){m&&m(e,i,t)}};return t.style&&(i.style=t.style),L.Knreise.geoJson(e,i)}function s(e,t){e.clearLayers();var i=_.reduce(t,function(e,t){return e.concat(t.toGeoJSON().features)},[]);e.addData(KR.Util.createFeatureCollection(i)),e.fire("dataAdded")}function l(e,t){e.enabled!==t&&(e.enabled=t,e.fire("changeEnabled"))}function u(e){if(e.datasets&&!e.grouped){return _.filter(e.datasets,function(e){return e.visible}).length>0}return e.visible}function c(e,i){e.init&&e.init(t,e,i)}function d(i,d,f,m,h){function g(e,t){if(i.minFeatures){if(e.numFound&&i.minFeatures<e.numFound)return l(t,!1),KR.Util.createFeatureCollection([]);l(t,!0)}return e}var v=function(e,t){var i;r?i=o(null,e):e.cluster?(i=new L.Knreise.MarkerClusterGroup({dataset:e,maxClusterRadius:a,unclusterCount:e.unclusterCount}).addTo(t),p&&p(i,e)):i=o(null,e).addTo(t);var n=!0;return e.minFeatures&&(n=!1),i.enabled=n,i}(i,t);i.datasets?(i.datasets=_.filter(i.datasets,function(e){return!e.noLoad}),_.each(i.datasets,function(e){c(e,v)})):c(i,v);var y,k=function(a,l,c,f){var p=!a,m=l||t.getBounds().toBBoxString(),k=c||function(e){return e.minZoom?!(t.getZoom()<e.minZoom)&&u(e):u(e)}(i);if(h&&m){var b=L.latLngBounds.fromBBoxString(m);L.latLngBounds.fromBBoxString(h).intersects(b)||(k=!1)}if(v.enabled=function(e){return!(e.minZoom&&t.getZoom()<e.minZoom)}(i),v.fire("changeEnabled"),v.shouldLoad=k,!k)return v.clearLayers(),void(f&&f([]));var C;C=i.datasets?_.filter(i.datasets,function(e){return e.visible}):[i];var K=[],S=_.after(C.length,function(){r?s(v,K):i.cluster?function(e,i){e.clearLayers();var n=_.reduce(i,function(e,i){return i.setMap&&i.setMap(t),e.concat(i.getLayers())},[]);e.addLayers(n)}(v,K):s(v,K),v.isLoading=!1,v.fire("dataloadend"),f&&f(K)});v.isLoading=!0,v.fire("dataloadstart"),_.each(C,function(t){function i(e){t.geoJson=e,v.error=null,d&&(e=d(e));var i;r?i=L.geoJson(s(g(e,v))):t.cluster?(i=o(s(g(e,v)),t),t.geoJSONLayer=i):i=L.geoJson(s(g(e,v))),K.push(i),S()}function a(e){v.error=e,S(),"abort"!==e.statusText&&(n?n({dataset:t.name,error:e,layer:v}):v.fire("error",e))}var s=function(e){var t=KR.Util.stamp(e);return function(i){return i&&i.features.length?(_.each(i.features,function(i){i.properties.datasetID=t,_.has(e,"circle")&&(i.properties.circle=e.circle),_.has(e,"provider")&&(i.properties.provider=e.provider),_.has(e,"extras")&&(i.properties=_.extend(i.properties,e.extras)),i.properties.feedbackForm=e.feedbackForm,_.has(e,"mappings")&&_.each(e.mappings,function(e,t){i.properties[t]=i.properties[e]}),i.template=KR.Util.getTemplateForFeature(i,e)}),i):i}}(t);if(!p&&t.isStatic||y===m)i(t.geoJson);else if(t.bbox){var l=m;t.isStatic&&t.fixedBbox&&(l=t.fixedBbox),t.bboxFunc?t.bboxFunc(e,t.dataset,l,i,a):e.getBbox(t.dataset,l,i,a)}else e.getData(t.dataset,i,a)}),y=m};return k(null,f,void 0,function(e){!function(e){var i=[];e.datasets?i=e.datasets:i.push(e),_.each(i,function(e){if(e.loadWhenLessThan){var i=function(){if(e.geoJson){var i=turf.bboxPolygon(KR.Util.splitBbox(t.getBounds().toBBoxString())),n=_.filter(e.geoJson.features,function(e){return turf.inside(e,i)});n.length<=e.loadWhenLessThan.count?e.loadWhenLessThan.callback(t,e,n):e.loadWhenLessThan.callback(t,e)}};t.on("moveend",i),i()}})}(i),m&&m(e)}),function(e){return e.datasets?0===_.filter(e.datasets,function(e){return!1===e.isStatic}).length:e.isStatic}(i)&&!i.minZoom||t.on("moveend",k),function(e,t){e.on("hide",function(){t(!0)}),e.on("show",function(){t(!0)})}(v,k),{layer:v,reload:k}}function f(e){var t=KR.Util.getDatasetId(e);e.extras=e.extras||{},e.extras.datasetId=t,e.style&&KR.Style.setDatasetStyle(t,e.style)}a=a||80;var p,m,h=[],g={isStatic:!0,bbox:!0,cluster:!0,visible:!0};return i&&(p=KR.Util.clusterClick(i),m=KR.Util.featureClick(i)),{loadDatasets:function(e,i,n,o,s){e=_.filter(e,function(e){return!e.noLoad});var l;if(o){var u=[],c=_.after(e.length,function(){o(u)});l=function(e){u.push(e),c()}}var m=_.map(e,function(e){return(e=_.extend({},g,e)).datasets&&function(e){var t=_.reduce(_.without(_.keys(e),"datasets"),function(t,i){return"style"!==i&&(t[i]=e[i]),t},{});if(e.style){t.extras=t.extras||{};var i=KR.Util.stamp(e);t.extras.groupId=i,KR.Style.groups[i]=e.style}e.datasets=_.map(e.datasets,function(e){return _.extend({},t,e)})}(e),KR.Style.setDatasetStyle&&(e.datasets?_.each(e.datasets,f):f(e)),e.visible||(e.notLoaded=!0),e.minZoom&&e.bbox&&(e.isStatic=!1),d(e,n,i,l,s)});h=_.pluck(m,"reload");var v=_.pluck(m,"layer");return r&&function(e){var i={},n=function(){_.each(e,function(e){e.deselectAllNew()})};t.on("layerDeselect",n);var r=new L.Knreise.MarkerClusterGroup({maxClusterRadius:a}).addTo(t);r.on("clusterclick",n),p(r),_.each(e,function(t){t.on("dataAdded",function(){var a=L.stamp(t);i[a]&&r.removeLayers(i[a]);var o=t.getLayers();i[a]=o,r.addLayers(o),t.on("hide",function(){i[a]&&r.removeLayers(i[a])}),t.on("click",function(t){n();var i=t.layer;_.find(e,function(e){return!!_.find(e.getLayers(),function(e){return e===i})}).setLayerSelected(i)})})})}(v),v},reload:function(e,t){var i=_.after(h.length,function(){t&&t()});_.each(h,function(t){t(null,null,e,i)})}}},L.Knreise=L.Knreise||{},function(e){"use strict";L.Control.EasyButtons2=L.Control.EasyButtons.extend({_addImage:function(){var e=0===this.options.icon.lastIndexOf("fa",0)?" fa fa-lg":" glyphicon";this._icon=L.DomUtil.create("i",this.options.icon+e,this.link),this.options.id&&(this._icon.id=this.options.id)},changeIcon:function(e){var t=0===this.options.icon.lastIndexOf("fa",0)?" fa fa-lg":" glyphicon";this._icon.className=e+t}}),e.LocateButton=function(e,t,i){function n(t){var n=L.latLng(t.coords.latitude,t.coords.longitude);if(c.changeIcon(p),i.bounds&&!i.bounds.contains(n))return m("warning","Du befinner deg utenfor området til denne demonstratoren. Viser ikke din posisjon"),u.fire("locationError"),void a();u.userPosition=n,u.fire("locationChange"),e?e(n):(u.setView(n,16),l?l.setLatLng(n):(l=function(e){return new cilogi.L.Marker(e,{fontIconSize:3,fontIconName:"",altIconName:"",fontIconColor:"#FF0000",fontIconFont:"awesome",opacity:1})}(n),u.addLayer(l)))}function r(){u.fire("locationError"),c.changeIcon(p),c.getContainer().className=c.getContainer().className.replace(" active","")}function a(){f=!1,_.isUndefined(d)||(navigator.geolocation.clearWatch(d),c.getContainer().className=c.getContainer().className.replace(" active",""),u.removeLayer(l),l=void 0,d=void 0)}function o(){f=!0,navigator.geolocation?(c.changeIcon("fa-spinner fa-pulse"),c.getContainer().className+=" active",d=navigator.geolocation.watchPosition(n,r)):t&&t()}function s(){f?a():o()}(i=i||{}).zoom=i.zoom||10;var l,u,c,d,f=!1,p=i.icon||"fa-user",m=KR.Util.messageDisplayer($("#message_template").html());return{addTo:function(e){var t=i.title||"Følg min posisjon";return u=e,c=new L.Control.EasyButtons2(s,{icon:p,title:t}),u.addControl(c),c},getLocation:o}}}(L.Knreise);KR=this.KR||{};L.TileLayer.WMTS=L.TileLayer.extend({defaultWmtsParams:{service:"WMTS",request:"GetTile",version:"1.0.0",layer:"",style:"",tilematrixSet:"",format:"image/jpeg"},initialize:function(e,t){this._url=e;var i=L.extend({},this.defaultWmtsParams),n=t.tileSize||this.options.tileSize;i.width=i.height=t.detectRetina&&L.Browser.retina?2*n:n;for(var r in t)this.options.hasOwnProperty(r)||"matrixIds"==r||(i[r]=t[r]);this.wmtsParams=i,this.matrixIds=t.matrixIds||this.getDefaultMatrix(),L.setOptions(this,t)},onAdd:function(e){L.TileLayer.prototype.onAdd.call(this,e)},getTileUrl:function(e,t){var i=this._map;return crs=i.options.crs,tileSize=this.options.tileSize,nwPoint=e.multiplyBy(tileSize),nwPoint.x+=1,nwPoint.y-=1,sePoint=nwPoint.add(new L.Point(tileSize,tileSize)),nw=crs.project(i.unproject(nwPoint,t)),se=crs.project(i.unproject(sePoint,t)),tilewidth=se.x-nw.x,t=i.getZoom(),ident=this.matrixIds[t].identifier,X0=this.matrixIds[t].topLeftCorner.lng,Y0=this.matrixIds[t].topLeftCorner.lat,tilecol=Math.floor((nw.x-X0)/tilewidth),tilerow=-Math.floor((nw.y-Y0)/tilewidth),url=L.Util.template(this._url,{s:this._getSubdomain(e)}),url+L.Util.getParamString(this.wmtsParams,url)+"&tilematrix="+ident+"&tilerow="+tilerow+"&tilecol="+tilecol},setParams:function(e,t){return L.extend(this.wmtsParams,e),t||this.redraw(),this},getDefaultMatrix:function(){for(var e=new Array(22),t=0;22>t;t++)e[t]={identifier:""+t,topLeftCorner:new L.LatLng(20037508.3428,-20037508.3428)};return e}}),L.tileLayer.wmts=function(e,t){return new L.TileLayer.WMTS(e,t)},function(e){"use strict";e.SKTokenUrl="http://localhost:8001/html/baat/?type=token",e.getNibLayer=function(t,i){e.Util.sendRequest(KR.SKTokenUrl,null,function(e){var n;if(i)n=L.tileLayer.wms("http://gatekeeper2.geonorge.no/BaatGatekeeper/gk/gk.nibcache",{layers:"NiB",format:"image/jpeg",transparent:!1,attribution:"Kartverket"});else{n=new L.TileLayer.WMTS("http://gatekeeper1.geonorge.no/BaatGatekeeper/gk/gk.nibcache_wmts",{layer:"NiB",style:"normal",tilematrixSet:"EPSG:900913",matrixIds:function(e){var t,i=new Array(30);for(t=0;t<22;t++)i[t]={identifier:e+":"+t,topLeftCorner:new L.LatLng(20037508,-20037508.34)};return i}("EPSG:900913"),format:"image/jpeg",attribution:"Kartverket"})}n.setParams({GKT:e}),t(n)})}}(KR);(KR=this.KR||{}).Config=KR.Config||{},function(e){"use strict";KR.Config.getKulturminneFunctions=function(e){var t,i,n,r,a,o,s,l,u=!0,c=function(e){return _.find(n.getLayers(),function(t){return t.feature.properties.id===e})},d=function(e){return _.find(a.getLayers(),function(t){return t.feature.properties.lok===e})},f=function(e){return L.geoJson(null,{onEachFeature:function(t,n){e.extras&&e.extras.groupId?n.setStyle(KR.Style.getPathStyleForGroup(e.extras.groupId)):(t.properties.datasetId=e.id,n.setStyle(KR.Style.getPathStyle(t,!0))),n.on("click",function(){!function(e){var t=c(e.properties.lok);if(t)t.fire("click");else if(r.sidebar){var n=_.find(l,function(t){return t.feature.properties.id===e.properties.lok});m(d(e.properties.lok)),r.sidebar.showFeature(n.feature,i.template,i.getFeatureData)}}(t)})}}).addTo(r)},p=function(){t=null,_.each(a.getLayers(),function(e){e.setStyle(KR.Style.getPathStyle(e.feature,!0))})},m=function(e){e.setStyle({weight:1,color:"#436978",fillColor:"#72B026",clickable:!0,opacity:.8,fillOpacity:.4})},h=function(e){p();var i=e.layer.feature.properties.id;t=i;var n=d(i);n&&(m(n),o&&o(e.layer.feature))},g=function(t){_.has(t,"enkeltminner")||(t.enkeltminner={});var i=t.enkeltminner.style||{color:"#fff",weight:1,fillColor:"#B942D0"};s=L.geoJson(null,{onEachFeature:function(e,i){e.properties.provider=t.enkeltminner.provider||"Enkeltminne",e.properties.color=t.enkeltminner.sidebarColor||"#B942D0",i.on("click",function(){!function(e,t){r.sidebar&&r.sidebar.showFeature(e,t.enkeltminner.template||KR.Util.getDatasetTemplate("ra_enkeltminne"))}(e,t)})},style:function(){return i}}).addTo(r),o=function(t){var i={api:"kulturminnedataSparql",type:"enkeltminner",lokalitet:t.properties.id};e.getData(i,function(e){s.clearLayers(),s.addData(e)})}},v=function(e){a.clearLayers().addData(e),t&&(function(e){var t=d(e);t&&m(t)}(t),function(e){var t=c(e);t&&t.fire("click")}(t))},y=function(t){t.prevLayers&&t.prevLayers.length&&(l=t.prevLayers);var i=n.getUnclustredLayers(),r=_.map(i,function(e){return e.feature.properties.id}),o=[];if(n.isUnclustred&&(o=_.chain(a.getLayers()).map(function(e){return e.feature.properties.lok}).difference(r).value()),(r=r.concat(o)).length){var u={api:"kulturminnedataSparql",type:"lokalitetpoly",lokalitet:r};e.getData(u,v)}else a.clearLayers(),s&&s.clearLayers()};return{initKulturminnePoly:function(e,t,o){i=t,n=o,r=e,a=f(t),n.on("dataloaded",y),n.on("click",h),r.on("layerDeselect",p),_.has(t,"showEnkeltminner")&&(u=t.showEnkeltminner),u&&g(t)},getRaFeatureData:function(t,i){var n={api:"kulturminnedataSparql",type:"images",lokalitet:t.properties.id};e.getData(n,function(e){e=_.map(e,function(e){return{type:"captioned_image",url:e.img,caption:e.picturelabel+" - "+e.picturedescription,license:e.picturelicence,fullsize:e.img_fullsize}}),t.properties.media=e,i(t)})}}}}();(KR=this.KR||{}).Config=KR.Config||{},function(e){"use strict";e.getDatasetList=function(t){var i=e.getKulturminneFunctions(t);return{difo:{name:"Digitalt fortalt",dataset:{dataset:"difo",api:"norvegiana"},cluster:!0,template:KR.Util.getDatasetTemplate("digitalt_fortalt"),noListThreshold:1/0,description:"Kulturrådets tjeneste for personlige fortellinger fra kulturinstitusjoner og privatpersoner.",allowTopic:!0,feedbackForm:!0,isStatic:!1,style:{fillcolor:"#F69730",circle:!1,thumbnail:!0}},verneomr:{id:"verneomraader",dataset:{api:"cartodb",table:"naturvernomrader_utm33_2",columns:["iid","omradenavn","vernef_id","verneform"]},provider:"Naturbase",name:"Verneområder",template:KR.Util.getDatasetTemplate("verneomraader"),getFeatureData:function(e,t){console.log("NO API in datasets.js"),t()},toPoint:{showAlways:!0,stopPolyClick:!0,minSize:20},minZoom:10,cluster:!1,description:"Nasjonalparker og andre naturvernområder - ca. 2700 i hele landet."},artobs:{name:"Artsobservasjoner",hideFromGenerator:!0,dataset:{api:"norvegiana",dataset:"Artsdatabanken"},cluster:!1,description:"Artsobservasjoner fra Artsdatabanken",template:KR.Util.getDatasetTemplate("popup")},folketelling:{name:"Folketelling 1910",provider:"Folketelling 1910",dataset:{api:"folketelling",dataset:"property"},isStatic:!1,minZoom:14,template:KR.Util.getDatasetTemplate("folketelling"),getFeatureData:function(e,t){console.log("NO API in datasets.js"),t()},mappings:{title:"gaardsnavn_gateadr"},noListThreshold:0,description:"Personer og eiendommer fra folketellingen 1910"},ark_hist:{grouped:!0,name:"Arkeologi og historie",minZoom:14,datasets:[{name:"MUSIT",provider:"Universitetsmuseene",dataset:{api:"norvegiana",dataset:"MUSIT"},template:KR.Util.getDatasetTemplate("musit")},{name:"DiMu",dataset:{api:"norvegiana",dataset:"DiMu"},template:KR.Util.getDatasetTemplate("digitalt_museum"),isStatic:!1},{id:"riksantikvaren",name:"Riksantikvaren",provider:"Riksantikvaren",dataset:{api:"kulturminnedataSparql",kommune:null,fylke:null},getFeatureData:i.getRaFeatureData,template:KR.Util.getDatasetTemplate("ra_sparql"),bbox:!1,isStatic:!1,unclusterCount:20,init:i.initKulturminnePoly}],description:"Data fra Universitetsmuseene, Digitalt museum og Riksantikvaren"},jernbane:{id:"jernbane",dataset:{api:"jernbanemuseet"},provider:"Jernbanemuseet",name:"Jernbanemuseet",hideFromGenerator:!0,template:KR.Util.getDatasetTemplate("jernbanemuseet"),getFeatureData:function(e,t){console.log("NO API in datasets.js"),t()},isStatic:!0,bbox:!1,description:"Jernbanemuseet"},arkeologi:{grouped:!0,name:"Arkeologi",minZoom:14,style:{fillcolor:"#436978",circle:!1,thumbnail:!0},datasets:[{name:"MUSIT",provider:"Universitetsmuseene",dataset:{api:"norvegiana",dataset:"MUSIT"},template:KR.Util.getDatasetTemplate("musit")}],description:"Arkeologidata fra Universitetsmuseene og Riksantikvaren"},historie:{grouped:!0,name:"Historie",minZoom:14,style:{fillcolor:"#D252B9",circle:!1,thumbnail:!0},datasets:[{name:"DiMu",dataset:{api:"norvegiana",dataset:"DiMu",query:"-dc_subject_facet:Kunst"},template:KR.Util.getDatasetTemplate("digitalt_museum"),isStatic:!1,bbox:!0,style:{fillcolor:"#436978",circle:!1,thumbnail:!1}},{dataset:{api:"norvegiana",dataset:"Industrimuseum"},isStatic:!1,bbox:!0},{dataset:{api:"norvegiana",dataset:"Foto-SF"},isStatic:!1,bbox:!1,template:KR.Util.getDatasetTemplate("foto_sf")},{dataset:{api:"norvegiana",dataset:"Kystreise"},isStatic:!0,bbox:!1}],description:"Historie og kulturminner fra Riksantikvaren og Digitalt museum "},kunst:{grouped:!0,name:"Kunst",style:{fillcolor:"#72B026",circle:!1,thumbnail:!0},datasets:[{name:"DiMu",dataset:{api:"norvegiana",dataset:"DiMu",query:"dc_subject_facet:Kunst"},template:KR.Util.getDatasetTemplate("digitalt_museum"),isStatic:!1,style:{fillcolor:"#436978",circle:!1,thumbnail:!1}}],description:"Kunstdata fra Digitalt museum "},wikipedia:{name:"Wikipedia",provider:"Wikipedia",dataset:{api:"wikipedia"},style:{thumbnail:!0},minZoom:13,template:KR.Util.getDatasetTemplate("wikipedia"),description:"Stedfestede artikler fra bokmålswikipedia",style:{fillcolor:"#D14020",thumbnail:!0}},wikipediaNN:{name:"Wikipedia Nynorsk",provider:"Wikipedia Nynorsk",dataset:{api:"wikipediaNN"},style:{thumbnail:!0},minZoom:13,template:KR.Util.getDatasetTemplate("wikipedia"),description:"Stedfestede artikler fra nynorskwikipedia",style:{fillcolor:"#D14020",thumbnail:!0}},lokalwiki:{id:"lokalwiki",name:"Lokalhistoriewiki",hideFromGenerator:!1,provider:"Lokalhistoriewiki",dataset:{api:"lokalhistoriewiki"},style:{thumbnail:!0},minZoom:13,bbox:!0,isStatic:!1,description:"Stedfestede artikler fra lokalhistoriewiki.no"},riksantikvaren:{id:"riksantikvaren",name:"Kulturminnesøk",hideFromGenerator:!1,provider:"Riksantikvaren",dataset:{api:"kulturminnedataSparql",kommune:null,fylke:null},getFeatureData:i.getRaFeatureData,template:KR.Util.getDatasetTemplate("ra_sparql"),bbox:!1,isStatic:!1,description:"Data fra Riksantikvarens kulturminnesøk",unclusterCount:20,init:i.initKulturminnePoly},brukerminner:{name:"Kulturminnesøk - brukerregistreringer",hideFromGenerator:!1,provider:"riksantikvaren",dataset:{api:"kulturminnedata",layer:2,getExtraData:!0,extraDataLayer:6,matchId:"KulturminnesokID"},cluster:!0,isStatic:!1,style:{thumbnail:!0},description:"Brukerregistrerte data fra Riksantikvarens kulturminnesøk",template:KR.Util.getDatasetTemplate("brukerminne"),style:{fillcolor:"#436978",circle:!1,thumbnail:!1}},groruddalen:{name:"Byantikvaren Oslo - Groruddalen",hideFromGenerator:!0,provider:"Byantikvaren i Oslo",dataset:{api:"cartodb",table:"byantikvaren_oslo_groruddalen"},bbox:!1,isStatic:!1,style:{thumbnail:!0},template:KR.Util.getDatasetTemplate("byantikvaren_oslo"),description:"Byantikvarens Groruddalsatlas"},norgerundt:{name:"Norge Rundt",hideFromGenerator:!0,provider:"NRK",dataset:{api:"cartodb",table:"nrk_norge_rundt"},bbox:!1,isStatic:!1,style:{thumbnail:!0},description:"Stedfestede innslag fra Norge Rundt"},dimu:{name:"Digitalt Museum",hideFromGenerator:!1,provider:"dimu",dataset:{dataset:"DiMu",api:"norvegiana"},cluster:!0,isStatic:!1,style:{thumbnail:!0},description:"Alle stedfestede data fra Digitalt Museum",allowTopic:!0,feedbackForm:!0},musit:{name:"Universitetsmuseene",hideFromGenerator:!1,provider:"Universitetsmuseene",dataset:{dataset:"MUSIT",api:"norvegiana"},cluster:!0,isStatic:!1,style:{thumbnail:!0},description:"Alle stedfestede data fra Universitetsmuseene",allowTopic:!0,feedbackForm:!0},industrimuseum:{name:"Industrimuseum",hideFromGenerator:!1,provider:"Industrimuseum",dataset:{dataset:"Industrimuseum",api:"norvegiana"},cluster:!0,isStatic:!1,style:{thumbnail:!0},description:"Alle stedfestede data fra Industrimuseum",allowTopic:!0,feedbackForm:!0},kystreise:{name:"Kystreise",hideFromGenerator:!1,provider:"Kystreise",dataset:{dataset:"Kystreise",api:"norvegiana"},cluster:!0,isStatic:!1,style:{thumbnail:!0},description:"Alle stedfestede data fra Kystreise",allowTopic:!0,feedbackForm:!0},dimufoto:{hideFromGenerator:!0,dataset:{api:"norvegiana",dataset:"DiMu",query:"europeana_type_facet:IMAGE"},template:KR.Util.getDatasetTemplate("digitalt_museum"),isStatic:!1,style:{thumbnail:!0},noListThreshold:1/0},kulturminnesok_flickr:{name:"Kulturminnesøk",dataset_name_override:"Kulturminnesøk",provider:"Kulturminnesøk Flickr",hideFromGenerator:!0,dataset:{api:"flickr",group_id:"1426230@N24"},template:KR.Util.getDatasetTemplate("flickr"),isStatic:!0,style:{thumbnail:!0},description:"Bilder fra Kulturminnesøks Flickr-gruppe"},riksarkivet:{name:"Riksarkivet",dataset_name_override:"Riksarkivet",provider:"riksarkivet",hideFromGenerator:!0,dataset:{api:"flickr",user_id:"national_archives_of_norway"},template:KR.Util.getDatasetTemplate("flickr"),isStatic:!1,style:{thumbnail:!0},description:"Bilder fra Riksarkivets Flickr-konto"},nasjonalbiblioteket:{name:"Nasjonalbiblioteket",dataset_name_override:"Nasjonalbiblioteket",provider:"nasjonalbiblioteket",hideFromGenerator:!0,dataset:{api:"flickr",user_id:"national_library_of_norway"},template:KR.Util.getDatasetTemplate("flickr"),isStatic:!1,style:{thumbnail:!0},description:"Bilder fra Nasjonalbibliotekets Flickr-konto"},oslobyarkiv:{name:"Oslo Byarkiv",dataset_name_override:"Oslo Byarkiv",provider:"oslobyarkiv",hideFromGenerator:!0,dataset:{api:"flickr",user_id:"byarkiv"},template:KR.Util.getDatasetTemplate("flickr"),isStatic:!1,style:{thumbnail:!0},description:"Bilder fra Oslo byarkiv sin Flickr-konto"},nasjonalmuseet:{name:"Nasjonalmuseet",dataset_name_override:"Nasjonalmuseet",provider:"nasjonalmuseet",hideFromGenerator:!0,dataset:{api:"flickr",user_id:"nasjonalmuseet"},template:KR.Util.getDatasetTemplate("flickr"),isStatic:!1,style:{thumbnail:!0},description:"Bilder fra Nasjonalmuseet sin Flickr-konto"},nve:{name:"NVE",dataset_name_override:"NVE",provider:"nve",hideFromGenerator:!0,dataset:{api:"flickr",user_id:"nve",accuracy:"6"},template:KR.Util.getDatasetTemplate("flickr"),isStatic:!1,style:{thumbnail:!0},description:"Bilder fra NVE Flickr-konto"},vestfoldmuseene:{name:"Vestfoldmuseene",dataset_name_override:"Vestfoldmuseene",provider:"Vestfoldmuseene",hideFromGenerator:!0,dataset:{api:"flickr",user_id:"vestfoldmuseene",accuracy:"1"},template:KR.Util.getDatasetTemplate("flickr"),isStatic:!1,style:{thumbnail:!0},description:"Bilder fra Vestfoldmuseene sin Flickr-konto"},perspektivet:{name:"Perspektivet Museum",dataset_name_override:"Perspektivet Museum",provider:"Perspektivet Museum",hideFromGenerator:!0,dataset:{api:"flickr",user_id:"perspektivetmuseum",accuracy:"1"},template:KR.Util.getDatasetTemplate("flickr"),isStatic:!1,style:{thumbnail:!0},description:"Bilder fra Perspektivet Museum sin Flickr-konto"}}},e.getDatasets=function(t){var i=e.getDatasetList();return _.chain(t).map(function(e){var t;if(e.indexOf(":")>-1){var n=e.split(":");e=n[0],t=n[1]}if(_.has(i,e)){var r=i[e];return t&&"norvegiana"===r.dataset.api&&(r.dataset.query="dc_subject_text:"+t),r}}).compact().value()}}(KR.Config);(KR=this.KR||{}).SplashScreen=function(e,t,i,n,r,a){"use strict";function o(){return window.location.href.replace(window.location.hash,"")}function s(){var e="remember_"+o()+"=",t=document.cookie.split("; "),i=_.find(t,function(t){return 0===t.indexOf(e)});if(i)return"true"===i.substring(e.length,i.length)}function l(e){document.cookie="remember_"+o()+"="+e}function u(){this._gray&&this._container.removeChild(this._gray),L.Control.Sidebar.prototype.hide.apply(this,arguments)}function c(){this._gray=L.DomUtil.create("div","gray",this._container),L.Control.Sidebar.prototype.show.apply(this,arguments)}var d=function(){L.DomUtil.create("div","",document.body).id="splashscreen";var o=L.control.sidebar("splashscreen",{position:"center",autoPan:!1});o.hide=_.bind(u,o),o.show=_.bind(c,o),e.addControl(o);var s=_.template($("#splashscreen_template").html()),l=$("<div>"+s({title:t,image:n,description:i,creator:r,spinner:!!a})+"</div>");return KR.Util.isInIframe()&&l.find("a").attr("target","_blank"),o.setContent(l.html()),o}();!function(t){L.easyButton(e,t,{position:"topright",icon:"fa-info-circle",title:"Om"})}(function(){d.isVisible()?d.hide():d.show()});var f=s();return f||(_.isUndefined(f)&&l(!0),d.show()),function(e){function t(){l(i.prop("checked"))}var i=$(e.getContainer()).find("#persist_splash_cb");i.prop("checked",s()),i.on("change",t),t()}(d),{finishedLoading:function(){var e=$(d.getContainer()).find("#splash_spinner");e&&e.remove()}}};(KR=this.KR||{}).ResponseForm=function(e,t){var i={message:"entry.126368279",email:"entry.748218122",id:"entry.2043404140",url:"entry.243673559",provider:"entry.826324496"},n="https://docs.google.com/forms/d/1ah66lattC8it7OTIM6de20NSNkBeiQ0vabpsHSaPU7s/formResponse",r=$("#response_form_template").html();e.append(r),e.find("form").on("submit",function(r){r.preventDefault();var a=e.find("#form_email").val(),o=e.find("#form_message").val();if(""===a||""===o)return!1;var s=_.extend({},t,{email:a,message:o});return function(e,t){var r=_.reduce(e,function(e,t,n){return e[i[n]]=t,e},{});$.ajax({url:n,data:r,type:"POST",dataType:"xml",success:t,error:t})}(s,function(){!function(t){e.find("form").addClass("hidden"),e.find("#form-success").removeClass("hidden").find(".media-body").text("Din melding er sendt til "+t+". De vil ta kontakt hvis de har behov for ytterligere informasjon")}(s.provider)}),!1}),e.find(".show-more").click(function(){e.find(".show-more").addClass("hidden"),e.find("form").removeClass("hidden")}),e.find(".close ").click(function(){e.find("#form_email").val(""),e.find("#form_message").val(""),e.find("#form-success").addClass("hidden"),e.find("form").addClass("hidden"),e.find(".show-more").removeClass("hidden")})};var DATASET_DEFAULTS={bbox:!0,cluster:!0,style:{fillcolor:"#38A9DC",circle:!1,thumbnail:!0}},Style=function(e){function t(t,a,o){if(o)return i(t,a);var s;return s=_.has(e,t)?e[t]:_.has(n,t)&&_.has(e,n[t])?e[n[t]]:r[t],_.isFunction(s)?s(a):s}function i(e,i){return _.has(a,e)?a[e]:t(e,i,!1)}var n={bordercolor:"fillcolor"},r={bordercolor:"#38A9DC",fillcolor:"#38A9DC",radius:9,clickable:!0,weight:2,fillOpacity:.2},a={bordercolor:"#72B026",fillcolor:"#72B026"};return{get:t,getSelected:i,isCircle:e.circle,isThumbnail:e.thumbnail}};!function(e){"use strict";function t(e,t){var i=KR.Util.createFeatureCollection(_.map(e.getLayers(),function(e){return e.toGeoJSON()}));return turf.buffer(i.features.length>5?function(e){var t=_.map(e.features,function(e){return turf.simplify(e,.01,!1)});return KR.Util.createFeatureCollection(t)}(i):i,t,"kilometers")}var i={geomFilter:!1,showGeom:!1,loactionHash:!0,featureHash:!0};e.setupMap=function(e,n,r,a){function o(e,t){l.showFeature(e,t)}r=function(e){return _.extend({},i,e||{})}(r);var s=KR.Util.createMap("map",r);!function(e){e.dragging.disable(),e.touchZoom.disable(),e.doubleClickZoom.disable(),e.scrollWheelZoom.disable(),e.keyboard.disable(),e.tap&&e.tap.disable()}(s),function(e,t){_.has(t,"extraLayers")&&_.isArray(t.extraLayers)&&_.each(t.extraLayers,function(t){e.addLayer(t)})}(s,r);(function(e,t){if(t.title)KR.SplashScreen(e,t.title,t.description,t.image,null,!1)})(s,r),function(e){var t=L.Knreise.LocateButton(null,null,{bounds:null});t.addTo(e)}(s);var l=KR.Util.setupSidebar(s,{featureHash:r.featureHash});return r.loactionHash&&KR.UrlFunctions.setupLocationUrl(s),function(e,t,i){var n=null,r=null;if(t.komm?(r=_.isString(t.komm)?t.komm.split(","):t.komm,n=function(t,i){var n={api:"cartodb",municipality:t};e.getData(n,function(e){var t=L.geoJson(e),n=t.getBounds();i(n,t)})}):t.fylke?(r=_.isString(t.fylke)?t.fylke.split(","):t.fylke,n=function(t,i){var n={api:"cartodb",county:t};e.getData(n,function(e){var t=L.geoJson(e),n=t.getBounds();i(n,t)})}):t.line&&(r=t.line,n=function(i,n){KR.Util.getLine(e,t.line,function(e){var i=L.geoJson(e,{color:t.linecolor?t.linecolor:"#03f",clickable:!1}),r=i.getBounds();n(r,i)})}),n&&r)n(r,function(e,t){var n=_.isString(e)?L.latLngBounds.fromBBoxString(e):e;i(null,n,t)});else if(t.bbox){var a=L.latLngBounds.fromBBoxString(t.bbox);i(null,a)}else i("Missing parameters!")}(e,r,function(i,a,l){i?alert(i):function(e,t,i){var n=KR.UrlFunctions.getLocationUrl(e);t.initUserPos?navigator.geolocation?navigator.geolocation.getCurrentPosition(function(e){var t={lat:e.coords.latitude,lon:e.coords.longitude,zoom:16};i(t)},function(){i(null)}):i(null):i(n)}(s,r,function(i){!function(e){e.dragging.enable(),e.touchZoom.enable(),e.doubleClickZoom.enable(),e.scrollWheelZoom.enable(),e.keyboard.enable(),e.tap&&e.tap.enable()}(s),i&&a.contains(L.latLng(i.lat,i.lon))?s.setView([i.lat,i.lon],i.zoom):s.fitBounds(a),s.setMaxBounds(a),s.options.minZoom=s.getBoundsZoom(a),l&&r.line&&l.addTo(s),l&&r.showGeom&&function(e,t){var i=_.reduce(t.getLayers(),function(e,t){return turf.erase(e,t.toGeoJSON())},KR.Util.WORLD);L.geoJson(i,{stroke:!1,fillColor:"#ddd",fillOpacity:.8}).addTo(e)}(s,l);var u;l&&r.buffer?u=t(l,r.buffer):r.geomFilter&&(u=function(e){return KR.Util.createFeatureCollection([L.polygon([e.getSouthWest(),e.getNorthWest(),e.getNorthEast(),e.getSouthEast(),e.getSouthWest()]).toGeoJSON()])}(a));var c=DatasetLoader(n,s,e,a,u),d=LayerManager(s,c,o);L.control.datasets2(c).addTo(s),d.init(),c.init()})}),s},e.setupMapFromUrl=function(t,i,n){e.setupMap(t,e.Config.getDatasets(i),n,!0)}}(KR=this.KR||{});(KR=this.KR||{}).setupCollectionMap=function(e,t,i){"use strict";var n={"Digitalt fortalt":KR.Util.getDatasetTemplate("digitalt_fortalt"),DigitaltMuseum:KR.Util.getDatasetTemplate("digitalt_museum"),Musit:KR.Util.getDatasetTemplate("musit"),Artsdatabanken:KR.Util.getDatasetTemplate("popup")};e.getCollection(t,function(e){var t=KR.Util.createMap("map",{layer:i});KR.SplashScreen(t,e.title,e.description,e.image,e.creator),$("title").append(e.title);var r=L.latLngBounds.fromBBoxArray(turf.extent(e.geo_json));_.each(e.geo_json.features,function(e){e.properties.datasetId=e.properties.provider,_.has(n,e.properties.provider)&&(e.template=n[e.properties.provider])});var a=KR.Util.setupSidebar(t),o=KR.Util.clusterClick(a),s=KR.Util.featureClick(a);L.Knreise.LocateButton(null,null,{bounds:r}).addTo(t),t.fitBounds(r);var l=L.Knreise.geoJson(e.geo_json,{onEachFeature:function(e,t){s(e,t)}}),u=(new L.Knreise.MarkerClusterGroup).addTo(t);u.addLayers(l.getLayers()),o(u)})};