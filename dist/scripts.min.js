var KR=this.KR||{};!function(a){"use strict";a.parseError=function(a){if(a.responseJSON){if(a.responseJSON.error)return a.responseJSON.error.join(", ");if(a.responseJSON.status)return a.responseJSON.status}return a.statusText?a.statusText:a.error?a.error.info?a.error.info:a.error.error?a.error.error:a.error:"Unknown error"},a.errorHandler=function(b){var c=$(b);c.find(".close").on("click",function(){c.find(".content").html(""),c.remove()});var d=_.template("<div><strong><%= dataset %>:</Strong> <%= error %></div>");return function(b){var e=d({dataset:b.dataset,error:a.parseError(b.error)});c.parent()?c.find(".content").append(e):c.find(".content").html(e),$("body").append(c)}}}(KR);var KR=this.KR||{};KR.Config={contentIcons:{IMAGE:"camera-retro",VIDEO:"file-video-o",SOUND:"music",TEXT:"file-text","default":"file-o"},templates:{}},KR.Config.ImageCaheUrl="http://egbtmre.cloudimg.io",KR.Util=KR.Util||{},function(a){"use strict";function b(a,b){var c=a.lastIndexOf(b);return-1!==c&&c+b.length===a.length}function c(a){return 1e3>a?"0"+a:a}a.iconForContentType=function(a){var b=a.properties.contentType;return _.has(KR.Config.contentIcons,b)?KR.Config.contentIcons[b]:KR.Config.contentIcons["default"]},a.getDatasetTemplate=function(a){var b=$("#"+a+"_template").html();return b?_.template(b):void 0},a.templateForDataset=function(a){return _.has(KR.Config.templates,a)?KR.Config.templates[a]:void 0},a.createStyleString=function(a){return _.map(a,function(a,b){return b+": "+a}).join(";")},a.colorForProvider=function(a,b){var c=!0;"hex"!==b&&(c=!1);var d={properties:{datasetId:a}};return KR.Style.colorForFeature(d,c,!0)},a.featureClick=function(a){return function(b,c,d){c.on("click",function(c){d&&d.toPoint&&d.toPoint.stopPolyClick&&!c.parent||(d?a.showFeature(b,d.template,d.getFeatureData):a.showFeature(b))})}},a.getTemplateForFeature=function(a,b){if(b){if(b.datasets){var c=_.find(b.datasets,function(b){return b._knreise_id===a.properties.datasetID});return c.template}return b.template}},a.clusterClick=function(b){return function(c,d){c.on("clusterclick",function(c){var e=_.map(c.layer.getAllChildMarkers(),function(b){var c=b.feature;return d&&!c.template&&(c.template=a.getTemplateForFeature(c,d)),c}),f=_.extend({},{template:null,getFeatureData:null,noListThreshold:null},d);b.showFeatures(e,f.template,f.getFeatureData,f.noListThreshold)})}},a.hexToRgba=function(a,b){b=b||1;var c=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(a);if(!c)return 0;var d={r:parseInt(c[1],16),g:parseInt(c[2],16),b:parseInt(c[3],16)};return"rgba("+d.r+","+d.g+","+d.b+","+b+")"},a.filterByBbox=function(a,b){var c=turf.featurecollection([turf.bboxPolygon(KR.Util.splitBbox(b))]);return turf.within(a,c)},a.getDatasetId=function(a){return"norvegiana"===a.dataset.api?a.dataset.dataset:"wikipedia"===a.dataset.api?"wikipedia":a.id?a.id:KR.Util.stamp(a)},"undefined"!=typeof L&&(L.latLngBounds.fromBBoxArray=function(a){return new L.LatLngBounds(new L.LatLng(a[1],a[0]),new L.LatLng(a[3],a[2]))},L.latLngBounds.fromBBoxString=function(a){return L.latLngBounds.fromBBoxArray(KR.Util.splitBbox(a))}),a.parseQueryString=function(a){var b=decodeURIComponent(a);if(""!==b)return _.reduce(b.replace("?","").split("&"),function(a,b){b=b.split("=");var c=b[1];return"true"===c?c=!0:"false"===c&&(c=!1),a[b[0]]=c,a},{})};var d=_.template("<%= totalt %> (<%= menn %> menn, <%= kvinner %> kvinner)");a.formatPersons=function(a){var b=a.split("-");return b.length<2?a:d({totalt:b[0],menn:b[1],kvinner:b[2]})},a.getBaseLayer=function(a,b){var c={nib:KR.getNibLayer,hist:function(a){a(L.tileLayer.wms("http://wms.geonorge.no/skwms1/wms.historiskekart",{layers:"historiskekart",format:"image/png",attribution:"Kartverket"}))}};_.has(c,a)?c[a](b):b(L.tileLayer.kartverket(a))},a.getLine=function(a,c,d){if(_.isFunction(c))return void c(function(a){d(a)});var e;if(0===c.indexOf("utno/")){var f=c.replace("utno/","");e={api:"utno",id:f,type:"gpx"}}else 0===c.indexOf("http")&&(b(c,"kml")?e={api:"kml",url:c}:b(c,"gpx")||-1!==c.indexOf("http://ut.no/tur/")?e={api:"gpx",url:c}:b(c,"geojson")&&(e={api:"geojson",url:c}));e?a.getData(e,function(a){d(a)}):alert("Kunne ikke laste linjegeometri")},a.messageDisplayer=function(a){return function(b,c){var d=$(a);d.find(".close").on("click",function(){d.find(".content").html(""),d.remove()}),d.addClass("alert-"+b),d.find(".content").html(c),$("body").append(d)}},a.mostlyCoveringMunicipality=function(a,b,c){var d="ST_MakeEnvelope("+b+", 4326)",e="SELECT komm FROM kommuner WHERE ST_Intersects(the_geom, "+d+")ORDER BY st_area(st_intersection(the_geom, "+d+")) DESC LIMIT 1",f={api:"cartodb",query:e,mapper:function(a){return a.rows[0].komm}};a.getData(f,c)},a.sparqlBbox=function(a,b,d,e,f){KR.Util.mostlyCoveringMunicipality(a,d,function(d){b.kommune=c(d),a.getData(b,e,f)})},a.distanceAndSort=function(a,b){var c=_.map(a.features,function(a){return a.properties.distance=turf.distance(b,a),a});return turf.featurecollection(c.sort(function(a,b){return a.properties.distance<b.properties.distance?-1:a.properties.distance>b.properties.distance?1:0}))},a.round=function(a,b){_.isUndefined(b)&&(b=2);var c=Math.pow(10,b);return Math.round(a*c)/c};var e=_.template("#<%= zoom %>/<%= lat %>/<%= lon %>");a.getPositionHash=function(b,c,d){return e({zoom:d,lat:a.round(b,4),lon:a.round(c,4)})},a.WORLD={type:"Feature",geometry:{type:"Polygon",coordinates:[[[-180,-90],[-180,90],[180,90],[180,-90],[-180,-90]]]}},a.createMap=function(b,c){c=c||{};var d=L.map(b,{minZoom:c.minZoom||3,maxZoom:c.maxZoom||18,maxBounds:L.geoJson(a.WORLD).getBounds()}),e=c.layer||"norges_grunnkart_graatone";return _.isString(e)?KR.Util.getBaseLayer(e,function(a){a.addTo(d)}):e.addTo(d),d},a.setupSidebar=function(a,b){b=b||{};var c=KR.Util.getDatasetTemplate("popup"),d=_.template($("#list_item_template").html()),e=_.template($("#marker_template").html()),f=_.template($("#thumbnail_template").html()),g=_.template($("#footer_template").html()),h=_.extend({},{position:"left",template:c,listElementTemplate:d,markerTemplate:e,thumbnailTemplate:f,footerTemplate:g},b),i=L.Knreise.Control.sidebar("sidebar",h);return a.addControl(i),i},a.distanceAndBearing=function(a,b){return{distance:1e3*turf.distance(a,b,"kilometers"),bearing:turf.bearing(a,b)}};var f=_.template("<%= service %>/s/crop/<%= width %>x<%= height %>/<%= image %>");a.getImageCache=function(a,b,c){return KR.Config.ImageCaheUrl?f({service:KR.Config.ImageCaheUrl,width:b,height:c,image:a}):a},a.isInIframe=function(){try{return window.self!==window.top}catch(a){return!0}}}(KR.Util);var KR=this.KR||{};KR.Style={},function(a){"use strict";function b(a){var b=a.properties.vernef_id;return _.find(p,function(a){return-1!==a.ids.indexOf(b)})}function c(a){return u[a]||"blue"}function d(a,b,c,d){return _.isFunction(a[b])?d?a[b]():a[b](c):a[b]}function e(a,b,c){return c?d(a,"fillcolor",b,!0):d(a,"fillcolor",b)}function f(a,b){return a.bordercolor?d(a,"bordercolor",b):e(a,b)}function g(b){return a.groups[b]}function h(b){var c;return b.properties&&b.properties.groupId?g(b.properties.groupId):(b.properties&&b.properties.datasetId&&(c=a.getDatasetStyle(b.properties.datasetId)),c?c:_.extend({},s))}function i(a,b,c){return c=c||9,{radius:c,weight:1,opacity:1,color:a,fillColor:b,fillOpacity:.4}}function j(a,b,c){return L.circleMarker(a,i(b,c))}function k(a){return L.Knreise.icon({markerColor:c(a)})}function l(a,b,c){var d="";return a.properties&&a.properties.title&&(d=a.properties.title),L.marker(b,{icon:c,title:d})}function m(a,b,c){if(a.properties&&a.properties.thumbnail){var d={"border-color":b,"background-image":"url("+a.properties.thumbnail+")"};c&&(d["border-width"]="3px");var e=KR.Util.getImageCache(a.properties.thumbnail,50,50),f='<div class="outer"><div class="circle" style="background-image: url('+e+");border-color:"+b+';"></div></div>';return new L.DivIcon({className:"leaflet-marker-circle",html:f,iconSize:[50,50],iconAnchor:[25,25]})}}function n(a,b,c){var d=_.filter(a,function(a){return a.feature.properties.thumbnail});if(d.length){var e;_.isArray(b)&&(e=_.rest(b),b=b[0]);var f=KR.Util.getImageCache(d[0].feature.properties.thumbnail,50,50),g={"border-color":b,"background-image":"url("+f+");"};e&&(g["box-shadow"]=_.map(e,function(a,b){var c=2*(b+1);return"0 0 0 "+c+"px "+a}).join(",")+";"),c&&(g["border-width"]="3px");var h='<div class="outer"><div class="circle" style="'+KR.Util.createStyleString(g)+'"></div></div><b>'+a.length+"</b>";return new L.DivIcon({className:"leaflet-marker-photo",html:h,iconSize:[60,60],iconAnchor:[30,30]})}}function o(a,b){var c=KR.Util.hexToRgba(b,.4);return new L.DivIcon({className:"leaflet-marker-circle",html:'<div class="outer"><div class="circle" style="background-color: '+c+";border-color:"+b+';"></div></div><b>'+a.length+"</b>",iconSize:[20,20],iconAnchor:[10,10]})}var p={landskapsvern:{ids:["LVO","LVOD","LVOP","LVOPD","BV","MAV","P","GVS","MIV","NM","BVV","PO","DO","D"],style:{fillColor:"#d8cb7a",color:"#9c8f1b"}},nasjonalpark:{ids:["NP","NPS"],style:{fillColor:"#7f9aac",color:"#b3a721"}},naturreservat:{ids:["NR","NRS"],style:{fillColor:"#ef9874",color:"#ef9873"}}},q="#72B026",r="#38A9DC",s={fillcolor:r,circle:!1,thumbnail:!0},t={difo:"Digitalt fortalt",Kulturminnesok:"Kulturminnesok",DiMu:"DigitaltMuseum",MUSIT:"Musit",Artsdatabanken:"Artsdatabanken",wikipedia:"wikipedia",riksantikvaren:"riksantikvaren"};a.datasets={"Digitalt fortalt":{fillcolor:"#F69730",circle:!1,thumbnail:!0},Kulturminnesok:{fillcolor:"#436978",circle:!1,thumbnail:!1},DigitaltMuseum:{fillcolor:"#436978",circle:!1,thumbnail:!1},Musit:{fillcolor:"#436978",circle:!1,thumbnail:!1},Artsdatabanken:{fillcolor:"#5B396B",thumbnail:!1,circle:!0},riksantikvaren:{fillcolor:"#436978",circle:!1,thumbnail:!0},verneomraader:{fillcolor:function(a){if(a){var c=b(a);if(c)return c.style.fillColor}return"#009300"},bordercolor:function(a){if(a){var c=b(a);if(c)return c.style.color}return"#009300"},thumbnail:!1,circle:!0},wikipedia:{fillcolor:"#D14020",thumbnail:!0}},a.groups={},a.getDatasetStyle=function(b){var c=a.datasets[t[b]];return c||(c=a.datasets[b]),c},a.setDatasetStyle=function(b,c){_.has(t,b)||(t[b]=b);var d=a.getDatasetStyle(b);d||(d=s),a.datasets[t[b]]=_.extend({},d,c)};var u={"#F69730":"orange","#38A9DC":"blue","#A23336":"darkred","#72B026":"green","#436978":"cadetblue","#5B396B":"darkpurple","#728224":"darkgreen","#D252B9":"purple","#D14020":"red"};a.getClusterIcon=function(a,b){var c,d=a.getAllChildMarkers(),f=_.uniq(_.map(d,function(a){return a.feature.properties.groupId})),i=h(d[0].feature);if(_.compact(f).length>1){var j=_.compact(f);j.length>1&&(c=_.map(j,_.compose(e,g)))}else c=e(i,d[0].feature);if(b&&(c=q),i.thumbnail){var k=n(d,c,b);if(k)return k}return o(d,c)},a.getIcon=function(a,b){var c=h(a),d=b?q:e(c,a),g=b?q:f(c,a);if(c.thumbnail){var j=m(a,g,b);if(j)return j}return c.circle?i(g,d,c.radius):k(d)},a.getMarker=function(b,c){var d=h(b);if(d.thumbnail){var g=m(b,f(d,b),!1);if(g)return l(b,c,g)}return d.circle?j(c,f(d,b),e(d,b)):l(b,c,a.getIcon(b,!1))},a.colorForFeature=function(a,b,d){var f=h(a);return f?b?e(f,a,d):c(e(f,a)):void 0},a.colorForDataset=function(b,d,f){var g,i;return b.grouped?(g=a.groups[KR.Util.stamp(b)],g||(i=b.datasets[0].extras.datasetId)):(i||(i=b.extras.datasetId),g=h({properties:{datasetId:i}})),g?d?e(g,null,f):c(e(g,null)):void 0},a.getPathStyle=function(a,b){b=b||!1;var c=h(a),d=e(c,a),g=f(c,a);return{weight:1,color:g,fillColor:d,clickable:b,opacity:.8,fillOpacity:.4}},a.getPathStyleForGroup=function(b,c){var d={properties:{groupId:b}};return a.getPathStyle(d,c)}}(KR.Style),L.Knreise=L.Knreise||{},L.Knreise.MarkerClusterGroup=L.MarkerClusterGroup.extend({options:{zoomToBoundsOnClick:!1,spiderfyOnMaxZoom:!1,polygonOptions:{fillColor:"#ddd",weight:2,color:"#999",fillOpacity:.6}},initialize:function(a){L.Util.setOptions(this,a),this.options.iconCreateFunction||(this.options.iconCreateFunction=this._iconCreator.bind(this)),this._featureGroup=L.featureGroup(),this._featureGroup.on(L.FeatureGroup.EVENTS,this._propagateEvent,this),this._nonPointGroup=L.featureGroup(),this._nonPointGroup.on(L.FeatureGroup.EVENTS,this._propagateEvent,this),this._inZoomAnimation=0,this._needsClustering=[],this._needsRemoving=[],this._currentShownBounds=null,this._queue=[],this.on("clusterclick",this._clusterClicked,this)},onAdd:function(a){L.MarkerClusterGroup.prototype.onAdd.apply(this,arguments),a.on("layerSelected",this._deselectAll,this)},_deselectAll:function(){_.each(this._gridClusters,function(a){_.each(a._grid,function(a){_.each(a,function(a){_.each(a,function(a){a.selected&&(a.createIcon=_.bind(L.MarkerCluster.prototype.createIcon,a),a._updateIcon(),a.selected=!1)})})})}),this.eachLayer(function(a){a.selected&&(a.createIcon=_.bind(L.MarkerCluster.prototype.createIcon,a),a.setIcon(_.bind(L.Knreise.GeoJSON.prototype._createFeatureIcon,this)(a.feature)),a.selected=!1)},this)},_clusterClicked:function(a){this._map.fire("layerSelected");var b=a.layer,c=_.bind(this._iconCreator,this);b.createIcon=function(){return c(this,!0).createIcon()},b.selected=!0,b._updateIcon()},_iconCreator:function(a,b){return KR.Style.getClusterIcon(a,b)}}),L.Knreise.markerClusterGroup=function(a){return new L.Knreise.MarkerClusterGroup(a)},L.Knreise=L.Knreise||{},L.Knreise.GeoJSON=L.GeoJSON.extend({initialize:function(a,b){L.setOptions(this,b),this._layers={},this.options.pointToLayer=this._pointToLayer.bind(this),a&&this.addData(a),this.on("click",this._featureClicked,this),this._selectedLayer=null},removedPaths:[],isCollapsed:function(a,b){var c=this.options.dataset.toPoint.minSize||20,d=a.getBounds(),e=this._map.project(d.getNorthEast(),b),f=this._map.project(d.getSouthWest(),b),g=e.x-f.x,h=f.y-e.y;return c>h||c>g},_deselectAll:function(){if(this._selectedLayer){var a=this._selectedLayer;if(a.setIcon&&(a.setIcon(this._createFeatureIcon(a.feature,!1)),a.setZIndexOffset(0)),a.setStyle){var b=a.feature;if(!b){var c=this.getParentLayer(a._leaflet_id);b=c.feature}if(a.setStyle(this._createFeatureIcon(b,!1)),a.getParent){var d=a.getParent();d.setStyle(this._createFeatureIcon(b,!1))}}this._selectedLayer=null}},deselectAllNew:function(){_.each(this.getLayers(),function(a){if(a.setIcon&&(a.setIcon(this._createFeatureIcon(a.feature,!1)),a.setZIndexOffset(0)),a.setStyle){var b=a.feature;if(!b){var c=this.getParentLayer(a._leaflet_id);b=c.feature}if(a.setStyle(this._createFeatureIcon(b,!1)),a.getParent){var d=a.getParent();d.setStyle(this._createFeatureIcon(b,!1))}}},this)},setLayerSelected:function(a){if(a.setIcon&&(a.setIcon(this._createFeatureIcon(a.feature,!0)),a.setZIndexOffset(1e3)),a.setStyle){var b=a.feature;if(!b){var c=this.getParentLayer(a._leaflet_id);b=c.feature}if(b&&(a.setStyle(this._createFeatureIcon(b,!0)),a.bringToFront()),a.getParent){var d=a.getParent();d.setStyle(this._createFeatureIcon(b,!0))}}this._selectedLayer=a},_featureClicked:function(a){if(!(this.options.dataset&&this.options.dataset.toPoint&&this.options.dataset.toPoint.stopPolyClick&&"Point"!==a.layer.toGeoJSON().geometry.type)){a.layer._map&&a.layer._map.fire("layerSelected");var b=a.layer;this.setLayerSelected(b)}},getParentLayer:function(a){var b=this._layers[a];if(b)return b;var c,d,e;for(c in this._layers)if(this._layers.hasOwnProperty(c)&&(d=this._layers[c],d.getLayer&&(e=d.getLayer(a))))return d},getZoomThreshold:function(a){var b=null,c=this._map.getZoom();if(this.isCollapsed(a,this._map.getZoom()))for(;!b;)c+=1,this.isCollapsed(a,c)||(b=c-1);else for(;!b;)c-=1,this.isCollapsed(a,c)&&(b=c);return b},_zoomend:function(){if(this.options.dataset.toPoint){var a,b,c=[];for(this.eachLayer(function(a){this._map.getZoom()<=a.zoomThreshold&&(this.removeLayer(a),this.options.dataset.toPoint.showAlways||this.addLayer(a.marker),c.push(a))},this),b=0;b<this.removedPaths.length;b++)a=this.removedPaths[b],this._map.getZoom()>a.zoomThreshold&&(this.options.dataset.toPoint.showAlways||this.removeLayer(a.marker),this.addLayer(a),this.removedPaths.splice(b,1),b-=1);this.removedPaths=this.removedPaths.concat(c)}},_getCenter:function(a){if("undefined"!=typeof turf){var b=turf.pointOnSurface(a.toGeoJSON());return L.latLng(b.geometry.coordinates.reverse())}return a.getBounds().getCenter()},_layeradd:function(a){var b=a.layer;if("Point"===b.feature.geometry.type||b.isMarker||(b.setStyle(KR.Style.getPathStyle(b.feature)),b.bringToBack()),this.options.dataset.toPoint){if(b.isMarker)return;if(b.getBounds&&!b.zoomThreshold&&!b.marker){var c=this.getZoomThreshold(b),d=this._pointToLayer(b.feature,this._getCenter(b));d.feature=b.feature,d.on("click",function(a){b.fire("click",{containerPoint:a.containerPoint,latlng:a.latlng,layerPoint:a.layerPoint,originalEvent:a.originalEvent,target:a.target,type:a.type,parent:!0})}),b.zoomThreshold=c,this.removedPaths.push(b),b.marker=d,b.marker.isMarker=!0,b.marker.getParent=function(){return b},this._map.getZoom()<=c&&(this.removeLayer(b),this.options.dataset.toPoint.showAlways||this.addLayer(b.marker)),this.options.dataset.toPoint.showAlways&&this.addLayer(b.marker)}}},setMap:function(a){a.on("layerSelected",this._deselectAll,this)},onAdd:function(a){L.GeoJSON.prototype.onAdd.apply(this,arguments),this.options.dataset&&this.options.dataset.toPoint&&(this._zoomend(),a.on("zoomend",this._zoomend,this),this.on("layeradd",this._layeradd,this)),this.setMap(a)},_createFeatureIcon:function(a,b){return KR.Style.getIcon(a,b)},_pointToLayer:function(a,b){return KR.Style.getMarker(a,b)}}),L.Knreise.geoJson=function(a,b){return new L.Knreise.GeoJSON(a,b)},L.Knreise=L.Knreise||{},L.Knreise.Control=L.Knreise.Control||{},L.Knreise.Control.Sidebar=L.Control.Sidebar.extend({initialize:function(a,b){b=b||{},b.autoPan=!1,L.setOptions(this,b);var c=L.DomUtil.get(a);L.DomEvent.on(c,"click",function(a){L.DomEvent.stopPropagation(a)}),c.parentNode.removeChild(c);var d=L.DomUtil.create("div","top-menu",c);this._contentContainer=L.DomUtil.create("div","sidebar-content",c),this.on("hide",this._removeContent,this);var e="leaflet-",f=this._container=L.DomUtil.create("div",e+"sidebar knreise-sidebar "+this.options.position);if(this.options.closeButton){var g=this._closeButton=L.DomUtil.create("a","close pull-right",d);g.innerHTML="&times;"}this._top=L.DomUtil.create("span","",d),L.DomUtil.addClass(c,e+"control"),f.appendChild(c),this.on("hide",function(){this._map&&(this._map.fire("layerSelected"),this._map.fire("layerDeselect"))},this),this.sidebar=new KR.SidebarContent(this._container,this._contentContainer,this._top,this.options,this._map)},addTo:function(a){return this.sidebar.setMap(a),L.Control.Sidebar.prototype.addTo.apply(this,arguments)},showFeature:function(a,b,c,d,e,f){if(this.show(),this.sidebar.showFeature(a,b,c,d,e,f),KR.UrlFunctions){var g=$("<div></div>"),h={id:a.id,url:KR.UrlFunctions.getFeatureLink(a),provider:a.properties.provider};a.properties.feedbackForm&&($(this._contentContainer).append(g),KR.ResponseForm(g,h)),a.id&&this.options.featureHash&&KR.UrlFunctions.setFeatureHash(a.id)}},showFeatures:function(a,b,c,d,e){this.show(),this.sidebar.showFeatures(a,b,c,d,e)},_removeContent:function(){$(this.getContainer()).html(""),KR.UrlFunctions&&KR.UrlFunctions.setFeatureHash()}}),L.Knreise.Control.sidebar=function(a,b){return new L.Knreise.Control.Sidebar(a,b)};var KR=this.KR||{};KR.UrlFunctions={},function(a){"use strict";a.setupLocationUrl=function(a){var b=function(){var b=a.getCenter(),c=KR.Util.getPositionHash(b.lat,b.lng,a.getZoom()),d=window.location.hash.split(":");if(d.length>1){var e=_.rest(d).join(":");c+=":"+e}window.location.hash=c};a.on("moveend",b),b()},a.getLocationUrl=function(){var a=window.location.hash;if(a&&""!==a&&1!==a.indexOf(":")){var b=a.replace("#","").split("/"),c=parseInt(b[0],10),d=parseFloat(b[1]),e=parseFloat(b[2]);return{lat:d,lon:e,zoom:c}}},a.getHashFeature=function(){var a=window.location.hash.split(":");return a.length>1?_.rest(a).join(":"):void 0},a.setFeatureHash=function(a){var b=window.location.hash.split(":")[0];a?window.location.hash=b+":"+encodeURIComponent(a):window.location.hash=b},a.getFeatureLink=function(a){var b=window.location.href.replace(window.location.hash,""),c=a.geometry.coordinates,d=KR.Util.getPositionHash(c[1],c[0],16),e=b+d;return a.id&&(e=e+":"+encodeURIComponent(a.id)),e}}(KR.UrlFunctions);var KR=this.KR||{};!function(){"use strict";function a(){function a(a){if(d&&d.userPosition){var b=turf.point([d.userPosition.lng,d.userPosition.lat]),c=KR.Util.distanceAndBearing(b,a),e=c.distance;return e=1e3>e?KR.Util.round(e,0)+" Meter":KR.Util.round(e/1e3,2)+" Kilometer",{dist:e,rot:c.bearing-45}}}function b(){if(e&&d.userPosition&&f){g&&g.remove();var b=e.find("h3").eq(0),c=a(f);g=$(h({distanceBearing:c})),b.length?b.after(g):e.prepend(g)}}function c(a,c){e=c,f=a,b()}var d,e,f,g,h=_.template($("#user_position_template").html());return{setMap:function(a){d=a,d.on("locationChange",b)},selectFeature:c}}KR.SidebarContent=function(b,c,d,e){function f(a){c.html(a)}function g(a){a&&c.swipe({swipe:function(){},allowPageScroll:"vertical"}).off("swipeLeft").on("swipeLeft",function(){a.next&&a.next()}).off("swipeRight").on("swipeRight",function(){a.prev&&a.prev()})}function h(a,b,c,d,f,g){var i;b>0&&(i=function(e){e&&e.preventDefault(),b-=1,a=f[b];var i=h(a,b,c,d,f,g);j(a,c,d,i,b,f.length)});var l;return b<f.length-1&&(l=function(e){e&&e.preventDefault(),b+=1,a=f[b];var i=h(a,b,c,d,f,g);j(a,c,d,i,b,f.length)}),g||(g=function(){k(f,c,d,e.noListThreshold,!0)}),{prev:i,close:g,next:l}}function i(a,b,c,d,f){var g;g=a.properties.thumbnail?e.thumbnailTemplate({thumbnail:KR.Util.getImageCache(a.properties.thumbnail,80,60),thumbnail2x:KR.Util.getImageCache(a.properties.thumbnail,60,120),color:KR.Style.colorForFeature(a,!0)}):e.markerTemplate({icon:"",color:KR.Style.colorForFeature(a)});var i=$(e.listElementTemplate({title:a.properties.title,marker:g}));return i.on("click",function(e){e.preventDefault();var g=h(a,b,c,d,f);return j(a,c,d,g,b,f.length),!1}),i}function j(a,h,i,k,n,o){if(i){var p="";return a.properties.title&&(p+="<h3>"+a.properties.title+"</h3>"),p+='<i class="fa fa-spinner fa-pulse fa-3x"></i>',f(p),void i(a,function(b){b.properties=_.extend(a.properties,b.properties),j(b,h,null,k,n,o)})}h=h||a.template||KR.Util.templateForDataset(a.properties.dataset)||l;var q=a.properties.images;_.isArray(q)&&(q=q[0]),a.properties.images||(a.properties.images=null),a.properties.allProps&&a.properties.allProps.europeana_rights?a.properties.license=a.properties.allProps.europeana_rights[0]:a.properties.license=null;var r=KR.Style.colorForFeature(a,!0,!0),p='<span class="providertext" style="color:'+r+';">'+a.properties.provider+"</span>";if(p+=h(_.extend({image:null},a.properties)),e.footerTemplate&&a.properties.link&&(p+=e.footerTemplate(a.properties)),p=$(["<div>",p,"</div>"].join(" ")),KR.Util.isInIframe()&&p.find("a").attr("target","_blank"),m.selectFeature(a,p),f(p),g(k),b.find(".prev-next-arrows").remove(),d.html(""),k){var s=$('<a class="pull-left list-btn"><i class="fa fa-bars"></i></a>');d.append(s),s.click(k.close);var t=n+1;d.append($('<div class="top-text pull-left"><b>'+t+"</b> av "+o+"</div>"));var u=$('<a class="prev-next-arrows prev circle"><span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span></a>');b.append(u),k.prev&&u.click(k.prev).addClass("active");var v=$('<a class="prev-next-arrows next circle"><span class="glyphicon glyphicon-chevron-right" aria-hidden="true"></span></a>');b.append(v),k.next&&v.click(k.next).addClass("active")}"undefined"!=typeof audiojs&&audiojs.createAll(),c.scrollTop(0)}function k(a,b,f,g,j){g=void 0===g?e.noListThreshold:g;var k=a.length<=g;if(k&&j!==!0){var l=a[0];c.html("");var m=h(l,0,b,f,a);return void this.showFeature(l,b,f,m,0,a.length)}var n=$('<span class="circle">'+a.length+"</span>");d.html(n);var o=_.chain(a).groupBy(function(a){return a.properties.provider}).map(function(c,d){var e=$("<div></div>"),g=$('<div class="list-group"></ul>'),h=_.map(c,function(c){var d=_.findIndex(a,function(a){return a===c});return i(c,d,b,f,a)},this);return g.append(h),e.append('<h5 class="providertext">'+d+"</h5>"),e.append(g),e}).value();c.html(o),c.scrollTop(0)}var l=KR.Util.getDatasetTemplate("popup"),m=a();return c=$(c),b=$(b),d=$(d),{showFeature:j,showFeatures:k,setMap:function(a){m.setMap(a)}}}}(),function(){"use strict";L.Knreise=L.Knreise||{},L.Knreise.Control=L.Knreise.Control||{};var a=function(a,b){function c(c){var d=document.createElement("i");return d.className="layericon fa",a.visible?d.className+=" fa-check-square-o":d.className+=" fa-square-o",c&&(d.className+=" "+c),b.isLoading&&(d.className="layericon fa fa-spinner fa-pulse"),b.enabled?d.style.color=KR.Style.colorForDataset(a,!0,!0):d.style.color="#ddd",d}function d(){var a=c();j.replaceChild(a,k),k=a}function e(){a.visible=!a.visible,d(),a.visible?b.fire("show"):b.fire("hide")}function f(a){m?m.setAttribute("title",m.getAttribute("title")+", "+KR.parseError(a)):(m=L.DomUtil.create("i","error-icon fa fa-exclamation-triangle"),m.setAttribute("title",KR.parseError(a)),j.insertBefore(m,j.childNodes[0]))}function g(){j=document.createElement("label"),_.isUndefined(a.visible)&&(a.visible=!0);var d=document.createElement("span");d.innerHTML=" "+a.name,k=c(),j.appendChild(k),j.appendChild(d),b.error&&f(b.error),b.enabled||(j.className="disabled"),L.DomEvent.on(j,"click",function(){var a=b.enabled&&!b.isLoading;a&&e()})}function h(){b.enabled!==l&&(l=b.enabled,d(),l?j.className=j.className.replace("disabled",""):j.className+="disabled")}function i(){return j}var j,k,l=b.enabled,m=null;return g(),b.on("changeEnabled",h),b.on("dataloadstart",function(){m&&(j.removeChild(m),m=null),d()}),b.on("dataloadend",d),b.on("error",f),{getLabel:i,hasError:function(){return!!b.error}}};L.Control.Datasets=L.Control.extend({initialize:function(a,b){L.setOptions(this,b),this._labels=[],this._handlingClick=!1,this.expanded=!1,this.numLoading=0;var c;for(c in a)a.hasOwnProperty(c)&&this._addLayer(a[c])},_addLayer:function(a){var b,c=a.options.dataset;if(c.datasets)if(c.grouped)this._addDataset(c,a);else for(b=0;b<c.datasets.length;b++)this._addDataset(c.datasets[b]);else this._addDataset(c,a)},_addDataset:function(b,c){c.isLoading&&(this.numLoading+=1,this._checkSpinner());var d=new a(b,c);this._labels.push(d),c.on("dataloadstart",function(){this._loadStart()},this),c.on("dataloadend",function(){this._loadEnd()},this)},_loadStart:function(){this.numLoading+=1,this._checkSpinner()},_loadEnd:function(){this.numLoading-=1,this._checkSpinner()},_hasErrors:function(){return!!_.find(this._labels,function(a){return a.hasError()})},_checkError:function(){this._hasErrors()?this._errorIcon.className=this._errorIcon.className.replace(" hidden",""):this._errorIcon.className.indexOf("hidden")<0&&(this._errorIcon.className+=" hidden")},_checkSpinner:function(){this._btnIcon&&(0===this.numLoading?(this._btnIcon.className=this._btnIcon.className.replace(" fa-spinner fa-pulse"," fa-bars"),this._checkError()):(this._errorIcon.className.indexOf("hidden")<0&&(this._errorIcon.className+=" hidden"),this._btnIcon.className=this._btnIcon.className.replace(" fa-bars"," fa-spinner fa-pulse")))},onAdd:function(a){return this._map=a,this._initLayout(),this._update(),this._container},_update:function(){if(this._container){this._overlaysList.innerHTML="";var a,b;for(a=0;a<this._labels.length;a++)b=this._labels[a],this._overlaysList.appendChild(b.getLabel());this._checkError()}},_initLayout:function(){var a="leaflet-control-layers";this._container=L.DomUtil.create("div",""),this._container.setAttribute("aria-haspopup",!0),L.Browser.touch?L.DomEvent.on(this._container,"click",L.DomEvent.stopPropagation):L.DomEvent.disableClickPropagation(this._container).disableScrollPropagation(this._container),this._form=L.DomUtil.create("form",a+"-list"),this._map.on("click",this._collapse,this),this._overlaysList=L.DomUtil.create("div",a+"-overlays",this._form),this._closeDiv=L.DomUtil.create("div","clearfix");var b=L.DomUtil.create("button","btn btn-default pull-right",this._closeDiv);b.title="Kartlag",L.DomEvent.on(b,"click",function(){this._toggle()},this),this._errorIcon=L.DomUtil.create("i","error-icon fa fa-exclamation-triangle hidden",b),b.appendChild(document.createTextNode(" ")),this.numLoading>0?this._btnIcon=L.DomUtil.create("i","fa fa-spinner fa-pulse",b):this._btnIcon=L.DomUtil.create("i","fa fa-bars",b),this._container.appendChild(this._closeDiv),this._listContainer=L.DomUtil.create("div",a+" hidden"),this._listContainer.appendChild(this._form),this._container.appendChild(this._listContainer)},_toggle:function(){this.expanded?this._collapse():this._expand()},_expand:function(){L.DomUtil.addClass(this._listContainer,"leaflet-control-layers-expanded"),this.expanded=!0,this._listContainer.className=this._listContainer.className.replace(" hidden","")},_collapse:function(){this._listContainer.className=this._listContainer.className.replace(" leaflet-control-layers-expanded",""),L.DomUtil.addClass(this._listContainer,"hidden"),this.expanded=!1}}),L.control.datasets=function(a,b){return new L.Control.Datasets(a,b)}}(),L.Knreise=L.Knreise||{},L.Knreise.Icon=L.AwesomeMarkers.Icon.extend({options:{icon:null}}),L.Knreise.icon=function(a){return new L.Knreise.Icon(a)};var KR=this.KR||{};KR.DatasetLoader=function(a,b,c,d,e,f){"use strict";function g(a){var b=KR.Util.stamp(a);return function(c){return c&&c.features.length?(_.each(c.features,function(c){c.properties.datasetID=b,_.has(a,"circle")&&(c.properties.circle=a.circle),_.has(a,"provider")&&(c.properties.provider=a.provider),_.has(a,"extras")&&(c.properties=_.extend(c.properties,a.extras)),c.properties.feedbackForm=a.feedbackForm,_.has(a,"mappings")&&_.each(a.mappings,function(a,b){c.properties[b]=c.properties[a]}),c.template=KR.Util.getTemplateForFeature(c,a)}),c):c}}function h(a){var b=_.reduce(_.without(_.keys(a),"datasets"),function(b,c){return"style"!==c&&(b[c]=a[c]),b},{});if(a.style){b.extras=b.extras||{};var c=KR.Util.stamp(a);b.extras.groupId=c,KR.Style.groups[c]=a.style}return a.datasets=_.map(a.datasets,function(a){return _.extend({},b,a)}),a}function i(a,b){var c={dataset:b,onEachFeature:function(a,c){A&&A(a,c,b)}};return b.style&&(c.style=b.style),L.Knreise.geoJson(a,c)}function j(a,b){a.clearLayers();var c=_.reduce(b,function(a,b){return a.concat(b.toGeoJSON().features)},[]);a.addData(KR.Util.createFeatureCollection(c)),a.fire("dataAdded")}function k(a,c){a.clearLayers();var d=_.reduce(c,function(a,c){return c.setMap(b),a.concat(c.getLayers())},[]);a.addLayers(d)}function l(a,b){a.on("hide",function(){b(!0)}),a.on("show",function(){b(!0)})}function m(a,b){var c;e?c=i(null,a):a.cluster?(c=new L.Knreise.MarkerClusterGroup({dataset:a,maxClusterRadius:f}).addTo(b),z&&z(c,a)):c=i(null,a).addTo(b);var d=!0;return a.minFeatures&&(d=!1),c.enabled=d,c}function n(a,b){a.enabled!==b&&(a.enabled=b,a.fire("changeEnabled"))}function o(a){if(a.datasets&&!a.grouped){var b=_.filter(a.datasets,function(a){return a.visible}).length;return b>0}return a.visible}function p(a){return a.minZoom&&b.getZoom()<a.minZoom?!1:o(a)}function q(a){return a.minZoom&&b.getZoom()<a.minZoom?!1:!0}function r(a){return a.datasets?0===_.filter(a.datasets,function(a){return a.isStatic===!1}).length:a.isStatic}function s(a){var c=[];a.datasets?c=a.datasets:c.push(a),_.each(c,function(a){if(a.loadWhenLessThan){var c=function(){if(a.geoJson){var c=turf.bboxPolygon(KR.Util.splitBbox(b.getBounds().toBBoxString())),d=_.filter(a.geoJson.features,function(a){return turf.inside(a,c)});d.length<=a.loadWhenLessThan.count?a.loadWhenLessThan.callback(b,a,d):a.loadWhenLessThan.callback(b,a)}};b.on("moveend",c),c()}})}function t(a,c){a.init&&a.init(b,a,c)}function u(c,f,h,o,u){function v(a,b){if(c.minFeatures){if(a.numFound&&c.minFeatures<a.numFound)return n(b,!1),KR.Util.createFeatureCollection([]);n(b,!0)}return a}var w=m(c,b);c.datasets?(c.datasets=_.filter(c.datasets,function(a){return!a.noLoad}),_.each(c.datasets,function(a){t(a,w)})):t(c,w);var x,y=function(h,l,m,n){
var o=!h,r=l||b.getBounds().toBBoxString(),s=m||p(c);if(u&&r){var t=L.latLngBounds.fromBBoxString(r),y=L.latLngBounds.fromBBoxString(u);y.intersects(t)||(s=!1)}if(w.enabled=q(c),w.fire("changeEnabled"),!s)return w.clearLayers(),void(n&&n([]));var z;z=c.datasets?_.filter(c.datasets,function(a){return a.visible}):[c];var A=[],B=_.after(z.length,function(){w.isLoading=!1,w.fire("dataloadend"),e?j(w,A):c.cluster?k(w,A):j(w,A),n&&n(A)});w.isLoading=!0,w.fire("dataloadstart"),_.each(z,function(b){function c(a){b.geoJson=a,w.error=null,f&&(a=f(a));var c;e?c=L.geoJson(j(v(a,w))):b.cluster?(c=i(j(v(a,w)),b),b.geoJSONLayer=c):c=L.geoJson(j(v(a,w))),A.push(c),B()}function h(a){w.error=a,B(),"abort"!==a.statusText&&(d?d({dataset:b.name,error:a,layer:w}):w.fire("error",a))}var j=g(b);if(!o&&b.isStatic||x===r)return void c(b.geoJson);if(b.bbox){var k=r;b.isStatic&&b.fixedBbox&&(k=b.fixedBbox),b.bboxFunc?b.bboxFunc(a,b.dataset,k,c,h):a.getBbox(b.dataset,k,c,h)}else a.getData(b.dataset,c,h)}),x=r};return y(null,h,void 0,function(a){s(c),o&&o(a)}),(!r(c)||c.minZoom)&&b.on("moveend",y),l(w,y),{layer:w,reload:y}}function v(a){var b=KR.Util.getDatasetId(a);a.extras=a.extras||{},a.extras.datasetId=b,a.style&&KR.Style.setDatasetStyle(b,a.style)}function w(a,b){var c=_.after(B.length,function(){b&&b()});_.each(B,function(b){b(null,null,a,c)})}function x(a){var c={},d=function(){_.each(a,function(a){a.deselectAllNew()})};b.on("layerDeselect",d);var e=new L.Knreise.MarkerClusterGroup({maxClusterRadius:f}).addTo(b);e.on("clusterclick",d),z(e),_.each(a,function(b){b.on("dataAdded",function(){var f=L.stamp(b);c[f]&&e.removeLayers(c[f]);var g=b.getLayers();c[f]=g,e.addLayers(g),b.on("hide",function(){c[f]&&e.removeLayers(c[f])}),b.on("click",function(b){d();var c=b.layer,e=_.find(a,function(a){return!!_.find(a.getLayers(),function(a){return a===c})});e.setLayerSelected(c)})})})}function y(a,b,c,d,f){a=_.filter(a,function(a){return!a.noLoad});var g;if(d){var i=[],j=_.after(a.length,function(){d(i)});g=function(a){i.push(a),j()}}var k=_.map(a,function(a){return a=_.extend({},C,a),a.datasets&&h(a),KR.Style.setDatasetStyle&&(a.datasets?_.each(a.datasets,v):v(a)),a.visible||(a.notLoaded=!0),a.minZoom&&a.bbox&&(a.isStatic=!1),u(a,c,b,g,f)});B=_.pluck(k,"reload");var l=_.pluck(k,"layer");return e&&x(l),l}f=f||80;var z,A,B=[],C={isStatic:!0,bbox:!0,cluster:!0,visible:!0};return c&&(z=KR.Util.clusterClick(c),A=KR.Util.featureClick(c)),{loadDatasets:y,reload:w}},L.Knreise=L.Knreise||{},function(a){"use strict";L.Control.EasyButtons2=L.Control.EasyButtons.extend({_addImage:function(){var a=0===this.options.icon.lastIndexOf("fa",0)?" fa fa-lg":" glyphicon";this._icon=L.DomUtil.create("i",this.options.icon+a,this.link),this.options.id&&(this._icon.id=this.options.id)},changeIcon:function(a){var b=0===this.options.icon.lastIndexOf("fa",0)?" fa fa-lg":" glyphicon";this._icon.className=a+b}}),a.LocateButton=function(a,b,c){function d(a){return new cilogi.L.Marker(a,{fontIconSize:3,fontIconName:"",altIconName:"",fontIconColor:"#FF0000",fontIconFont:"awesome",opacity:1})}function e(b){var e=L.latLng(b.coords.latitude,b.coords.longitude);return l.userPosition=e,l.fire("locationChange"),m.changeIcon(p),c.bounds&&!c.bounds.contains(e)?void q("warning","Du befinner deg utenfor området til denne demonstratoren. Viser ikke din posisjon"):void(a?a(e):(l.setView(e,16),k?k.setLatLng(e):(k=d(e),l.addLayer(k))))}function f(){l.fire("locationError"),m.changeIcon(p),m.getContainer().className=m.getContainer().className.replace(" active","")}function g(){o=!1,_.isUndefined(n)||(navigator.geolocation.clearWatch(n),m.getContainer().className=m.getContainer().className.replace(" active",""),l.removeLayer(k),k=void 0,n=void 0)}function h(){o=!0,navigator.geolocation?(m.changeIcon("fa-spinner fa-pulse"),m.getContainer().className+=" active",n=navigator.geolocation.watchPosition(e,f)):b&&b()}function i(){return o?void g():void h()}function j(a){var b=c.title||"Følg min posisjon";return l=a,m=new L.Control.EasyButtons2(i,{icon:p,title:b}),l.addControl(m),m}c=c||{},c.zoom=c.zoom||10;var k,l,m,n,o=!1,p=c.icon||"fa-user",q=KR.Util.messageDisplayer($("#message_template").html());return{addTo:j,getLocation:h}}}(L.Knreise);var KR=this.KR||{};L.TileLayer.WMTS=L.TileLayer.extend({defaultWmtsParams:{service:"WMTS",request:"GetTile",version:"1.0.0",layer:"",style:"",tilematrixSet:"",format:"image/jpeg"},initialize:function(a,b){this._url=a;var c=L.extend({},this.defaultWmtsParams),d=b.tileSize||this.options.tileSize;c.width=c.height=b.detectRetina&&L.Browser.retina?2*d:d;for(var e in b)this.options.hasOwnProperty(e)||"matrixIds"==e||(c[e]=b[e]);this.wmtsParams=c,this.matrixIds=b.matrixIds||this.getDefaultMatrix(),L.setOptions(this,b)},onAdd:function(a){L.TileLayer.prototype.onAdd.call(this,a)},getTileUrl:function(a,b){var c=this._map;return crs=c.options.crs,tileSize=this.options.tileSize,nwPoint=a.multiplyBy(tileSize),nwPoint.x+=1,nwPoint.y-=1,sePoint=nwPoint.add(new L.Point(tileSize,tileSize)),nw=crs.project(c.unproject(nwPoint,b)),se=crs.project(c.unproject(sePoint,b)),tilewidth=se.x-nw.x,b=c.getZoom(),ident=this.matrixIds[b].identifier,X0=this.matrixIds[b].topLeftCorner.lng,Y0=this.matrixIds[b].topLeftCorner.lat,tilecol=Math.floor((nw.x-X0)/tilewidth),tilerow=-Math.floor((nw.y-Y0)/tilewidth),url=L.Util.template(this._url,{s:this._getSubdomain(a)}),url+L.Util.getParamString(this.wmtsParams,url)+"&tilematrix="+ident+"&tilerow="+tilerow+"&tilecol="+tilecol},setParams:function(a,b){return L.extend(this.wmtsParams,a),b||this.redraw(),this},getDefaultMatrix:function(){for(var a=new Array(22),b=0;22>b;b++)a[b]={identifier:""+b,topLeftCorner:new L.LatLng(20037508.3428,-20037508.3428)};return a}}),L.tileLayer.wmts=function(a,b){return new L.TileLayer.WMTS(a,b)},function(a){"use strict";function b(a){var b,c=new Array(30);for(b=0;22>b;b++)c[b]={identifier:a+":"+b,topLeftCorner:new L.LatLng(20037508,-20037508.34)};return c}a.SKTokenUrl="http://localhost:8001/html/baat/?type=token",a.getNibLayer=function(c,d){a.Util.sendRequest(KR.SKTokenUrl,null,function(a){var e;if(d)e=L.tileLayer.wms("http://gatekeeper2.geonorge.no/BaatGatekeeper/gk/gk.nibcache",{layers:"NiB",format:"image/jpeg",transparent:!1,attribution:"Kartverket"});else{var f="http://gatekeeper1.geonorge.no/BaatGatekeeper/gk/gk.nibcache_wmts",g="EPSG:900913";e=new L.TileLayer.WMTS(f,{layer:"NiB",style:"normal",tilematrixSet:g,matrixIds:b(g),format:"image/jpeg",attribution:"Kartverket"})}e.setParams({GKT:a}),c(e)})}}(KR);var KR=this.KR||{};KR.Config=KR.Config||{},function(a){"use strict";a.getKulturminneFunctions=function(a){var b=function(b,c,d){if(d||c.extraFeatures.clearLayers(),d){var e=_.map(d,function(a){return a.properties.id});if(e.length){var f={api:"kulturminnedataSparql",type:"lokalitetpoly",lokalitet:e};a.getData(f,function(a){c.extraFeatures.clearLayers().addData(a)})}}},c=function(a,b,c){b.extraFeatures=L.geoJson(null,{onEachFeature:function(a,c){b.extras&&b.extras.groupId?c.setStyle(KR.Style.getPathStyleForGroup(b.extras.groupId)):(a.properties.datasetId=b.id,c.setStyle(KR.Style.getPathStyle(a,!0))),c.on("click",function(){var c=_.find(b.geoJSONLayer.getLayers(),function(b){return b.feature.properties.id===a.properties.lok});c&&c.fire("click")})}}).addTo(a),c.on("hide",function(){a.removeLayer(b.extraFeatures)}),c.on("show",function(){a.addLayer(b.extraFeatures)})};return{loadKulturminnePoly:b,initKulturminnePoly:c}},a.getDatasetList=function(b,c,d){var e=a.getKulturminneFunctions(b);c&&3===c.length&&(c="0"+c);var f={difo:{name:"Digitalt fortalt",dataset:{dataset:"difo",api:"norvegiana"},cluster:!0,template:KR.Util.getDatasetTemplate("digitalt_fortalt"),noListThreshold:1/0,description:"Kulturrådets tjeneste for personlige fortellinger fra kulturinstitusjoner og privatpersoner.",allowTopic:!0,feedbackForm:!0,isStatic:!1},verneomr:{id:"verneomraader",dataset:{api:"cartodb",table:"naturvernomrader_utm33_2",columns:["iid","omradenavn","vernef_id","verneform"]},provider:"Naturbase",name:"Verneområder",template:KR.Util.getDatasetTemplate("verneomraader"),getFeatureData:function(a,c){b.getItem({api:"norvegiana",id:"kulturnett_Naturbase_"+a.properties.iid},c)},toPoint:{showAlways:!0,stopPolyClick:!0,minSize:20},minZoom:10,cluster:!1,description:"Nasjonalparker og andre naturvernområder - ca. 2700 i hele landet."},artobs:{name:"Artsobservasjoner",hideFromGenerator:!0,dataset:{api:"norvegiana",dataset:"Artsdatabanken"},cluster:!1,description:"Artsobservasjoner fra Artsdatabanken",template:KR.Util.getDatasetTemplate("popup")},folketelling:{name:"Folketelling 1910",provider:"Folketelling 1910",dataset:{api:"folketelling",dataset:"property"},isStatic:!1,minZoom:14,template:KR.Util.getDatasetTemplate("folketelling"),getFeatureData:function(a,c){b.getData({api:"folketelling",type:"propertyData",propertyId:a.properties.efid},function(b){a.properties=b.properties,a.properties.provider="Folketelling 1910",c(a)})},mappings:{title:"gaardsnavn_gateadr"},noListThreshold:0,description:"Personer og eiendommer fra folketellingen 1910"},ark_hist:{grouped:!0,name:"Arkeologi og historie",datasets:[{name:"MUSIT",provider:"Universitetsmuseene",dataset:{api:"norvegiana",dataset:"MUSIT"},template:KR.Util.getDatasetTemplate("musit")},{name:"DiMu",dataset:{api:"norvegiana",dataset:"DiMu"},template:KR.Util.getDatasetTemplate("digitalt_museum"),isStatic:!1},{id:"riksantikvaren",name:"Riksantikvaren",provider:"Riksantikvaren",dataset:{api:"kulturminnedataSparql",kommune:c,fylke:d},template:KR.Util.getDatasetTemplate("ra_sparql"),bbox:!1,isStatic:!0,init:e.initKulturminnePoly,loadWhenLessThan:{count:5,callback:e.loadKulturminnePoly}}],description:"Data fra Universitetsmuseene, Digitalt museum og Riksantikvaren"},jernbane:{id:"jernbane",dataset:{api:"jernbanemuseet"},provider:"Jernbanemuseet",name:"Jernbanemuseet",hideFromGenerator:!0,template:KR.Util.getDatasetTemplate("jernbanemuseet"),getFeatureData:function(a,c){b.getItem({api:"jernbanemuseet",id:a.properties.id},c)},isStatic:!0,bbox:!1,description:"Jernbanemuseet"},arkeologi:{grouped:!0,name:"Arkeologi",style:{fillcolor:"#436978",circle:!1,thumbnail:!0},datasets:[{name:"MUSIT",provider:"Universitetsmuseene",dataset:{api:"norvegiana",dataset:"MUSIT"},template:KR.Util.getDatasetTemplate("musit")},{id:"riksantikvaren",name:"Riksantikvaren",provider:"Riksantikvaren",dataset:{filter:'FILTER regex(?loccatlabel, "^Arkeologisk", "i") .',api:"kulturminnedataSparql",kommune:c,fylke:d},template:KR.Util.getDatasetTemplate("ra_sparql"),bbox:!1,isStatic:!0,init:e.initKulturminnePoly,loadWhenLessThan:{count:5,callback:e.loadKulturminnePoly}}],description:"Arkeologidata fra Universitetsmuseene og Riksantikvaren"},historie:{grouped:!0,name:"Historie",style:{fillcolor:"#D252B9",circle:!1,thumbnail:!0},datasets:[{id:"riksantikvaren",name:"Riksantikvaren",provider:"Riksantikvaren",dataset:{filter:'FILTER (!regex(?loccatlabel, "^Arkeologisk", "i"))',api:"kulturminnedataSparql",kommune:c,fylke:d},template:KR.Util.getDatasetTemplate("ra_sparql"),bbox:!1,isStatic:!0,init:e.initKulturminnePoly,loadWhenLessThan:{count:5,callback:e.loadKulturminnePoly}},{name:"DiMu",dataset:{api:"norvegiana",dataset:"DiMu",query:"-dc_subject_facet:Kunst"},template:KR.Util.getDatasetTemplate("digitalt_museum"),isStatic:!1,bbox:!0},{dataset:{api:"norvegiana",dataset:"Industrimuseum"},isStatic:!1,bbox:!0},{dataset:{api:"norvegiana",dataset:"Foto-SF"},isStatic:!1,bbox:!1,template:KR.Util.getDatasetTemplate("foto_sf")},{dataset:{api:"norvegiana",dataset:"Kystreise"},isStatic:!0,bbox:!1}],description:"Historie og kulturminner fra Riksantikvaren og Digitalt museum "},kunst:{grouped:!0,name:"Kunst",style:{fillcolor:"#72B026",circle:!1,thumbnail:!0},datasets:[{name:"DiMu",dataset:{api:"norvegiana",dataset:"DiMu",query:"dc_subject_facet:Kunst"},template:KR.Util.getDatasetTemplate("digitalt_museum"),isStatic:!1}],description:"Kunstdata fra Digitalt museum "},wikipedia:{name:"Wikipedia",provider:"Wikipedia",dataset:{api:"wikipedia"},style:{thumbnail:!0},minZoom:13,template:KR.Util.getDatasetTemplate("wikipedia"),description:"Stedfestede artikler fra bokmålswikipedia"},wikipediaNN:{name:"Wikipedia Nynorsk",provider:"Wikipedia Nynorsk",dataset:{api:"wikipediaNN"},style:{thumbnail:!0},minZoom:13,template:KR.Util.getDatasetTemplate("wikipedia"),description:"Stedfestede artikler fra nynorskwikipedia"},lokalwiki:{id:"lokalwiki",name:"Lokalhistoriewiki",hideFromGenerator:!1,provider:"Lokalhistoriewiki",dataset:{api:"lokalhistoriewiki"},style:{thumbnail:!0},minZoom:13,bbox:!0,isStatic:!1,description:"Stedfestede artikler fra lokalhistoriewiki.no"},riksantikvaren:{id:"riksantikvaren",name:"Kulturminnesøk",hideFromGenerator:!1,provider:"Riksantikvaren",dataset:{api:"kulturminnedataSparql",kommune:c,fylke:d},template:KR.Util.getDatasetTemplate("ra_sparql"),bbox:!1,isStatic:!0,init:e.initKulturminnePoly,loadWhenLessThan:{count:10,callback:e.loadKulturminnePoly},description:"Data fra Riksantikvarens kulturminnesøk"},brukerminner:{name:"Kulturminnesøk - brukerregistreringer",hideFromGenerator:!1,provider:"riksantikvaren",dataset:{api:"kulturminnedata",layer:2,getExtraData:!0,extraDataLayer:6,matchId:"KulturminnesokID"},cluster:!0,isStatic:!1,style:{thumbnail:!0},description:"Brukerregistrerte data fra Riksantikvarens kulturminnesøk",template:KR.Util.getDatasetTemplate("brukerminne")},grorud:{name:"Byantikvaren Oslo - Groruddalen",hideFromGenerator:!0,provider:"grorud",dataset:{api:"cartodb",table:"byantikvaren_groruddalen"},bbox:!1,isStatic:!0,description:"Byantikvarens Groruddalsatlas"},dimu:{name:"Digitalt Museum",hideFromGenerator:!1,provider:"dimu",dataset:{dataset:"DiMu",api:"norvegiana"},cluster:!0,isStatic:!1,style:{thumbnail:!0},description:"Alle stedfestede data fra Digitalt Museum",allowTopic:!0,feedbackForm:!0},musit:{name:"Universitetsmuseene",hideFromGenerator:!1,provider:"Universitetsmuseene",dataset:{dataset:"MUSIT",api:"norvegiana"},cluster:!0,isStatic:!1,style:{thumbnail:!0},description:"Alle stedfestede data fra Universitetsmuseene",allowTopic:!0,feedbackForm:!0},industrimuseum:{name:"Industrimuseum",hideFromGenerator:!1,provider:"Industrimuseum",dataset:{dataset:"Industrimuseum",api:"norvegiana"},cluster:!0,isStatic:!1,style:{thumbnail:!0},description:"Alle stedfestede data fra Industrimuseum",allowTopic:!0,feedbackForm:!0},kystreise:{name:"Kystreise",hideFromGenerator:!1,provider:"Kystreise",dataset:{dataset:"Kystreise",api:"norvegiana"},cluster:!0,isStatic:!1,style:{thumbnail:!0},description:"Alle stedfestede data fra Kystreise",allowTopic:!0,feedbackForm:!0},dimufoto:{hideFromGenerator:!0,dataset:{api:"norvegiana",dataset:"DiMu",query:"europeana_type_facet:IMAGE"},template:KR.Util.getDatasetTemplate("digitalt_museum"),isStatic:!1,style:{thumbnail:!0},noListThreshold:1/0},riksarkivet:{name:"Riksarkivet",dataset_name_override:"Riksarkivet",provider:"riksarkivet",hideFromGenerator:!0,dataset:{api:"flickr",user_id:"national_archives_of_norway"},template:KR.Util.getDatasetTemplate("flickr"),isStatic:!1,style:{thumbnail:!0},description:"Bilder fra Riksarkivets Flickr-konto"},nasjonalbiblioteket:{name:"Nasjonalbiblioteket",dataset_name_override:"Nasjonalbiblioteket",provider:"nasjonalbiblioteket",hideFromGenerator:!0,dataset:{api:"flickr",user_id:"national_library_of_norway"},template:KR.Util.getDatasetTemplate("flickr"),isStatic:!1,style:{thumbnail:!0},description:"Bilder fra Nasjonalbibliotekets Flickr-konto"},oslobyarkiv:{name:"Oslo Byarkiv",dataset_name_override:"Oslo Byarkiv",provider:"oslobyarkiv",hideFromGenerator:!0,dataset:{api:"flickr",user_id:"byarkiv"},template:KR.Util.getDatasetTemplate("flickr"),isStatic:!1,style:{thumbnail:!0},description:"Bilder fra Oslo byarkiv sin Flickr-konto"},nasjonalmuseet:{name:"Nasjonalmuseet",dataset_name_override:"Nasjonalmuseet",provider:"nasjonalmuseet",hideFromGenerator:!0,dataset:{api:"flickr",user_id:"nasjonalmuseet"},template:KR.Util.getDatasetTemplate("flickr"),isStatic:!1,style:{thumbnail:!0},description:"Bilder fra Nasjonalmuseet sin Flickr-konto"},nve:{name:"NVE",dataset_name_override:"NVE",provider:"nve",hideFromGenerator:!0,dataset:{api:"flickr",user_id:"nve",accuracy:"6"},template:KR.Util.getDatasetTemplate("flickr"),isStatic:!1,style:{thumbnail:!0},description:"Bilder fra NVE Flickr-konto"},vestfoldmuseene:{name:"Vestfoldmuseene",dataset_name_override:"Vestfoldmuseene",provider:"Vestfoldmuseene",hideFromGenerator:!0,dataset:{api:"flickr",user_id:"vestfoldmuseene",accuracy:"1"},template:KR.Util.getDatasetTemplate("flickr"),isStatic:!1,style:{thumbnail:!0},description:"Bilder fra Vestfoldmuseene sin Flickr-konto"}};if(!c&&!d){var g={bbox:!0,minZoom:12,isStatic:!1,bboxFunc:KR.Util.sparqlBbox};_.extend(f.riksantikvaren,g),_.extend(f.ark_hist.datasets[2],g),_.extend(f.arkeologi.datasets[1],g),_.extend(f.historie.datasets[0],g)}return f},a.getDatasets=function(b,c,d,e){var f=a.getDatasetList(c,d,e);return _.chain(b).map(function(a){var b;if(a.indexOf(":")>-1){var c=a.split(":");a=c[0],b=c[1]}if(_.has(f,a)){var d=f[a];return b&&"norvegiana"===d.dataset.api&&(d.dataset.query="dc_subject_text:"+b),d}}).compact().value()}}(KR.Config);var KR=this.KR||{};KR.SplashScreen=function(a,b,c,d,e,f){"use strict";function g(){return window.location.href.replace(window.location.hash,"")}function h(){var a=g(),b="remember_"+a+"=",c=document.cookie.split("; "),d=_.find(c,function(a){return 0===a.indexOf(b)});return d?"true"===d.substring(b.length,d.length):void 0}function i(a){document.cookie="remember_"+g()+"="+a}function j(){this._gray&&this._container.removeChild(this._gray),L.Control.Sidebar.prototype.hide.apply(this,arguments)}function k(){this._gray=L.DomUtil.create("div","gray",this._container),L.Control.Sidebar.prototype.show.apply(this,arguments)}function l(){var g=L.DomUtil.create("div","",document.body);g.id="splashscreen";var h=L.control.sidebar("splashscreen",{position:"center",autoPan:!1});h.hide=_.bind(j,h),h.show=_.bind(k,h),a.addControl(h);var i=_.template($("#splashscreen_template").html()),l=$("<div>"+i({title:b,image:d,description:c,creator:e,spinner:!!f})+"</div>");return KR.Util.isInIframe()&&l.find("a").attr("target","_blank"),h.setContent(l.html()),h}function m(a){function b(){i(c.prop("checked"))}var c=$(a.getContainer()).find("#persist_splash_cb");c.prop("checked",h()),c.on("change",b),b()}function n(b){return L.easyButton(a,b,{position:"topright",icon:"fa-info-circle",title:"Om"})}var o=l();n(function(){o.isVisible()?o.hide():o.show()});var p=h();return p||(_.isUndefined(p)&&i(!0),o.show()),m(o),{finishedLoading:function(){var a=$(o.getContainer()).find("#splash_spinner");a&&a.remove()}}};var KR=this.KR||{};KR.ResponseForm=function(a,b){function c(a,b){var c=_.reduce(a,function(a,b,c){return a[g[c]]=b,a},{});$.ajax({url:h,data:c,type:"POST",dataType:"xml",success:b,error:b})}function d(b){a.find("form").addClass("hidden"),a.find("#form-success").removeClass("hidden").find(".media-body").text("Din melding er sendt til "+b+". De vil ta kontakt hvis de har behov for ytterligere informasjon")}function e(e){e.preventDefault();var f=a.find("#form_email").val(),g=a.find("#form_message").val();if(""===f||""===g)return!1;var h=_.extend({},b,{email:f,message:g});return c(h,function(){d(h.provider)}),!1}function f(){a.find("#form_email").val(""),a.find("#form_message").val(""),a.find("#form-success").addClass("hidden"),a.find("form").addClass("hidden"),a.find(".show-more").removeClass("hidden")}var g={message:"entry.126368279",email:"entry.748218122",id:"entry.2043404140",url:"entry.243673559",provider:"entry.826324496"},h="https://docs.google.com/forms/d/1ah66lattC8it7OTIM6de20NSNkBeiQ0vabpsHSaPU7s/formResponse",i=$("#response_form_template").html();a.append(i),a.find("form").on("submit",e),a.find(".show-more").click(function(){a.find(".show-more").addClass("hidden"),a.find("form").removeClass("hidden")}),a.find(".close ").click(f)};var KR=this.KR||{};!function(a){"use strict";function b(a){return function(b){if(!b||!b.features.length)return b;if(-1===b.features[0].geometry.type.indexOf("Polygon"))return turf.within(b,a);var c=_.filter(b.features,function(b){var c=turf.extent(b),d=turf.bboxPolygon(c);return!!turf.intersect(d,a.features[0])});return KR.Util.createFeatureCollection(c)}}function c(a,b,c,d,e){return c&&(b=KR.Config.getDatasets(b,a,d,e)),b}function d(a,b){var c={stroke:!1,fillColor:"#ddd",fillOpacity:.8},d=_.reduce(b.features,function(a,b){return turf.erase(a,b)},KR.Util.WORLD);L.geoJson(d,c).addTo(a)}function e(a,c,e,f,g,h,i,j){if(a.geomFilter){var k={api:"cartodb"};k[h]=g,c.getData(k,function(c){a.showGeom&&d(a.map,c);var f=L.geoJson(c),g=b(c);i(f.getBounds(),e,g,null,j)})}else f(g,function(a){var b=L.latLngBounds.fromBBoxString(a);i(b,e,null,null,j)})}function f(a,b,d,f,g,h){d=c(b,d,f,a.komm),_.isString(a.komm)&&(a.komm=a.komm.split(",")),e(a,b,d,b.getMunicipalityBounds,a.komm,"municipality",g,h)}function g(a,b,d,f,g,h){d=c(b,d,f,null,a.fylke),_.isString(a.fylke)&&(a.fylke=a.fylke.split(",")),e(a,b,d,b.getCountyBounds,a.fylke,"county",g,h)}function h(a,b,d,e,f,g){d=c(b,d,e);var h=L.latLngBounds.fromBBoxString(a.bbox);f(h,d,null,null,g)}function i(a){var b=[];return _.each(a.features,function(a){"GeometryCollection"===a.geometry.type?_.each(a.geometry.geometries,function(c){b.push(KR.Util.createGeoJSONFeatureFromGeom(c,a.properties))}):b.push(a)}),KR.Util.createFeatureCollection(b)}function j(a){var b=_.map(a.features,function(a){return turf.simplify(a,.01,!1)});return KR.Util.createFeatureCollection(b)}function k(a,d,e,f,g,h,k){var l={};e.linecolor&&(l.color=e.linecolor);var m=L.geoJson(a,l),n=m.getBounds();f=c(d,f,g);var o;if(a&&e.buffer){a=i(a),a.features.length>5&&(a=j(a));var p=turf.buffer(a,e.buffer,"kilometers");o=b(p)}h(n,f,o,m,k)}function l(a,b,c,d,e,f){KR.Util.getLine(b,a.line,function(g){k(g,b,a,c,d,e,f)})}function m(a){var b=KR.UrlFunctions.getHashFeature();if(b){var c=function(a){return decodeURIComponent(a.feature.id)===decodeURIComponent(b)||a.feature.id===decodeURIComponent(b)},d=_.find(_.flatten(a),function(a){return _.find(a.getLayers(),c)});if(d){var e=_.find(d.getLayers(),c);e.fire("click"),d.setLayerSelected(e)}}}function n(a,b){return _.map(a,function(a){return a.isStatic&&(a.fixedBbox=b),a.datasets&&(a.datasets=_.map(a.datasets,function(a){return a.isStatic&&(a.fixedBbox=b),a})),a})}function o(a){return _.map(a,function(a){return a.isStatic=!0,a.datasets&&(a.datasets=_.map(a.datasets,function(a){return a.isStatic=!0,a})),a})}var p={geomFilter:!1,showGeom:!1,loactionHash:!0,featureHash:!0};a.setupMap=function(a,b,c,d){function e(a,b,d,e,f){c.allstatic&&(b=o(b)),b=n(b,a.toBBoxString());var g=L.Knreise.LocateButton(null,null,{bounds:a});g.addTo(j);var h=function(f){f?(j.setView([f.lat,f.lon],f.zoom),a=j.getBounds()):j.fitBounds(a),c.loactionHash&&KR.UrlFunctions.setupLocationUrl(j);var g,h=function(a){m(a),i&&i.finishedLoading()};c.geomFilter&&a&&(g=a.toBBoxString());var k=q.loadDatasets(b,a.toBBoxString(),d,h,g);e&&e.addTo(j),b.length>1&&L.control.datasets(k).addTo(j)};c.initUserPos?(j.addOneTimeEventListener("locationChange",function(){var a={lat:j.userPosition.lat,lon:j.userPosition.lng,zoom:16};h(a)}),j.addOneTimeEventListener("locationError",function(){h(f)}),g.getLocation()):h(f)}c=c||{},c=_.extend({},p,c);var i,j=KR.Util.createMap("map",c),k=KR.Util.setupSidebar(j,{featureHash:c.featureHash}),q=new KR.DatasetLoader(a,j,k,null,c.cluster,c.clusterRadius);c.title&&(i=KR.SplashScreen(j,c.title,c.description,c.image,null,!1));var r,s=KR.UrlFunctions.getLocationUrl(j);return c.initUserPos||(r=s),c.map=j,c.komm?f(c,a,b,d,e,r):c.fylke?g(c,a,b,d,e,r):c.line?l(c,a,b,d,e,r):c.bbox?h(c,a,b,d,e,r):alert("Missing parameters!"),j},a.setupMapFromUrl=function(b,c,d){a.setupMap(b,c,d,!0)}}(KR);var KR=this.KR||{};KR.setupCollectionMap=function(a,b,c){"use strict";function d(a){var b=KR.Util.createMap("map",{layer:c});KR.SplashScreen(b,a.title,a.description,a.image,a.creator),$("title").append(a.title);var d=L.latLngBounds.fromBBoxArray(turf.extent(a.geo_json));_.each(a.geo_json.features,function(a){a.properties.datasetId=a.properties.provider,_.has(e,a.properties.provider)&&(a.template=e[a.properties.provider])});var f=KR.Util.setupSidebar(b),g=KR.Util.clusterClick(f),h=KR.Util.featureClick(f);L.Knreise.LocateButton(null,null,{bounds:d}).addTo(b),b.fitBounds(d);var i=L.Knreise.geoJson(a.geo_json,{onEachFeature:function(a,b){h(a,b)}}),j=(new L.Knreise.MarkerClusterGroup).addTo(b);j.addLayers(i.getLayers()),g(j)}var e={"Digitalt fortalt":KR.Util.getDatasetTemplate("digitalt_fortalt"),DigitaltMuseum:KR.Util.getDatasetTemplate("digitalt_museum"),Musit:KR.Util.getDatasetTemplate("musit"),Artsdatabanken:KR.Util.getDatasetTemplate("popup")};a.getCollection(b,d)};