var KR=this.KR||{};!function(a){"use strict";a.parseError=function(a){if(a.responseJSON){if(a.responseJSON.error)return a.responseJSON.error.join(", ");if(a.responseJSON.status)return a.responseJSON.status}return a.statusText?a.statusText:a.error?a.error.info?a.error.info:a.error.error?a.error.error:a.error:"Unknown error"},a.errorHandler=function(b){var c=$(b);c.find(".close").on("click",function(){c.find(".content").html(""),c.remove()});var d=_.template("<div><strong><%= dataset %>:</Strong> <%= error %></div>");return function(b){var e=d({dataset:b.dataset,error:a.parseError(b.error)});c.parent()?c.find(".content").append(e):c.find(".content").html(e),$("body").append(c)}}}(KR);var KR=this.KR||{};KR.Config={contentIcons:{IMAGE:"camera-retro",VIDEO:"file-video-o",SOUND:"music",TEXT:"file-text","default":"file-o"},templates:{}},KR.Util=KR.Util||{},function(a){"use strict";function b(a,b){if(b.datasets){var c=_.find(b.datasets,function(b){return b._knreise_id===a.properties.datasetID});return c.template}return b.template}function c(a,b){var c=a.lastIndexOf(b);return-1!==c&&c+b.length===a.length}a.iconForContentType=function(a){var b=a.properties.contentType;return _.has(KR.Config.contentIcons,b)?KR.Config.contentIcons[b]:KR.Config.contentIcons["default"]},a.getDatasetTemplate=function(a){var b=$("#"+a+"_template").html();return b?_.template(b):void 0},a.templateForDataset=function(a){return _.has(KR.Config.templates,a)?KR.Config.templates[a]:void 0},a.iconForDataset=function(a){return _.isArray(a)&&(a=a.join("_")),_.has(KR.Config.datasetIcons,a)?KR.Config.datasetIcons[a]:void 0},a.createStyleString=function(a){return _.map(a,function(a,b){return b+": "+a}).join(";")},a.colorForProvider=function(a,b){var c=!0;"hex"!==b&&(c=!1);var d={properties:{datasetId:a}};return KR.Style.colorForFeature(d,c,!0)},a.featureClick=function(a){return function(b,c,d){c.on("click",function(c){d.toPoint&&d.toPoint.stopPolyClick&&!c.parent||(d?a.showFeature(b,d.template,d.getFeatureData):a.showFeature(b))})}},a.clusterClick=function(a){return function(c,d){c.on("clusterclick",function(c){var e=_.map(c.layer.getAllChildMarkers(),function(a){var c=a.feature;return c.template=b(c,d),c});a.showFeatures(e,d.template,d.getFeatureData,d.noListThreshold)})}},a.hexToRgba=function(a,b){b=b||1;var c=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(a);if(!c)return 0;var d={r:parseInt(c[1],16),g:parseInt(c[2],16),b:parseInt(c[3],16)};return"rgba("+d.r+","+d.g+","+d.b+","+b+")"},a.filterByBbox=function(a,b){var c=turf.featurecollection([turf.bboxPolygon(KR.Util.splitBbox(b))]);return turf.within(a,c)},a.getDatasetId=function(a){return"norvegiana"!==a.dataset.api||a.dataset.query?"wikipedia"===a.dataset.api?"wikipedia":a.id?a.id:KR.Util.stamp(a):a.dataset.dataset},"undefined"!=typeof L&&(L.latLngBounds.fromBBoxString=function(a){return a=KR.Util.splitBbox(a),new L.LatLngBounds(new L.LatLng(a[1],a[0]),new L.LatLng(a[3],a[2]))}),a.parseQueryString=function(a){var b=decodeURIComponent(a);if(""!==b)return _.reduce(b.replace("?","").split("&"),function(a,b){b=b.split("=");var c=b[1];return"true"===c?c=!0:"false"===c&&(c=!1),a[b[0]]=c,a},{})};var d=_.template("<%= totalt %> (<%= menn %> menn, <%= kvinner %> kvinner)");a.formatPersons=function(a){var b=a.split("-");return b.length<2?a:d({totalt:b[0],menn:b[1],kvinner:b[2]})},a.getBaseLayer=function(a,b){var c={nib:KR.getNibLayer,hist:function(a){a(L.tileLayer.wms("http://wms.geonorge.no/skwms1/wms.historiskekart",{layers:"historiskekart",format:"image/png",attribution:"Kartverket"}))}};_.has(c,a)?c[a](b):b(L.tileLayer.kartverket(a))},a.getLine=function(a,b,d){if(_.isFunction(b))return void b(function(a){d(a)});var e;if(0===b.indexOf("utno/")){var f=b.replace("utno/","");e={api:"utno",id:f,type:"gpx"}}else 0===b.indexOf("http")&&c(b,"kml")&&(e={api:"kml",url:b});e&&a.getData(e,function(a){d(a)})}}(KR.Util);var KR=this.KR||{};KR.Style={},function(a){"use strict";function b(a){var b=a.properties.vernef_id;return _.find(o,function(a){return-1!==a.ids.indexOf(b)})}function c(a){return t[a]||"blue"}function d(a,b,c,d){return _.isFunction(a[b])?d?a[b]():a[b](c):a[b]}function e(a,b,c){return c?d(a,"fillcolor",b,!0):d(a,"fillcolor",b)}function f(a,b){return a.bordercolor?d(a,"bordercolor",b):e(a,b)}function g(b){var c;return b.properties&&b.properties.datasetId&&(c=a.getDatasetStyle(b.properties.datasetId)),c?c:_.extend({},r)}function h(a,b,c){return c=c||9,{radius:c,weight:1,opacity:1,color:a,fillColor:b,fillOpacity:.4}}function i(a,b,c){return L.circleMarker(a,h(b,c))}function j(a){return L.Knreise.icon({markerColor:c(a)})}function k(a,b,c){var d="";return a.properties&&a.properties.title&&(d=a.properties.title),L.marker(b,{icon:c,title:d})}function l(a,b,c){if(a.properties&&a.properties.thumbnail){var d={"border-color":b,"background-image":"url("+a.properties.thumbnail+")"};c&&(d["border-width"]="3px");var e='<div class="outer"><div class="circle" style="background-image: url('+a.properties.thumbnail+");border-color:"+b+';"></div></div>';return new L.DivIcon({className:"leaflet-marker-circle",html:e,iconSize:[50,50],iconAnchor:[25,25]})}}function m(a,b,c){var d=_.filter(a,function(a){return a.feature.properties.thumbnail});if(d.length){var e={"border-color":b,"background-image":"url("+d[0].feature.properties.thumbnail+");"};c&&(e["border-width"]="3px");var f='<div class="outer"><div class="circle" style="'+KR.Util.createStyleString(e)+'"></div></div><b>'+a.length+"</b>";return new L.DivIcon({className:"leaflet-marker-photo",html:f,iconSize:[60,60],iconAnchor:[30,30]})}}function n(a,b){var c=KR.Util.hexToRgba(b,.4);return new L.DivIcon({className:"leaflet-marker-circle",html:'<div class="outer"><div class="circle" style="background-color: '+c+";border-color:"+b+';"></div></div><b>'+a.length+"</b>",iconSize:[20,20],iconAnchor:[10,10]})}var o={landskapsvern:{ids:["LVO","LVOD","LVOP","LVOPD","BV","MAV","P","GVS","MIV","NM","BVV","PO","DO","D"],style:{fillColor:"#d8cb7a",color:"#9c8f1b"}},nasjonalpark:{ids:["NP","NPS"],style:{fillColor:"#7f9aac",color:"#b3a721"}},naturreservat:{ids:["NR","NRS"],style:{fillColor:"#ef9874",color:"#ef9873"}}},p="#72B026",q="#38A9DC",r={fillcolor:q,circle:!1,thumbnail:!0},s={difo:"Digitalt fortalt",Kulturminnesok:"Kulturminnesok",DiMu:"DigitaltMuseum",MUSIT:"Musit",Artsdatabanken:"Artsdatabanken",wikipedia:"wikipedia",riksantikvaren:"riksantikvaren"};a.datasets={"Digitalt fortalt":{fillcolor:"#F69730",circle:!1,thumbnail:!0},Kulturminnesok:{fillcolor:"#436978",circle:!1,thumbnail:!1},DigitaltMuseum:{fillcolor:"#436978",circle:!1,thumbnail:!1},Musit:{fillcolor:"#436978",circle:!1,thumbnail:!1},Artsdatabanken:{fillcolor:"#5B396B",thumbnail:!1,circle:!0},riksantikvaren:{fillcolor:"#436978",circle:!1,thumbnail:!0},verneomraader:{fillcolor:function(a){if(a){var c=b(a);if(c)return c.style.fillColor}return"#009300"},bordercolor:function(a){if(a){var c=b(a);if(c)return c.style.color}return"#009300"},thumbnail:!1,circle:!0},wikipedia:{fillcolor:"#D14020",thumbnail:!0}},a.getDatasetStyle=function(b){var c=a.datasets[s[b]];return c||(c=a.datasets[b]),c},a.setDatasetStyle=function(b,c){_.has(s,b)||(s[b]=b);var d=a.getDatasetStyle(b);d||(d=r),a.datasets[s[b]]=_.extend({},d,c)};var t={"#F69730":"orange","#38A9DC":"blue","#A23336":"darkred","#72B026":"green","#436978":"cadetblue","#5B396B":"darkpurple","#728224":"darkgreen","#D252B9":"purple","#D14020":"red"};a.getClusterIcon=function(a,b){var c=a.getAllChildMarkers(),d=g(c[0].feature),f=b?p:e(d,c[0].feature);if(d.thumbnail){var h=m(c,f,b);if(h)return h}return n(c,f)},a.getIcon=function(a,b){var c=g(a),d=b?p:e(c,a),i=b?p:f(c,a);if(c.thumbnail){var k=l(a,i,b);if(k)return k}return c.circle?h(i,d,c.radius):j(d)},a.getMarker=function(b,c){var d=g(b);if(d.thumbnail){var h=l(b,f(d,b),!1);if(h)return k(b,c,h)}return d.circle?i(c,f(d,b),e(d,b)):k(b,c,a.getIcon(b,!1))},a.colorForFeature=function(a,b,d){var f=g(a);return f?b?e(f,a,d):c(e(f,a)):void 0},a.getPathStyle=function(a,b){b=b||!1;var c=g(a),d=e(c,a),h=f(c,a);return{weight:1,color:h,fillColor:d,clickable:b,opacity:.8,fillOpacity:.4}}}(KR.Style),L.Knreise=L.Knreise||{},L.Knreise.MarkerClusterGroup=L.MarkerClusterGroup.extend({options:{zoomToBoundsOnClick:!1,spiderfyOnMaxZoom:!1,polygonOptions:{fillColor:"#ddd",weight:2,color:"#999",fillOpacity:.6}},initialize:function(a){L.Util.setOptions(this,a),this.options.iconCreateFunction||(this.options.iconCreateFunction=this._iconCreator.bind(this)),this._featureGroup=L.featureGroup(),this._featureGroup.on(L.FeatureGroup.EVENTS,this._propagateEvent,this),this._nonPointGroup=L.featureGroup(),this._nonPointGroup.on(L.FeatureGroup.EVENTS,this._propagateEvent,this),this._inZoomAnimation=0,this._needsClustering=[],this._needsRemoving=[],this._currentShownBounds=null,this._queue=[],this.on("clusterclick",this._clusterClicked,this)},onAdd:function(a){L.MarkerClusterGroup.prototype.onAdd.apply(this,arguments),a.on("layerSelected",this._deselectAll,this)},_deselectAll:function(){_.each(this._gridClusters,function(a){_.each(a._grid,function(a){_.each(a,function(a){_.each(a,function(a){a.selected&&(a.createIcon=_.bind(L.MarkerCluster.prototype.createIcon,a),a._updateIcon(),a.selected=!1)})})})}),this.eachLayer(function(a){a.selected&&(a.createIcon=_.bind(L.MarkerCluster.prototype.createIcon,a),a.setIcon(_.bind(L.Knreise.GeoJSON.prototype._createFeatureIcon,this)(a.feature)),a.selected=!1)},this)},_clusterClicked:function(a){this._map.fire("layerSelected");var b=a.layer,c=_.bind(this._iconCreator,this);b.createIcon=function(){return c(this,!0).createIcon()},b.selected=!0,b._updateIcon()},_iconCreator:function(a,b){return KR.Style.getClusterIcon(a,b)}}),L.Knreise.markerClusterGroup=function(a){return new L.Knreise.MarkerClusterGroup(a)},L.Knreise=L.Knreise||{},L.Knreise.GeoJSON=L.GeoJSON.extend({initialize:function(a,b){L.setOptions(this,b),this._layers={},this.options.pointToLayer=this._pointToLayer.bind(this),a&&this.addData(a),this.on("click",this._featureClicked,this),this._selectedLayer=null},removedPaths:[],isCollapsed:function(a,b){var c=this.options.dataset.toPoint.minSize||20,d=a.getBounds(),e=this._map.project(d.getNorthEast(),b),f=this._map.project(d.getSouthWest(),b),g=e.x-f.x,h=f.y-e.y;return c>h||c>g},_deselectAll:function(){if(this._selectedLayer){var a=this._selectedLayer;if(a.setIcon&&(a.setIcon(this._createFeatureIcon(a.feature,!1)),a.setZIndexOffset(0)),a.setStyle){var b=a.feature;if(!b){var c=this.getParentLayer(a._leaflet_id);b=c.feature}if(a.setStyle(this._createFeatureIcon(b,!1)),a.getParent){var d=a.getParent();d.setStyle(this._createFeatureIcon(b,!1))}}this._selectedLayer=null}},_featureClicked:function(a){if(!(this.options.dataset&&this.options.dataset.toPoint&&this.options.dataset.toPoint.stopPolyClick&&"Point"!==a.layer.toGeoJSON().geometry.type)){a.layer._map.fire("layerSelected");var b=a.layer;if(b.setIcon&&(b.setIcon(this._createFeatureIcon(b.feature,!0)),b.setZIndexOffset(1e3)),b.setStyle){var c=b.feature;if(!c){var d=this.getParentLayer(b._leaflet_id);c=d.feature}if(c&&(b.setStyle(this._createFeatureIcon(c,!0)),b.bringToFront()),b.getParent){var e=b.getParent();e.setStyle(this._createFeatureIcon(c,!0))}}this._selectedLayer=b}},getParentLayer:function(a){var b=this._layers[a];if(b)return b;var c,d,e;for(c in this._layers)if(this._layers.hasOwnProperty(c)&&(d=this._layers[c],d.getLayer&&(e=d.getLayer(a))))return d},getZoomThreshold:function(a){var b=null,c=this._map.getZoom();if(this.isCollapsed(a,this._map.getZoom()))for(;!b;)c+=1,this.isCollapsed(a,c)||(b=c-1);else for(;!b;)c-=1,this.isCollapsed(a,c)&&(b=c);return b},_zoomend:function(){if(this.options.dataset.toPoint){var a,b,c=[];for(this.eachLayer(function(a){this._map.getZoom()<=a.zoomThreshold&&(this.removeLayer(a),this.options.dataset.toPoint.showAlways||this.addLayer(a.marker),c.push(a))},this),b=0;b<this.removedPaths.length;b++)a=this.removedPaths[b],this._map.getZoom()>a.zoomThreshold&&(this.options.dataset.toPoint.showAlways||this.removeLayer(a.marker),this.addLayer(a),this.removedPaths.splice(b,1),b-=1);this.removedPaths=this.removedPaths.concat(c)}},_getCenter:function(a){if("undefined"!=typeof turf){var b=turf.pointOnSurface(a.toGeoJSON());return L.latLng(b.geometry.coordinates.reverse())}return a.getBounds().getCenter()},_layeradd:function(a){var b=a.layer;if("Point"===b.feature.geometry.type||b.isMarker||(b.setStyle(KR.Style.getPathStyle(b.feature)),b.bringToBack()),this.options.dataset.toPoint){if(b.isMarker)return;if(b.getBounds&&!b.zoomThreshold&&!b.marker){var c=this.getZoomThreshold(b),d=this._pointToLayer(b.feature,this._getCenter(b));d.feature=b.feature,d.on("click",function(a){b.fire("click",{containerPoint:a.containerPoint,latlng:a.latlng,layerPoint:a.layerPoint,originalEvent:a.originalEvent,target:a.target,type:a.type,parent:!0})}),b.zoomThreshold=c,this.removedPaths.push(b),b.marker=d,b.marker.isMarker=!0,b.marker.getParent=function(){return b},this._map.getZoom()<=c&&(this.removeLayer(b),this.options.dataset.toPoint.showAlways||this.addLayer(b.marker)),this.options.dataset.toPoint.showAlways&&this.addLayer(b.marker)}}},setMap:function(a){a.on("layerSelected",this._deselectAll,this)},onAdd:function(a){L.GeoJSON.prototype.onAdd.apply(this,arguments),this.options.dataset&&this.options.dataset.toPoint&&(this._zoomend(),a.on("zoomend",this._zoomend,this),this.on("layeradd",this._layeradd,this)),this.setMap(a)},_createFeatureIcon:function(a,b){return KR.Style.getIcon(a,b)},_pointToLayer:function(a,b){return KR.Style.getMarker(a,b)}}),L.Knreise.geoJson=function(a,b){return new L.Knreise.GeoJSON(a,b)},L.Knreise=L.Knreise||{},L.Knreise.Control=L.Knreise.Control||{},L.Knreise.Control.Sidebar=L.Control.Sidebar.extend({initialize:function(a,b){b=b||{},b.autoPan=!1,L.setOptions(this,b);var c=L.DomUtil.get(a);L.DomEvent.on(c,"click",function(a){L.DomEvent.stopPropagation(a)}),c.parentNode.removeChild(c);var d=L.DomUtil.create("div","top-menu",c);this._contentContainer=L.DomUtil.create("div","sidebar-content",c),this.on("hide",this._removeContent,this);var e="leaflet-",f=this._container=L.DomUtil.create("div",e+"sidebar knreise-sidebar "+this.options.position);if(this.options.closeButton){var g=this._closeButton=L.DomUtil.create("a","close pull-right",d);g.innerHTML="&times;"}this._top=L.DomUtil.create("span","",d),L.DomUtil.addClass(c,e+"control"),f.appendChild(c),this.on("hide",function(){this._map&&this._map.fire("layerSelected")},this),this.sidebar=new KR.SidebarContent(this._container,this._contentContainer,this._top,this.options)},showFeature:function(a,b,c,d,e,f){this.show(),this.sidebar.showFeature(a,b,c,d,e,f)},showFeatures:function(a,b,c,d,e){this.show(),this.sidebar.showFeatures(a,b,c,d,e)},_removeContent:function(){$(this.getContainer()).html("")}}),L.Knreise.Control.sidebar=function(a,b){return new L.Knreise.Control.Sidebar(a,b)};var KR=this.KR||{};KR.SidebarContent=function(a,b,c,d){"use strict";function e(a){b.html(a)}function f(a){a&&b.swipe({swipe:function(){},allowPageScroll:"vertical"}).off("swipeLeft").on("swipeLeft",function(){a.next&&a.next()}).off("swipeRight").on("swipeRight",function(){a.prev&&a.prev()})}function g(a,b,c,e,f,h){var k;b>0&&(k=function(d){d&&d.preventDefault(),b-=1,a=f[b];var j=g(a,b,c,e,f,h);i(a,c,e,j,b,f.length)});var l;return b<f.length-1&&(l=function(d){d&&d.preventDefault(),b+=1,a=f[b];var j=g(a,b,c,e,f,h);i(a,c,e,j,b,f.length)}),h||(h=function(){j(f,c,e,d.noListThreshold,!0)}),{prev:k,close:h,next:l}}function h(a,b,c,e,f){var h;h=a.properties.thumbnail?d.thumbnailTemplate({thumbnail:a.properties.thumbnail,color:KR.Style.colorForFeature(a,!0)}):d.markerTemplate({icon:"",color:KR.Style.colorForFeature(a)});var j=$(d.listElementTemplate({title:a.properties.title,marker:h}));return j.on("click",function(d){d.preventDefault();var h=g(a,b,c,e,f);return i(a,c,e,h,b,f.length),!1}),j}function i(g,h,j,l,m,n){if(j)return e(""),void j(g,function(a){a.properties=_.extend(g.properties,a.properties),i(a,h,null,l,m,n)});h=h||g.template||KR.Util.templateForDataset(g.properties.dataset)||k;var o=g.properties.images;_.isArray(o)&&(o=o[0]),g.properties.allProps&&g.properties.allProps.europeana_rights?g.properties.license=g.properties.allProps.europeana_rights[0]:g.properties.license=null;var p=KR.Style.colorForFeature(g,!0,!0),q='<span class="providertext" style="color:'+p+';">'+g.properties.provider+"</span>"+h(_.extend({image:null},g.properties));if(d.footerTemplate&&g.properties.link&&(q+=d.footerTemplate(g.properties)),e(q),f(l),a.find(".prev-next-arrows").remove(),c.html(""),l){var r=$('<a class="pull-left list-btn"><i class="fa fa-bars"></i></a>');c.append(r),r.click(l.close);var s=m+1;c.append($('<div class="top-text pull-left">'+s+" av "+n+"</div>"));var t=$('<a class="prev-next-arrows prev circle"><span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span></a>');a.append(t),l.prev&&t.click(l.prev).addClass("active");var u=$('<a class="prev-next-arrows next circle"><span class="glyphicon glyphicon-chevron-right" aria-hidden="true"></span></a>');a.append(u),l.next&&u.click(l.next).addClass("active")}"undefined"!=typeof audiojs&&audiojs.createAll(),b.scrollTop(0)}function j(a,e,f,i,j){i=void 0===i?d.noListThreshold:i;var k=a.length<=i;if(k&&j!==!0){var l=a[0];b.html("");var m=g(l,0,e,f,a);return void this.showFeature(l,e,f,m,0,a.length)}var n=$('<span class="circle">'+a.length+"</span>");c.html(n);var o=_.chain(a).groupBy(function(a){return a.properties.provider}).map(function(b,c){var d=$("<div></div>"),g=$('<div class="list-group"></ul>'),i=_.map(b,function(b){var c=_.findIndex(a,function(a){return a===b});return h(b,c,e,f,a)},this);return g.append(i),d.append('<h5 class="providertext">'+c+"</h5>"),d.append(g),d}).value();b.html(o),b.scrollTop(0)}var k=KR.Util.getDatasetTemplate("popup");return b=$(b),a=$(a),c=$(c),{showFeature:i,showFeatures:j}},function(){"use strict";L.Knreise=L.Knreise||{},L.Knreise.Control=L.Knreise.Control||{};var a=function(a,b){function c(){return a.grouped?a.datasets[0].extras.datasetId:a.extras.datasetId}function d(d){var e=document.createElement("i");return e.className="layericon fa",a.visible?e.className+=" fa-check-square-o":e.className+=" fa-square-o",d&&(e.className+=" "+d),b.isLoading&&(e.className="layericon fa fa-spinner fa-pulse"),b.enabled?e.style.color=KR.Style.colorForFeature({properties:{datasetId:c()}},!0,!0):e.style.color="#ddd",e}function e(){var a=d();k.replaceChild(a,l),l=a}function f(){a.visible=!a.visible,e(),a.visible?b.fire("show"):b.fire("hide")}function g(a){n=L.DomUtil.create("i","error-icon fa fa-exclamation-triangle"),n.setAttribute("title",KR.parseError(a)),k.insertBefore(n,k.childNodes[0])}function h(){k=document.createElement("label"),_.isUndefined(a.visible)&&(a.visible=!0);var c=document.createElement("span");c.innerHTML=" "+a.name,l=d(),k.appendChild(l),k.appendChild(c),b.error&&g(b.error),b.enabled||(k.className="disabled"),L.DomEvent.on(k,"click",function(){var a=b.enabled&&!b.isLoading;a&&f()})}function i(){b.enabled!==m&&(m=b.enabled,e(),m?k.className=k.className.replace("disabled",""):k.className+="disabled")}function j(){return k}var k,l,m=b.enabled,n=null;return h(),b.on("changeEnabled",i),b.on("dataloadstart",function(){n&&(k.removeChild(n),n=null),e()}),b.on("dataloadend",e),b.on("error",g),{getLabel:j,hasError:function(){return!!b.error}}};L.Control.Datasets=L.Control.extend({initialize:function(a,b){L.setOptions(this,b),this._labels=[],this._handlingClick=!1,this.expanded=!1,this.numLoading=0;var c;for(c in a)a.hasOwnProperty(c)&&this._addLayer(a[c])},_addLayer:function(a){var b,c=a.options.dataset;if(c.datasets)if(c.grouped)this._addDataset(c,a);else for(b=0;b<c.datasets.length;b++)this._addDataset(c.datasets[b]);else this._addDataset(c,a)},_addDataset:function(b,c){c.isLoading&&(this.numLoading+=1,this._checkSpinner());var d=new a(b,c);this._labels.push(d),c.on("dataloadstart",function(){this._loadStart()},this),c.on("dataloadend",function(){this._loadEnd()},this)},_loadStart:function(){this.numLoading+=1,this._checkSpinner()},_loadEnd:function(){this.numLoading-=1,this._checkSpinner()},_hasErrors:function(){return!!_.find(this._labels,function(a){return a.hasError()})},_checkError:function(){this._hasErrors()?this._errorIcon.className=this._errorIcon.className.replace(" hidden",""):this._errorIcon.className.indexOf("hidden")<0&&(this._errorIcon.className+=" hidden")},_checkSpinner:function(){this._btnIcon&&(0===this.numLoading?(this._btnIcon.className=this._btnIcon.className.replace(" fa-spinner fa-pulse"," fa-bars"),this._checkError()):(this._errorIcon.className.indexOf("hidden")<0&&(this._errorIcon.className+=" hidden"),this._btnIcon.className=this._btnIcon.className.replace(" fa-bars"," fa-spinner fa-pulse")))},onAdd:function(a){return this._map=a,this._initLayout(),this._update(),this._container},_update:function(){if(this._container){this._overlaysList.innerHTML="";var a,b;for(a=0;a<this._labels.length;a++)b=this._labels[a],this._overlaysList.appendChild(b.getLabel());this._checkError()}},_initLayout:function(){var a="leaflet-control-layers";this._container=L.DomUtil.create("div",""),this._container.setAttribute("aria-haspopup",!0),L.Browser.touch?L.DomEvent.on(this._container,"click",L.DomEvent.stopPropagation):L.DomEvent.disableClickPropagation(this._container).disableScrollPropagation(this._container),this._form=L.DomUtil.create("form",a+"-list"),this._map.on("click",this._collapse,this),this._overlaysList=L.DomUtil.create("div",a+"-overlays",this._form),this._closeDiv=L.DomUtil.create("div","clearfix");var b=L.DomUtil.create("button","btn btn-default pull-right",this._closeDiv);b.title="Kartlag",L.DomEvent.on(b,"click",function(){this._toggle()},this),this._errorIcon=L.DomUtil.create("i","error-icon fa fa-exclamation-triangle hidden",b),b.appendChild(document.createTextNode(" ")),this.numLoading>0?this._btnIcon=L.DomUtil.create("i","fa fa-spinner fa-pulse",b):this._btnIcon=L.DomUtil.create("i","fa fa-bars",b),this._container.appendChild(this._closeDiv),this._listContainer=L.DomUtil.create("div",a+" hidden"),this._listContainer.appendChild(this._form),this._container.appendChild(this._listContainer)},_toggle:function(){this.expanded?this._collapse():this._expand()},_expand:function(){L.DomUtil.addClass(this._listContainer,"leaflet-control-layers-expanded"),this.expanded=!0,this._listContainer.className=this._listContainer.className.replace(" hidden","")},_collapse:function(){this._listContainer.className=this._listContainer.className.replace(" leaflet-control-layers-expanded",""),L.DomUtil.addClass(this._listContainer,"hidden"),this.expanded=!1}}),L.control.datasets=function(a,b){return new L.Control.Datasets(a,b)}}(),L.Knreise=L.Knreise||{},L.Knreise.Icon=L.AwesomeMarkers.Icon.extend({options:{icon:null}}),L.Knreise.icon=function(a){return new L.Knreise.Icon(a)};var KR=this.KR||{};KR.DatasetLoader=function(a,b,c,d){"use strict";function e(a){var b=KR.Util.stamp(a);return function(c){return c&&c.features.length?(_.each(c.features,function(c){c.properties.datasetID=b,_.has(a,"circle")&&(c.properties.circle=a.circle),_.has(a,"provider")&&(c.properties.provider=a.provider),_.has(a,"extras")&&(c.properties=_.extend(c.properties,a.extras)),_.has(a,"mappings")&&_.each(a.mappings,function(a,b){c.properties[b]=c.properties[a]})}),c):c}}function f(a){var b=_.reduce(_.without(_.keys(a),"datasets"),function(b,c){return b[c]=a[c],b},{});return a.datasets=_.map(a.datasets,function(a){return _.extend({},b,a)}),a}function g(a,b){var c={dataset:b,onEachFeature:function(a,c){x&&x(a,c,b)}};return b.style&&(c.style=b.style),L.Knreise.geoJson(a,c)}function h(a,b){a.clearLayers();var c=_.reduce(b,function(a,b){return a.concat(b.toGeoJSON().features)},[]);a.addData(KR.Util.createFeatureCollection(c))}function i(a,c){a.clearLayers();var d=_.reduce(c,function(a,c){return c.setMap(b),a.concat(c.getLayers())},[]);a.addLayers(d)}function j(a,b){a.on("hide",function(){b(!0)}),a.on("show",function(){b(!0)})}function k(a,b){var c;a.cluster?(c=new L.Knreise.MarkerClusterGroup({dataset:a}).addTo(b),w&&w(c,a)):c=g(null,a).addTo(b);var d=!0;return a.minFeatures&&(d=!1),c.enabled=d,c}function l(a,b){a.enabled!==b&&(a.enabled=b,a.fire("changeEnabled"))}function m(a){if(a.datasets&&!a.grouped){var b=_.filter(a.datasets,function(a){return a.visible}).length;return b>0}return a.visible}function n(a){return a.minZoom&&b.getZoom()<a.minZoom?!1:m(a)}function o(a){return a.minZoom&&b.getZoom()<a.minZoom?!1:!0}function p(a){return a.datasets?0===_.filter(a.datasets,function(a){return a.isStatic===!1}).length:a.isStatic}function q(a){var c=[];a.datasets?c=a.datasets:c.push(a),_.each(c,function(a){if(a.loadWhenLessThan){var c=function(){if(a.geoJson){var c=turf.bboxPolygon(KR.Util.splitBbox(b.getBounds().toBBoxString())),d=_.filter(a.geoJson.features,function(a){return turf.inside(a,c)});d.length<=a.loadWhenLessThan.count?a.loadWhenLessThan.callback(b,a,d):a.loadWhenLessThan.callback(b,a)}};b.on("moveend",c),c()}})}function r(a){a.init&&a.init(b,a)}function s(c,f,m){function s(a,b){if(c.minFeatures){if(a.numFound&&c.minFeatures<a.numFound)return l(b,!1),KR.Util.createFeatureCollection([]);l(b,!0)}return a}var t=k(c,b);c.datasets?(c.datasets=_.filter(c.datasets,function(a){return!a.noLoad}),_.each(c.datasets,r)):r(c);var u,v=function(j,k,l,m){var p=!j;t.enabled=o(c),t.fire("changeEnabled");var q=l||n(c);if(!q)return void t.clearLayers();var r,v=k||b.getBounds().toBBoxString();r=c.datasets?_.filter(c.datasets,function(a){return a.visible}):[c];var w=[],x=_.after(r.length,function(){t.isLoading=!1,t.fire("dataloadend"),c.cluster?i(t,w):h(t,w),m&&m()});t.isLoading=!0,t.fire("dataloadstart"),_.each(r,function(b){function c(a){b.geoJson=a,t.error=null,f&&(a=f(a));var c;b.cluster?(c=g(i(s(a,t)),b),b.geoJSONLayer=c):c=L.geoJson(i(s(a,t))),w.push(c),x()}function h(a){t.error=a,x(),"abort"!==a.statusText&&(d?d({dataset:b.name,error:a,layer:t}):t.fire("error",a))}var i=e(b);return!p&&b.isStatic||u===v?void c(b.geoJson):void(b.bbox?a.getBbox(b.dataset,v,c,h):a.getData(b.dataset,c,h))}),u=v};return v(null,m,void 0,function(){q(c)}),(!p(c)||c.minZoom)&&b.on("moveend",v),j(t,v),{layer:t,reload:v}}function t(a){var b=KR.Util.getDatasetId(a);a.extras=a.extras||{},a.extras.datasetId=b,a.style&&KR.Style.setDatasetStyle(b,a.style)}function u(a,b){var c=_.after(y.length,function(){b&&b()});_.each(y,function(b){b(null,null,a,c)})}function v(a,b,c){a=_.filter(a,function(a){return!a.noLoad});var d=_.map(a,function(a){return a=_.extend({},z,a),a.datasets&&f(a),KR.Style.setDatasetStyle&&(a.datasets?_.each(a.datasets,t):t(a)),a.visible||(a.notLoaded=!0),a.minZoom&&a.bbox&&(a.isStatic=!1),s(a,c,b)});return y=_.pluck(d,"reload"),_.pluck(d,"layer")}var w,x,y=[],z={isStatic:!0,bbox:!0,cluster:!0,visible:!0};return c&&(w=KR.Util.clusterClick(c),x=KR.Util.featureClick(c)),{loadDatasets:v,reload:u}},L.Knreise=L.Knreise||{},function(a){"use strict";a.LocateButton=function(a,b,c){function d(b){var c=L.latLng(b.coords.latitude,b.coords.longitude);a?a(c):g.setView(c,16)}function e(){navigator.geolocation?navigator.geolocation.getCurrentPosition(d):b&&b()}function f(a){var b=c.title||"Finn meg",d=c.icon||"fa-user";return g=a,L.easyButton(a,e,{icon:d,title:b})}c=c||{},c.zoom=c.zoom||10;var g;return{addTo:f}}}(L.Knreise);var KR=this.KR||{};L.TileLayer.WMTS=L.TileLayer.extend({defaultWmtsParams:{service:"WMTS",request:"GetTile",version:"1.0.0",layer:"",style:"",tilematrixSet:"",format:"image/jpeg"},initialize:function(a,b){this._url=a;var c=L.extend({},this.defaultWmtsParams),d=b.tileSize||this.options.tileSize;c.width=c.height=b.detectRetina&&L.Browser.retina?2*d:d;for(var e in b)this.options.hasOwnProperty(e)||"matrixIds"==e||(c[e]=b[e]);this.wmtsParams=c,this.matrixIds=b.matrixIds||this.getDefaultMatrix(),L.setOptions(this,b)},onAdd:function(a){L.TileLayer.prototype.onAdd.call(this,a)},getTileUrl:function(a,b){var c=this._map;return crs=c.options.crs,tileSize=this.options.tileSize,nwPoint=a.multiplyBy(tileSize),nwPoint.x+=1,nwPoint.y-=1,sePoint=nwPoint.add(new L.Point(tileSize,tileSize)),nw=crs.project(c.unproject(nwPoint,b)),se=crs.project(c.unproject(sePoint,b)),tilewidth=se.x-nw.x,b=c.getZoom(),ident=this.matrixIds[b].identifier,X0=this.matrixIds[b].topLeftCorner.lng,Y0=this.matrixIds[b].topLeftCorner.lat,tilecol=Math.floor((nw.x-X0)/tilewidth),tilerow=-Math.floor((nw.y-Y0)/tilewidth),url=L.Util.template(this._url,{s:this._getSubdomain(a)}),url+L.Util.getParamString(this.wmtsParams,url)+"&tilematrix="+ident+"&tilerow="+tilerow+"&tilecol="+tilecol},setParams:function(a,b){return L.extend(this.wmtsParams,a),b||this.redraw(),this},getDefaultMatrix:function(){for(var a=new Array(22),b=0;22>b;b++)a[b]={identifier:""+b,topLeftCorner:new L.LatLng(20037508.3428,-20037508.3428)};return a}}),L.tileLayer.wmts=function(a,b){return new L.TileLayer.WMTS(a,b)},function(a){"use strict";function b(a){for(var b=new Array(30),c=0;22>c;c++)b[c]={identifier:a+":"+c,topLeftCorner:new L.LatLng(20037508,-20037508.34)};return b}a.SKTokenUrl="http://localhost:8001/html/baat/?type=token",a.getNibLayer=function(c,d){a.Util.sendRequest(KR.SKTokenUrl,null,function(a){var e;if(d)e=L.tileLayer.wms("http://gatekeeper2.geonorge.no/BaatGatekeeper/gk/gk.nibcache",{layers:"NiB",format:"image/jpeg",transparent:!1,attribution:"Kartverket"});else{var f="http://gatekeeper1.geonorge.no/BaatGatekeeper/gk/gk.nibcache_wmts",g="EPSG:900913";e=new L.TileLayer.WMTS(f,{layer:"NiB",style:"normal",tilematrixSet:g,matrixIds:b(g),format:"image/jpeg",attribution:"Kartverket"})}e.setParams({GKT:a}),c(e)})}}(KR);var KR=this.KR||{};KR.Config=KR.Config||{},function(a){"use strict";a.getKulturminneFunctions=function(a){var b=function(b,c,d){if(d||c.extraFeatures.clearLayers(),d){var e=_.map(d,function(a){return a.properties.id});if(e.length){var f={api:"kulturminnedataSparql",type:"lokalitetpoly",lokalitet:e};a.getData(f,function(a){c.extraFeatures.clearLayers().addData(a)})}}},c=function(a,b){b.extraFeatures=L.geoJson(null,{onEachFeature:function(a,c){a.properties.datasetId=b.id,c.setStyle(KR.Style.getPathStyle(a,!0)),c.on("click",function(){var c=_.find(b.geoJSONLayer.getLayers(),function(b){return b.feature.properties.id===a.properties.lok});c&&c.fire("click")})}}).addTo(a)};return{loadKulturminnePoly:b,initKulturminnePoly:c}},a.getDatasetList=function(b,c){var d=a.getKulturminneFunctions(b);c&&3===c.length&&(c="0"+c);var e={difo:{name:"Digitalt fortalt",dataset:{dataset:"difo",api:"norvegiana"},cluster:!0,template:KR.Util.getDatasetTemplate("digitalt_fortalt"),noListThreshold:1/0,description:"Digitalt fortalt"},verneomr:{id:"verneomraader",dataset:{api:"cartodb",table:"naturvernomrader_utm33_2",columns:["iid","omradenavn","vernef_id","verneform"]},provider:"Naturbase",name:"Verneområder",template:KR.Util.getDatasetTemplate("verneomraader"),getFeatureData:function(a,c){b.getNorvegianaItem("kulturnett_Naturbase_"+a.properties.iid,c)},toPoint:{showAlways:!0,stopPolyClick:!0,minSize:20},minZoom:10,cluster:!1,description:"Verneområder fra Naturbase, polygoner og punkter"},artobs:{name:"Artsobservasjoner",dataset:{api:"norvegiana",dataset:"Artsdatabanken"},cluster:!1,description:"Artsobservasjoner fra Artsdatabanken",template:KR.Util.getDatasetTemplate("popup")},folketelling:{name:"Folketelling 1910",provider:"Folketelling 1910",dataset:{api:"folketelling",dataset:"property"},isStatic:!1,minZoom:14,template:KR.Util.getDatasetTemplate("folketelling"),getFeatureData:function(a,c){b.getData({api:"folketelling",type:"propertyData",propertyId:a.properties.efid},function(a){a.properties.provider="Folketelling 1910",c(a)})},mappings:{title:"gaardsnavn_gateadr"},noListThreshold:0,description:"Eiendommer fra folketelling 1910"},wikipedia:{name:"Wikipedia",provider:"Wikipedia",dataset:{api:"wikipedia"},style:{thumbnail:!0},minZoom:13,template:KR.Util.getDatasetTemplate("wikipedia"),description:"Geotaggede artikler fra bokmålswikipedia"},ark_hist:{grouped:!0,name:"Arkeologi og historie",
datasets:[{name:"MUSIT",provider:"Universitetsmuseene",dataset:{api:"norvegiana",dataset:"MUSIT"},template:KR.Util.getDatasetTemplate("musit")},{name:"DiMu",dataset:{api:"norvegiana",dataset:"DiMu"},template:KR.Util.getDatasetTemplate("digitalt_museum"),isStatic:!1},{id:"riksantikvaren",name:"Riksantikvaren",provider:"Riksantikvaren",dataset:{api:"kulturminnedataSparql",kommune:c},template:KR.Util.getDatasetTemplate("ra_sparql"),bbox:!1,isStatic:!0,init:d.initKulturminnePoly,loadWhenLessThan:{count:5,callback:d.loadKulturminnePoly}}],description:"Data fra Universitetsmuseene, Digitalt museum og Riksantikvaren"},riksantikvaren:{id:"riksantikvaren",name:"Riksantikvaren",hideFromGenerator:!0,provider:"Riksantikvaren",dataset:{api:"kulturminnedataSparql",kommune:c},template:KR.Util.getDatasetTemplate("ra_sparql"),bbox:!1,isStatic:!0,init:d.initKulturminnePoly,loadWhenLessThan:{count:5,callback:d.loadKulturminnePoly}}};return c||(e.ark_hist.datasets[2].noLoad=!0),e},a.getDatasets=function(b,c,d){var e=a.getDatasetList(c,d);return _.chain(b).map(function(a){return _.has(e,a)?e[a]:void 0}).compact().value()}}(KR.Config);var KR=this.KR||{};KR.SplashScreen=function(a,b,c,d){"use strict";function e(){var a=window.location.href,b="remember_"+a+"=",c=document.cookie.split("; "),d=_.find(c,function(a){return 0===a.indexOf(b)});return d?"true"===d.substring(b.length,d.length):void 0}function f(a){var b=window.location.href;document.cookie="remember_"+b+"="+a}function g(a){this._gray&&this._container.removeChild(this._gray),L.Control.Sidebar.prototype.hide.apply(this,arguments)}function h(a){this._gray=L.DomUtil.create("div","gray",this._container),L.Control.Sidebar.prototype.show.apply(this,arguments)}function i(){var e=L.DomUtil.create("div","",document.body);e.id="splashscreen";var f=L.control.sidebar("splashscreen",{position:"center",autoPan:!1});f.hide=_.bind(g,f),f.show=_.bind(h,f),a.addControl(f);var i="<h2>"+b+"</h2>";return d&&(i+='<img class="splash-image" src="'+d+'" />'),c&&(i+='<div class="splash-content">'+c+"</div>"),f.setContent(i),f}function j(a){function b(){f(c.prop("checked"))}var c=$('<input type="checkbox">');c.prop("checked",e());var d=$('<label class="splash-content"></label');d.append([c," Ikke vis ved oppstart."]),$(a.getContainer()).append(d),c.on("change",b),b()}function k(b){return L.easyButton(a,b,{position:"topright",icon:"fa-info-circle",title:"Om"})}var l=i();k(function(){l.isVisible()?l.hide():l.show()});var m=e();m||(_.isUndefined(m)&&f(!0),setTimeout(function(){l.show()},500)),j(l)};var KR=this.KR||{};!function(a){"use strict";function b(a){return function(b){if(!b||!b.length)return b;if(-1===b.features[0].geometry.type.indexOf("Polygon"))return turf.within(b,a);var c=_.filter(b.features,function(b){var c=turf.extent(b),d=turf.bboxPolygon(c);return!!turf.intersect(d,a.features[0])});return KR.Util.createFeatureCollection(c)}}function c(a){var b=KR.Util.getDatasetTemplate("popup"),c=_.template($("#list_item_template").html()),d=_.template($("#marker_template").html()),e=_.template($("#thumbnail_template").html()),f=_.template($("#footer_template").html()),g=L.Knreise.Control.sidebar("sidebar",{position:"left",template:b,listElementTemplate:c,markerTemplate:d,thumbnailTemplate:e,footerTemplate:f});return a.addControl(g),g}function d(a){var b=L.map("map",{minZoom:3,maxZoom:21,maxBounds:L.geoJson(o).getBounds()}),c=a.layer||"norges_grunnkart_graatone";return KR.Util.getBaseLayer(c,function(a){a.addTo(b)}),L.Knreise.LocateButton().addTo(b),b}function e(a,b,c,d){return c&&(b=KR.Config.getDatasets(b,a,d)),b}function f(a,b){var c={stroke:!1,fillColor:"#ddd",fillOpacity:.8},d=_.reduce(b.features,function(a,b){return turf.erase(a,b)},o);L.geoJson(d,c).addTo(a)}function g(a,c,d,e,g,h,i){if(a.geomFilter){var j={api:"cartodb"};j[h]=g,c.getData(j,function(c){a.showGeom&&f(a.map,c);var e=L.geoJson(c),g=b(c);i(e.getBounds(),d,g)})}else e(g,function(a){var b=L.latLngBounds.fromBBoxString(a);i(b,d)})}function h(a,b,c,d,f){c=e(b,c,d,a.komm),_.isString(a.komm)&&(a.komm=a.komm.split(",")),g(a,b,c,b.getMunicipalityBounds,a.komm,"municipality",f)}function i(a,b,c,d,f){c=e(b,c,d),g(a,b,c,b.getCountyBounds,a.fylke.split(","),"county",f)}function j(a,b,c,d,f){c=e(b,c,d);var g=L.latLngBounds.fromBBoxString(a.bbox);f(g,c)}function k(a){var b=[];return _.each(a.features,function(a){"GeometryCollection"===a.geometry.type?_.each(a.geometry.geometries,function(c){b.push(KR.Util.createGeoJSONFeatureFromGeom(c,a.properties))}):b.push(a)}),KR.Util.createFeatureCollection(b)}function l(a){var b=_.map(a.features,function(a){return turf.simplify(a,.01,!1)});return KR.Util.createFeatureCollection(b)}function m(a,c,d,f,g,h){var i={};d.linecolor&&(i.color=d.linecolor);var j=L.geoJson(a,i),m=j.getBounds();f=e(c,f,g);var n;if(a&&d.buffer){a=k(a),a.features.length>5&&(a=l(a));var o=turf.buffer(a,d.buffer,"kilometers");n=b(o)}h(m,f,n,j)}function n(a,b,c,d,e){KR.Util.getLine(b,a.line,function(f){m(f,b,a,c,d,e)})}var o={type:"Feature",geometry:{type:"Polygon",coordinates:[[[-180,-90],[-180,90],[180,90],[180,-90],[-180,-90]]]}};a.setupMap=function(a,b,e,f){function g(a,b,c,d){e.allstatic&&(b=_.map(b,function(a){return a.isStatic=!0,a.datasets&&(a.datasets=_.map(a.datasets,function(a){return a.isStatic=!0,a})),a})),k.fitBounds(a);var f=m.loadDatasets(b,a.toBBoxString(),c);d&&d.addTo(k),L.control.datasets(f).addTo(k),e.title&&KR.SplashScreen(k,e.title,e.description,e.image)}e=e||{},e=_.extend({geomFilter:!1,showGeom:!1},e);var k=d(e),l=c(k),m=new KR.DatasetLoader(a,k,l);return e.map=k,e.komm?h(e,a,b,f,g):e.fylke?i(e,a,b,f,g):e.line?n(e,a,b,f,g):e.bbox?j(e,a,b,f,g):alert("Missing parameters!"),k},a.setupMapFromUrl=function(b,c,d){a.setupMap(b,c,d,!0)}}(KR);