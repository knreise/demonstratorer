var KR=this.KR||{};!function(a){"use strict";a.parseError=function(a){if(a.responseJSON){if(a.responseJSON.error)return a.responseJSON.error.join(", ");if(a.responseJSON.status)return a.responseJSON.status}return a.statusText?a.statusText:a.error?a.error.info?a.error.info:a.error.error?a.error.error:a.error:"Unknown error"},a.errorHandler=function(b){var c=$(b);c.find(".close").on("click",function(){c.find(".content").html(""),c.remove()});var d=_.template("<div><strong><%= dataset %>:</Strong> <%= error %></div>");return function(b){var e=d({dataset:b.dataset,error:a.parseError(b.error)});c.parent()?c.find(".content").append(e):c.find(".content").html(e),$("body").append(c)}}}(KR);var KR=this.KR||{};KR.Config={contentIcons:{IMAGE:"camera-retro",VIDEO:"file-video-o",SOUND:"music",TEXT:"file-text","default":"file-o"},templates:{}},KR.Util=KR.Util||{},function(a){"use strict";function b(a,b){if(b.datasets){var c=_.find(b.datasets,function(b){return b._knreise_id===a.properties.datasetID});return c.template}return b.template}function c(a,b){var c=a.lastIndexOf(b);return-1!==c&&c+b.length===a.length}a.iconForContentType=function(a){var b=a.properties.contentType;return _.has(KR.Config.contentIcons,b)?KR.Config.contentIcons[b]:KR.Config.contentIcons["default"]},a.getDatasetTemplate=function(a){var b=$("#"+a+"_template").html();return b?_.template(b):void 0},a.templateForDataset=function(a){return _.has(KR.Config.templates,a)?KR.Config.templates[a]:void 0},a.createStyleString=function(a){return _.map(a,function(a,b){return b+": "+a}).join(";")},a.colorForProvider=function(a,b){var c=!0;"hex"!==b&&(c=!1);var d={properties:{datasetId:a}};return KR.Style.colorForFeature(d,c,!0)},a.featureClick=function(a){return function(b,c,d){c.on("click",function(c){d.toPoint&&d.toPoint.stopPolyClick&&!c.parent||(d?a.showFeature(b,d.template,d.getFeatureData):a.showFeature(b))})}},a.clusterClick=function(a){return function(c,d){c.on("clusterclick",function(c){var e=_.map(c.layer.getAllChildMarkers(),function(a){var c=a.feature;return c.template=b(c,d),c});a.showFeatures(e,d.template,d.getFeatureData,d.noListThreshold)})}},a.hexToRgba=function(a,b){b=b||1;var c=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(a);if(!c)return 0;var d={r:parseInt(c[1],16),g:parseInt(c[2],16),b:parseInt(c[3],16)};return"rgba("+d.r+","+d.g+","+d.b+","+b+")"},a.filterByBbox=function(a,b){var c=turf.featurecollection([turf.bboxPolygon(KR.Util.splitBbox(b))]);return turf.within(a,c)},a.getDatasetId=function(a){return"norvegiana"===a.dataset.api?a.dataset.dataset:"wikipedia"===a.dataset.api?"wikipedia":a.id?a.id:KR.Util.stamp(a)},"undefined"!=typeof L&&(L.latLngBounds.fromBBoxString=function(a){return a=KR.Util.splitBbox(a),new L.LatLngBounds(new L.LatLng(a[1],a[0]),new L.LatLng(a[3],a[2]))}),a.parseQueryString=function(a){var b=decodeURIComponent(a);if(""!==b)return _.reduce(b.replace("?","").split("&"),function(a,b){b=b.split("=");var c=b[1];return"true"===c?c=!0:"false"===c&&(c=!1),a[b[0]]=c,a},{})};var d=_.template("<%= totalt %> (<%= menn %> menn, <%= kvinner %> kvinner)");a.formatPersons=function(a){var b=a.split("-");return b.length<2?a:d({totalt:b[0],menn:b[1],kvinner:b[2]})},a.getBaseLayer=function(a,b){var c={nib:KR.getNibLayer,hist:function(a){a(L.tileLayer.wms("http://wms.geonorge.no/skwms1/wms.historiskekart",{layers:"historiskekart",format:"image/png",attribution:"Kartverket"}))}};_.has(c,a)?c[a](b):b(L.tileLayer.kartverket(a))},a.getLine=function(a,b,d){if(_.isFunction(b))return void b(function(a){d(a)});var e;if(0===b.indexOf("utno/")){var f=b.replace("utno/","");e={api:"utno",id:f,type:"gpx"}}else 0===b.indexOf("http")&&c(b,"kml")&&(e={api:"kml",url:b});e&&a.getData(e,function(a){d(a)})},a.messageDisplayer=function(a){return function(b,c){var d=$(a);d.find(".close").on("click",function(){d.find(".content").html(""),d.remove()}),d.addClass("alert-"+b),d.find(".content").html(c),$("body").append(d)}},a.mostlyCoveringMunicipality=function(a,b,c){var d="ST_MakeEnvelope("+b+", 4326)",e="SELECT komm FROM kommuner WHERE ST_Intersects(the_geom, "+d+")ORDER BY st_area(st_intersection(the_geom, "+d+")) DESC LIMIT 1",f={api:"cartodb",query:e,mapper:function(a){return a.rows[0].komm}};a.getData(f,c)},a.round=function(a,b){b=b||2;var c=Math.pow(10,b);return Math.round(a*c)/c};var e=_.template("#<%= zoom %>/<%= lat %>/<%= lon %>");a.getPositionHash=function(b,c,d){return e({zoom:d,lat:a.round(b,4),lon:a.round(c,4)})}}(KR.Util);var KR=this.KR||{};KR.Style={},function(a){"use strict";function b(a){var b=a.properties.vernef_id;return _.find(o,function(a){return-1!==a.ids.indexOf(b)})}function c(a){return t[a]||"blue"}function d(a,b,c,d){return _.isFunction(a[b])?d?a[b]():a[b](c):a[b]}function e(a,b,c){return c?d(a,"fillcolor",b,!0):d(a,"fillcolor",b)}function f(a,b){return a.bordercolor?d(a,"bordercolor",b):e(a,b)}function g(b){var c;return b.properties&&b.properties.groupId?a.groups[b.properties.groupId]:(b.properties&&b.properties.datasetId&&(c=a.getDatasetStyle(b.properties.datasetId)),c?c:_.extend({},r))}function h(a,b,c){return c=c||9,{radius:c,weight:1,opacity:1,color:a,fillColor:b,fillOpacity:.4}}function i(a,b,c){return L.circleMarker(a,h(b,c))}function j(a){return L.Knreise.icon({markerColor:c(a)})}function k(a,b,c){var d="";return a.properties&&a.properties.title&&(d=a.properties.title),L.marker(b,{icon:c,title:d})}function l(a,b,c){if(a.properties&&a.properties.thumbnail){var d={"border-color":b,"background-image":"url("+a.properties.thumbnail+")"};c&&(d["border-width"]="3px");var e='<div class="outer"><div class="circle" style="background-image: url('+a.properties.thumbnail+");border-color:"+b+';"></div></div>';return new L.DivIcon({className:"leaflet-marker-circle",html:e,iconSize:[50,50],iconAnchor:[25,25]})}}function m(a,b,c){var d=_.filter(a,function(a){return a.feature.properties.thumbnail});if(d.length){var e={"border-color":b,"background-image":"url("+d[0].feature.properties.thumbnail+");"};c&&(e["border-width"]="3px");var f='<div class="outer"><div class="circle" style="'+KR.Util.createStyleString(e)+'"></div></div><b>'+a.length+"</b>";return new L.DivIcon({className:"leaflet-marker-photo",html:f,iconSize:[60,60],iconAnchor:[30,30]})}}function n(a,b){var c=KR.Util.hexToRgba(b,.4);return new L.DivIcon({className:"leaflet-marker-circle",html:'<div class="outer"><div class="circle" style="background-color: '+c+";border-color:"+b+';"></div></div><b>'+a.length+"</b>",iconSize:[20,20],iconAnchor:[10,10]})}var o={landskapsvern:{ids:["LVO","LVOD","LVOP","LVOPD","BV","MAV","P","GVS","MIV","NM","BVV","PO","DO","D"],style:{fillColor:"#d8cb7a",color:"#9c8f1b"}},nasjonalpark:{ids:["NP","NPS"],style:{fillColor:"#7f9aac",color:"#b3a721"}},naturreservat:{ids:["NR","NRS"],style:{fillColor:"#ef9874",color:"#ef9873"}}},p="#72B026",q="#38A9DC",r={fillcolor:q,circle:!1,thumbnail:!0},s={difo:"Digitalt fortalt",Kulturminnesok:"Kulturminnesok",DiMu:"DigitaltMuseum",MUSIT:"Musit",Artsdatabanken:"Artsdatabanken",wikipedia:"wikipedia",riksantikvaren:"riksantikvaren"};a.datasets={"Digitalt fortalt":{fillcolor:"#F69730",circle:!1,thumbnail:!0},Kulturminnesok:{fillcolor:"#436978",circle:!1,thumbnail:!1},DigitaltMuseum:{fillcolor:"#436978",circle:!1,thumbnail:!1},Musit:{fillcolor:"#436978",circle:!1,thumbnail:!1},Artsdatabanken:{fillcolor:"#5B396B",thumbnail:!1,circle:!0},riksantikvaren:{fillcolor:"#436978",circle:!1,thumbnail:!0},verneomraader:{fillcolor:function(a){if(a){var c=b(a);if(c)return c.style.fillColor}return"#009300"},bordercolor:function(a){if(a){var c=b(a);if(c)return c.style.color}return"#009300"},thumbnail:!1,circle:!0},wikipedia:{fillcolor:"#D14020",thumbnail:!0}},a.groups={},a.getDatasetStyle=function(b){var c=a.datasets[s[b]];return c||(c=a.datasets[b]),c},a.setDatasetStyle=function(b,c){_.has(s,b)||(s[b]=b);var d=a.getDatasetStyle(b);d||(d=r),a.datasets[s[b]]=_.extend({},d,c)};var t={"#F69730":"orange","#38A9DC":"blue","#A23336":"darkred","#72B026":"green","#436978":"cadetblue","#5B396B":"darkpurple","#728224":"darkgreen","#D252B9":"purple","#D14020":"red"};a.getClusterIcon=function(a,b){var c=a.getAllChildMarkers(),d=g(c[0].feature),f=b?p:e(d,c[0].feature);if(d.thumbnail){var h=m(c,f,b);if(h)return h}return n(c,f)},a.getIcon=function(a,b){var c=g(a),d=b?p:e(c,a),i=b?p:f(c,a);if(c.thumbnail){var k=l(a,i,b);if(k)return k}return c.circle?h(i,d,c.radius):j(d)},a.getMarker=function(b,c){var d=g(b);if(d.thumbnail){var h=l(b,f(d,b),!1);if(h)return k(b,c,h)}return d.circle?i(c,f(d,b),e(d,b)):k(b,c,a.getIcon(b,!1))},a.colorForFeature=function(a,b,d){var f=g(a);return f?b?e(f,a,d):c(e(f,a)):void 0},a.colorForDataset=function(b,d,f){var h,i;return b.grouped?(h=a.groups[KR.Util.stamp(b)],h||(i=b.datasets[0].extras.datasetId)):(i||(i=b.extras.datasetId),h=g({properties:{datasetId:i}})),h?d?e(h,null,f):c(e(h,null)):void 0},a.getPathStyle=function(a,b){b=b||!1;var c=g(a),d=e(c,a),h=f(c,a);return{weight:1,color:h,fillColor:d,clickable:b,opacity:.8,fillOpacity:.4}},a.getPathStyleForGroup=function(b,c){var d={properties:{groupId:b}};return a.getPathStyle(d,c)}}(KR.Style);var KR=this.KR||{};KR.PathTracer=function(a,b,c){"use strict";function d(b,c){Cesium.Math.setRandomNumberSeed(3),a.clock.startTime=b.clone(),a.clock.stopTime=c.clone(),a.clock.currentTime=b.clone(),a.clock.clockRange=Cesium.ClockRange.LOOP_STOP,a.clock.multiplier=l,a.clock.shouldAnimate=!1}function e(b,c,d){var e=a.entities.add({availability:new Cesium.TimeIntervalCollection([new Cesium.TimeInterval({start:b,stop:c})]),position:d,orientation:new Cesium.VelocityOrientationProperty(d)});return e}function f(a,b,c){b=b.reverse(),c.geometry.coordinates=c.geometry.coordinates.reverse();var d=0,e=turf.point(c.geometry.coordinates[0]),f=new Cesium.SampledPositionProperty;return _.each(b,function(b,g){var h=turf.point(c.geometry.coordinates[g]);d+=1e3*turf.distance(e,h,"kilometers"),e=h;var i=Cesium.JulianDate.addSeconds(a,d/k,new Cesium.JulianDate),j=new Cesium.Cartesian3(b.x,b.y,b.z+2);f.addSample(i,j)}),f}function g(b){a.clock.onTick.addEventListener(function(c){if(m){var d=Cesium.Cartesian3,e=b.position.getValue(c.currentTime,new d),f=b.position.getValue(Cesium.JulianDate.addSeconds(c.currentTime,1/60,new Cesium.JulianDate),new d),g=d.subtract(f,e,new d);d.normalize(g,g);var h=new d,i=new d,j=new d;Cesium.Ellipsoid.WGS84.geodeticSurfaceNormal(e,h),d.cross({x:0,y:0,z:1},h,i),d.cross(h,i,j);var k=new d;k.x=d.dot(g,i),k.y=d.dot(g,j),k.z=d.dot(g,h);var l=new d(0,0,1),o=new d(1,0,0),p=new d(0,1,0),q=d.dot(k,o),r=d.dot(k,p),s=d.dot(k,l),t=Math.atan2(q,r),u=Math.asin(s);t+=0*Math.PI,u+=-20/180*Math.PI;var v=800,w=new Cesium.HeadingPitchRange(t,u+n,v);a.scene.camera.lookAt(b.position.getValue(c.currentTime),w)}})}function h(){var h=c.features[0],i=1e3*turf.lineDistance(h,"kilometers"),j=i/k,l=Cesium.JulianDate.fromDate(new Date(2015,2,25,16)),m=Cesium.JulianDate.addSeconds(l,j,new Cesium.JulianDate);d(l,m);var n=f(l,b,h),o=e(l,m,n);o.position.setInterpolationOptions({interpolationDegree:5,interpolationAlgorithm:Cesium.LagrangePolynomialApproximation}),a.trackedEntity=void 0,g(o)}function i(){m=!0,a.clock.shouldAnimate=!0}function j(){m=!1,a.clock.shouldAnimate=!1}var k=1.4,l=35,m=!1,n=0;return h(),{start:i,stop:j,isRunning:function(){return m},setPitchCorr:function(a){n=a}}};var KR=this.KR||{};KR.CesiumMap=function(a,b,c){"use strict";function d(a){return a=a||"//assets.agi.com/stk-terrain/world",new Cesium.CesiumTerrainProvider({url:a,requestVertexNormals:!0,requestWaterMask:!1})}function e(a){var b,c=s.scene.camera;c.moveEnd.addEventListener(function(){var d=Cesium.Ellipsoid.WGS84.cartesianToCartographic(c.position),e=!Cesium.Rectangle.contains(a,d);e&&b&&(c.position=b),b=c.position.clone()})}function f(){s=new Cesium.Viewer(a,t.cesiumViewerOpts);var b=s.scene;b.imageryLayers.removeAll();var f=b.globe;t.cesiumViewerOpts.enableLighting&&(f.enableLighting=!0),f.depthTestAgainstTerrain=!0,s.terrainProvider=d(t.cesiumViewerOpts.terrainUrl);var g,h=b.camera;if(c){c=KR.Util.splitBbox(c);var i=Cesium.Ellipsoid.WGS84;g=new Cesium.Rectangle(Cesium.Math.toRadians(c[0]),Cesium.Math.toRadians(c[1]),Cesium.Math.toRadians(c[2]),Cesium.Math.toRadians(c[3])),h.viewRectangle(g,i)}g&&t.cesiumViewerOpts.limitBounds&&e(g)}function g(a,b){var c=a.features[0].geometry.coordinates,d=_.map(c,function(a){return new Cesium.Cartographic.fromDegrees(a[0],a[1])}),e=Cesium.sampleTerrain(s.terrainProvider,14,d);Cesium.when(e,function(a){b(Cesium.Ellipsoid.WGS84.cartographicArrayToCartesianArray(a))})}function h(a){return _.map(a,function(a,b){return b+"="+a}).join("&")}function i(a){return new Cesium.UrlTemplateImageryProvider({url:a})}function j(a,b,c){var d={SERVICE:"WMTS",REQUEST:"GetTile",TILEROW:"{TileRow}",TILECOL:"{TileCol}",STYLE:"{Style}",LAYER:b};return{url:a+"?"+h(_.extend({},d,c||{})),layer:"",tileMatrixSetID:""}}function k(a,b,c){var d={style:"default",version:"1.0.0",format:"image/png",maximumLevel:19};return new Cesium.WebMapTileServiceImageryProvider(_.extend({},d,j(a,b,c)))}function l(a,b){return new Cesium.WebMapServiceImageryProvider({url:a,layers:b,parameters:{service:"WMS",version:"1.1.1",request:"GetMap",styles:"",format:"image/png",transparent:!0}})}function m(a){return _.map(a,function(a){var b={position:Cesium.Cartesian3.fromDegrees(a.pos.lng,a.pos.lat,a.pos.height||80),billboard:{image:a.icon,show:!0,heightReference:2,verticalOrigin:Cesium.VerticalOrigin.BOTTOM,scale:1},label:{text:a.text,font:"14pt monospace",style:Cesium.LabelStyle.FILL_AND_OUTLINE,outlineWidth:2,verticalOrigin:Cesium.VerticalOrigin.BOTTOM,pixelOffset:new Cesium.Cartesian2(0,32)},properties:a.properties};return s.entities.add(b),b})}function n(a,b,c,d){c=c||14;var e=[];d||(d=0),_.each(a.features,function(a){var b=a.geometry.coordinates;e.push(new Cesium.Cartographic.fromDegrees(b[0],b[1]))});var f=Cesium.sampleTerrain(s.terrainProvider,c,e);Cesium.when(f,function(c){var e=c;_.each(a.features,function(a,b){var c=e[b];a.geometry.coordinates=[Cesium.Math.toDegrees(c.longitude),Cesium.Math.toDegrees(c.latitude),c.height+d]}),b(a)})}function o(a){var b=new Cesium.EntityCollection,c=new Cesium.ScreenSpaceEventHandler(s.scene.canvas);c.setInputAction(function(c){var d=s.scene.drillPick(c.position);if(Cesium.defined(d)){b.removeAll();var e=_.map(d,function(a){console.log(a);var c=a.id;return b.add(c),c.properties});e.length&&a(e)}},Cesium.ScreenSpaceEventType.LEFT_CLICK)}function p(a,b,c,d){c.getBbox(a,b,function(a){n(a,function(a){var b=Cesium.GeoJsonDataSource.load(a);d(b)})})}function q(a,b,c,d,e){c.getBbox(a,b,function(a){_.each(a.features,function(a){a.properties=_.extend(a.properties,d)}),n(a,function(a){var b=_.map(a.features,function(a){var b=a.properties["marker-color"]||"blue";return{pos:{lat:a.geometry.coordinates[1],lng:a.geometry.coordinates[0],height:a.geometry.coordinates[2]},icon:"../common/img/markers/"+b+".png",properties:a.properties}});m(b)})})}function r(){$(".spinner-wrapper").delay(2e3).fadeOut({duration:200})}Cesium.BingMapsApi.defaultKey="";var s,t={cesiumViewerOpts:_.extend({timeline:!1,baseLayerPicker:!1,geocoder:!1,enableLighting:!0,infoBox:!1,animation:!1,orderIndependentTranslucency:!1},b||{})};return f(),{viewer:s,addMarkers:m,build3DLine:g,addClickhandler:o,loadDataset:p,loadDataset2:q,stopLoading:r,getTiles:i,getWmts:k,getWms:l,addImageryProvider:function(a){s.imageryLayers.addImageryProvider(a)}}},KR.CesiumUtils={},KR.CesiumUtils.getBounds=function(a){"use strict";var b=turf.envelope(a),c=b.geometry.coordinates[0];return c[0].concat(c[2]).join(",")};var KR=this.KR||{};KR.CesiumSidebar=function(a,b,c,d){"use strict";function e(a){o.html("")}function f(a){return{properties:a,template:a.template}}function g(a){p.showFeature(f(a))}function h(a){var b=_.map(a,f);p.showFeatures(b)}function i(b){a.show("slide",{direction:"left"},100),1===b.length?g(b[0]):h(b)}function j(){a.hide("slide",{direction:"left"},100),e(""),q&&q()}d=d||{footerTemplate:_.template($("#footer_template").html()),listElementTemplate:_.template($("#list_item_template").html()),markerTemplate:_.template($("#marker_template").html()),thumbnailTemplate:_.template($("#thumbnail_template").html())};var k=$('<div id="sidebar"></div>');a.append(k);var l=$('<div class="top-menu"></div>');k.append(l);var m=$('<a class="close pull-right">×</a>');l.append(m);var n=$("<span></span>");l.append(n);var o=$('<div class="sidebar-content"></div>');k.append(o);var p=new KR.SidebarContent(k,o,n,d),q=c;return a.addClass("knreise-sidebar"),m.click(j),{show:i,addCloseCb:function(a){q=a}}};var KR=this.KR||{};KR.SidebarContent=function(a,b,c,d){"use strict";function e(a){b.html(a)}function f(a){a&&b.swipe({swipe:function(){},allowPageScroll:"vertical"}).off("swipeLeft").on("swipeLeft",function(){a.next&&a.next()}).off("swipeRight").on("swipeRight",function(){a.prev&&a.prev()})}function g(a,b,c,e,f,h){var k;b>0&&(k=function(d){d&&d.preventDefault(),b-=1,a=f[b];var j=g(a,b,c,e,f,h);i(a,c,e,j,b,f.length)});var l;return b<f.length-1&&(l=function(d){d&&d.preventDefault(),b+=1,a=f[b];var j=g(a,b,c,e,f,h);i(a,c,e,j,b,f.length)}),h||(h=function(){j(f,c,e,d.noListThreshold,!0)}),{prev:k,close:h,next:l}}function h(a,b,c,e,f){var h;h=a.properties.thumbnail?d.thumbnailTemplate({thumbnail:a.properties.thumbnail,color:KR.Style.colorForFeature(a,!0)}):d.markerTemplate({icon:"",color:KR.Style.colorForFeature(a)});var j=$(d.listElementTemplate({title:a.properties.title,marker:h}));return j.on("click",function(d){d.preventDefault();var h=g(a,b,c,e,f);return i(a,c,e,h,b,f.length),!1}),j}function i(g,h,j,l,m,n){if(j){var o="";return g.properties.title&&(o+="<h3>"+g.properties.title+"</h3>"),o+='<i class="fa fa-spinner fa-pulse fa-3x"></i>',e(o),void j(g,function(a){a.properties=_.extend(g.properties,a.properties),i(a,h,null,l,m,n)})}h=h||g.template||KR.Util.templateForDataset(g.properties.dataset)||k;var p=g.properties.images;_.isArray(p)&&(p=p[0]),g.properties.images||(g.properties.images=null),g.properties.allProps&&g.properties.allProps.europeana_rights?g.properties.license=g.properties.allProps.europeana_rights[0]:g.properties.license=null,console.log(g.properties);var q=KR.Style.colorForFeature(g,!0,!0),o='<span class="providertext" style="color:'+q+';">'+g.properties.provider+"</span>"+h(_.extend({image:null},g.properties));if(d.footerTemplate&&g.properties.link&&(o+=d.footerTemplate(g.properties)),e(o),f(l),a.find(".prev-next-arrows").remove(),c.html(""),l){var r=$('<a class="pull-left list-btn"><i class="fa fa-bars"></i></a>');c.append(r),r.click(l.close);var s=m+1;c.append($('<div class="top-text pull-left">'+s+" av "+n+"</div>"));var t=$('<a class="prev-next-arrows prev circle"><span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span></a>');a.append(t),l.prev&&t.click(l.prev).addClass("active");var u=$('<a class="prev-next-arrows next circle"><span class="glyphicon glyphicon-chevron-right" aria-hidden="true"></span></a>');a.append(u),l.next&&u.click(l.next).addClass("active")}"undefined"!=typeof audiojs&&audiojs.createAll(),b.scrollTop(0)}function j(a,e,f,i,j){i=void 0===i?d.noListThreshold:i;var k=a.length<=i;if(k&&j!==!0){var l=a[0];b.html("");var m=g(l,0,e,f,a);return void this.showFeature(l,e,f,m,0,a.length)}var n=$('<span class="circle">'+a.length+"</span>");c.html(n);var o=_.chain(a).groupBy(function(a){return a.properties.provider}).map(function(b,c){var d=$("<div></div>"),g=$('<div class="list-group"></ul>'),i=_.map(b,function(b){var c=_.findIndex(a,function(a){return a===b});return h(b,c,e,f,a)},this);return g.append(i),d.append('<h5 class="providertext">'+c+"</h5>"),d.append(g),d}).value();b.html(o),b.scrollTop(0)}var k=KR.Util.getDatasetTemplate("popup");return b=$(b),a=$(a),c=$(c),{showFeature:i,showFeatures:j}};var KR=this.KR||{};KR.DatasetLoader=function(a,b,c,d){"use strict";function e(a){var b=KR.Util.stamp(a);return function(c){return c&&c.features.length?(_.each(c.features,function(c){c.properties.datasetID=b,_.has(a,"circle")&&(c.properties.circle=a.circle),_.has(a,"provider")&&(c.properties.provider=a.provider),_.has(a,"extras")&&(c.properties=_.extend(c.properties,a.extras)),c.properties.feedbackForm=a.feedbackForm,_.has(a,"mappings")&&_.each(a.mappings,function(a,b){c.properties[b]=c.properties[a]})}),c):c}}function f(a){var b=_.reduce(_.without(_.keys(a),"datasets"),function(b,c){return"style"!==c&&(b[c]=a[c]),b},{});if(a.style){b.extras=b.extras||{};var c=KR.Util.stamp(a);b.extras.groupId=c,KR.Style.groups[c]=a.style}return a.datasets=_.map(a.datasets,function(a){return _.extend({},b,a)}),a}function g(a,b){var c={dataset:b,onEachFeature:function(a,c){x&&x(a,c,b)}};return b.style&&(c.style=b.style),L.Knreise.geoJson(a,c)}function h(a,b){a.clearLayers();var c=_.reduce(b,function(a,b){return a.concat(b.toGeoJSON().features)},[]);a.addData(KR.Util.createFeatureCollection(c))}function i(a,c){a.clearLayers();var d=_.reduce(c,function(a,c){return c.setMap(b),a.concat(c.getLayers())},[]);a.addLayers(d)}function j(a,b){a.on("hide",function(){b(!0)}),a.on("show",function(){b(!0)})}function k(a,b){var c;a.cluster?(c=new L.Knreise.MarkerClusterGroup({dataset:a}).addTo(b),w&&w(c,a)):c=g(null,a).addTo(b);var d=!0;return a.minFeatures&&(d=!1),c.enabled=d,c}function l(a,b){a.enabled!==b&&(a.enabled=b,a.fire("changeEnabled"))}function m(a){if(a.datasets&&!a.grouped){var b=_.filter(a.datasets,function(a){return a.visible}).length;return b>0}return a.visible}function n(a){return a.minZoom&&b.getZoom()<a.minZoom?!1:m(a)}function o(a){return a.minZoom&&b.getZoom()<a.minZoom?!1:!0}function p(a){return a.datasets?0===_.filter(a.datasets,function(a){return a.isStatic===!1}).length:a.isStatic}function q(a){var c=[];a.datasets?c=a.datasets:c.push(a),_.each(c,function(a){if(a.loadWhenLessThan){var c=function(){if(a.geoJson){var c=turf.bboxPolygon(KR.Util.splitBbox(b.getBounds().toBBoxString())),d=_.filter(a.geoJson.features,function(a){return turf.inside(a,c)});d.length<=a.loadWhenLessThan.count?a.loadWhenLessThan.callback(b,a,d):a.loadWhenLessThan.callback(b,a)}};b.on("moveend",c),c()}})}function r(a){a.init&&a.init(b,a)}function s(c,f,m,s){function t(a,b){if(c.minFeatures){if(a.numFound&&c.minFeatures<a.numFound)return l(b,!1),KR.Util.createFeatureCollection([]);l(b,!0)}return a}var u=k(c,b);c.datasets?(c.datasets=_.filter(c.datasets,function(a){return!a.noLoad}),_.each(c.datasets,r)):r(c);var v,w=function(j,k,l,m){var p=!j;u.enabled=o(c),u.fire("changeEnabled");var q=l||n(c);if(!q)return void u.clearLayers();var r,s=k||b.getBounds().toBBoxString();r=c.datasets?_.filter(c.datasets,function(a){return a.visible}):[c];var w=[],x=_.after(r.length,function(){u.isLoading=!1,u.fire("dataloadend"),c.cluster?i(u,w):h(u,w),m&&m()});u.isLoading=!0,u.fire("dataloadstart"),_.each(r,function(b){function c(a){b.geoJson=a,u.error=null,f&&(a=f(a));var c;b.cluster?(c=g(i(t(a,u)),b),b.geoJSONLayer=c):c=L.geoJson(i(t(a,u))),w.push(c),x()}function h(a){u.error=a,x(),"abort"!==a.statusText&&(d?d({dataset:b.name,error:a,layer:u}):u.fire("error",a))}var i=e(b);return!p&&b.isStatic||v===s?void c(b.geoJson):void(b.bbox?b.bboxFunc?b.bboxFunc(a,b.dataset,s,c,h):a.getBbox(b.dataset,s,c,h):a.getData(b.dataset,c,h))}),v=s};return w(null,m,void 0,function(){q(c),s&&s()}),(!p(c)||c.minZoom)&&b.on("moveend",w),j(u,w),{layer:u,reload:w}}function t(a){var b=KR.Util.getDatasetId(a);a.extras=a.extras||{},a.extras.datasetId=b,a.style&&KR.Style.setDatasetStyle(b,a.style)}function u(a,b){var c=_.after(y.length,function(){b&&b()});_.each(y,function(b){b(null,null,a,c)})}function v(a,b,c,d){a=_.filter(a,function(a){return!a.noLoad});var e;d&&(e=_.after(a.length,d));var g=_.map(a,function(a){return a=_.extend({},z,a),a.datasets&&f(a),KR.Style.setDatasetStyle&&(a.datasets?_.each(a.datasets,t):t(a)),a.visible||(a.notLoaded=!0),a.minZoom&&a.bbox&&(a.isStatic=!1),s(a,c,b,e)});return y=_.pluck(g,"reload"),_.pluck(g,"layer")}var w,x,y=[],z={isStatic:!0,bbox:!0,cluster:!0,visible:!0};return c&&(w=KR.Util.clusterClick(c),x=KR.Util.featureClick(c)),{loadDatasets:v,reload:u}};var KR=this.KR||{};KR.Config=KR.Config||{},function(a){"use strict";a.getKulturminneFunctions=function(a){var b=function(b,c,d){if(d||c.extraFeatures.clearLayers(),d){var e=_.map(d,function(a){return a.properties.id});if(e.length){var f={api:"kulturminnedataSparql",type:"lokalitetpoly",lokalitet:e};a.getData(f,function(a){c.extraFeatures.clearLayers().addData(a)})}}},c=function(a,b){b.extraFeatures=L.geoJson(null,{onEachFeature:function(a,c){b.extras&&b.extras.groupId?c.setStyle(KR.Style.getPathStyleForGroup(b.extras.groupId)):(a.properties.datasetId=b.id,c.setStyle(KR.Style.getPathStyle(a,!0))),c.on("click",function(){var c=_.find(b.geoJSONLayer.getLayers(),function(b){return b.feature.properties.id===a.properties.lok});c&&c.fire("click")})}}).addTo(a)};return{loadKulturminnePoly:b,initKulturminnePoly:c}},a.getDatasetList=function(b,c,d){var e=a.getKulturminneFunctions(b);c&&3===c.length&&(c="0"+c);var f={difo:{name:"Digitalt fortalt",dataset:{dataset:"difo",api:"norvegiana"},cluster:!0,template:KR.Util.getDatasetTemplate("digitalt_fortalt"),noListThreshold:1/0,description:"Digitalt fortalt",allowTopic:!0,feedbackForm:!0},verneomr:{id:"verneomraader",dataset:{api:"cartodb",table:"naturvernomrader_utm33_2",columns:["iid","omradenavn","vernef_id","verneform"]},provider:"Naturbase",name:"Verneområder",template:KR.Util.getDatasetTemplate("verneomraader"),getFeatureData:function(a,c){b.getItem({api:"norvegiana",id:"kulturnett_Naturbase_"+a.properties.iid},c)},toPoint:{showAlways:!0,stopPolyClick:!0,minSize:20},minZoom:10,cluster:!1,description:"Verneområder fra Naturbase, polygoner og punkter"},artobs:{name:"Artsobservasjoner",dataset:{api:"norvegiana",dataset:"Artsdatabanken"},cluster:!1,description:"Artsobservasjoner fra Artsdatabanken",template:KR.Util.getDatasetTemplate("popup")},folketelling:{name:"Folketelling 1910",provider:"Folketelling 1910",dataset:{api:"folketelling",dataset:"property"},isStatic:!1,minZoom:14,template:KR.Util.getDatasetTemplate("folketelling"),getFeatureData:function(a,c){b.getData({api:"folketelling",type:"propertyData",propertyId:a.properties.efid},function(a){a.properties.provider="Folketelling 1910",c(a)})},mappings:{title:"gaardsnavn_gateadr"},noListThreshold:0,description:"Eiendommer fra folketelling 1910"},wikipedia:{name:"Wikipedia",provider:"Wikipedia",dataset:{api:"wikipedia"},style:{thumbnail:!0},minZoom:13,template:KR.Util.getDatasetTemplate("wikipedia"),description:"Geotaggede artikler fra bokmålswikipedia"},ark_hist:{grouped:!0,name:"Arkeologi og historie",datasets:[{name:"MUSIT",provider:"Universitetsmuseene",dataset:{api:"norvegiana",dataset:"MUSIT"},template:KR.Util.getDatasetTemplate("musit")},{name:"DiMu",dataset:{api:"norvegiana",dataset:"DiMu"},template:KR.Util.getDatasetTemplate("digitalt_museum"),isStatic:!1},{id:"riksantikvaren",name:"Riksantikvaren",provider:"Riksantikvaren",dataset:{api:"kulturminnedataSparql",kommune:c,fylke:d},template:KR.Util.getDatasetTemplate("ra_sparql"),bbox:!1,isStatic:!0,init:e.initKulturminnePoly,loadWhenLessThan:{count:5,callback:e.loadKulturminnePoly}}],description:"Data fra Universitetsmuseene, Digitalt museum og Riksantikvaren"},riksantikvaren:{id:"riksantikvaren",name:"Riksantikvaren",hideFromGenerator:!0,provider:"Riksantikvaren",dataset:{api:"kulturminnedataSparql",kommune:c,fylke:d},template:KR.Util.getDatasetTemplate("ra_sparql"),bbox:!1,isStatic:!0,init:e.initKulturminnePoly,loadWhenLessThan:{count:5,callback:e.loadKulturminnePoly}},jernbane:{id:"jernbane",dataset:{api:"jernbanemuseet"},provider:"Jernbanemuseet",name:"Jernbanemuseet",template:KR.Util.getDatasetTemplate("jernbanemuseet"),getFeatureData:function(a,c){b.getItem({api:"jernbanemuseet",id:a.properties.id},c)},isStatic:!0,bbox:!1,description:"Jernbanemuseet"},arkeologi:{grouped:!0,name:"Arkeologi",style:{fillcolor:"#436978",circle:!1,thumbnail:!0},datasets:[{name:"MUSIT",provider:"Universitetsmuseene",dataset:{api:"norvegiana",dataset:"MUSIT"},template:KR.Util.getDatasetTemplate("musit")},{id:"riksantikvaren",name:"Riksantikvaren",provider:"Riksantikvaren",dataset:{filter:'FILTER regex(?loccatlabel, "^Arkeologisk", "i") .',api:"kulturminnedataSparql",kommune:c,fylke:d},template:KR.Util.getDatasetTemplate("ra_sparql"),bbox:!1,isStatic:!0,init:e.initKulturminnePoly,loadWhenLessThan:{count:5,callback:e.loadKulturminnePoly}}],description:"Arkeologidata fra Universitetsmuseene og Riksantikvaren"},historie:{grouped:!0,name:"Historie",style:{fillcolor:"#D252B9",circle:!1,thumbnail:!0},datasets:[{id:"riksantikvaren",name:"Riksantikvaren",provider:"Riksantikvaren",dataset:{filter:'FILTER (!regex(?loccatlabel, "^Arkeologisk", "i"))',api:"kulturminnedataSparql",kommune:c,fylke:d},template:KR.Util.getDatasetTemplate("ra_sparql"),bbox:!1,isStatic:!0,init:e.initKulturminnePoly,loadWhenLessThan:{count:5,callback:e.loadKulturminnePoly}},{name:"DiMu",dataset:{api:"norvegiana",dataset:"DiMu",query:"-dc_subject_facet:Kunst"},template:KR.Util.getDatasetTemplate("digitalt_museum"),isStatic:!1,bbox:!0},{dataset:{api:"norvegiana",dataset:"Industrimuseum"},isStatic:!1,bbox:!0},{dataset:{api:"norvegiana",dataset:"Foto-SF"},isStatic:!0,bbox:!1,template:KR.Util.getDatasetTemplate("foto_sf")},{dataset:{api:"norvegiana",dataset:"Kystreise"},isStatic:!0,bbox:!1}],description:"Historiedata fra Riksantikvaren og Digitalt museum "},kunst:{grouped:!0,name:"Kunst",style:{fillcolor:"#72B026",circle:!1,thumbnail:!0},datasets:[{name:"DiMu",dataset:{api:"norvegiana",dataset:"DiMu",query:"dc_subject_facet:Kunst"},template:KR.Util.getDatasetTemplate("digitalt_museum"),isStatic:!1}],description:"Kunstdata fra Digitalt museum "}};if(!c&&!d){var g=function(a,b,c,d,e){KR.Util.mostlyCoveringMunicipality(a,c,function(c){1e3>c&&(c="0"+c),b.kommune=c,a.getData(b,d,e)})},h={bbox:!0,minZoom:12,isStatic:!1,bboxFunc:g};_.extend(f.riksantikvaren,h),_.extend(f.ark_hist.datasets[2],h),_.extend(f.arkeologi.datasets[1],h),_.extend(f.historie.datasets[0],h)}return f},a.getDatasets=function(b,c,d,e){var f=a.getDatasetList(c,d,e);return _.chain(b).map(function(a){var b;if(a.indexOf(":")>-1){var c=a.split(":");a=c[0],b=c[1]}if(_.has(f,a)){var d=f[a];return b&&"norvegiana"===d.dataset.api&&(d.dataset.query="dc_subject_text:"+b),d}}).compact().value()}}(KR.Config);var KR=this.KR||{};!function(a){"use strict";function b(a){return turf.featurecollection([turf.simplify(a.features[0],.001,!1)])}function c(a,b){return b=b||{},{polyline:{positions:a,width:5,material:new Cesium.PolylineOutlineMaterialProperty({color:Cesium.Color.ORANGE,outlineWidth:2,outlineColor:Cesium.Color.BLACK})}}}function d(a,b,c){var d=a.layer||"topo2";if("norges_grunnkart_graatone"===d&&(d="norges_grunnkart"),"hist"===d)c(b.getWms("http://wms.geonorge.no/skwms1/wms.historiskekart","historiskekart"));else if("nib"===d){var e="http://knreise.no/nib/?type=token";KR.Util.sendRequest(e,null,function(a){c(0!==a.indexOf("**")?b.getWmts("http://crossorigin.me/http://gatekeeper1.geonorge.no/BaatGatekeeper/gk/gk.nibcache_wmts","NiB",{TILEMATRIXSET:"EPSG:900913",TILEMATRIX:"EPSG:900913:{TileMatrix}",FORMAT:"image/jpeg",GKT:a}):b.getTiles("http://www.webatlas.no/wacloud/servicerepository/combine.aspx?X={x}&Y={y}&Z={z}&layers=TMS_WEBATLAS_STANDARD:1"))})}else c(b.getWmts("http://opencache.statkart.no/gatekeeper/gk/gk.open_wmts",d,{TILEMATRIXSET:"EPSG:3857",TILEMATRIX:"EPSG:3857:{TileMatrix}",FORMAT:"image/png"}))}function e(a){function b(){e.find(".glyphicon").removeClass("glyphicon-play").addClass("glyphicon-pause"),a.start()}function c(){e.find(".glyphicon").removeClass("glyphicon-pause").addClass("glyphicon-play"),a.stop()}function d(){a.isRunning()?c():b()}var e=$("#playpause");return{play:b,pause:c,toggle:d}}var f={animation:!1,baseLayerPicker:!1,fullscreenButton:!1,geocoder:!1,homeButton:!1,infoBox:!1,sceneModePicker:!1,selectionIndicator:!1,timeline:!1,navigationHelpButton:!0,navigationInstructionsInitiallyVisible:!1,orderIndependentTranslucency:!1};a.setupMap3d=function(a,g,h){function i(){
var b=KR.Config.getDatasets(g,a);return _.chain(b).map(function(a){return a.datasets?a.datasets:a}).flatten().filter(function(a){return _.has(a.dataset,"kommune")&&_.isUndefined(a.dataset.kommune)?!1:!0}).value()}function j(a,b){return new KR.CesiumMap(a,_.extend(f,{limitBounds:h.limitBounds,terrainUrl:h.terrainUrl,enableLighting:h.enableLighting}),b)}function k(b,c,d){_.each(b,function(b){var d=KR.Util.getDatasetId(b),e={template:b.template,datasetId:d,"marker-color":KR.Style.colorForFeature({properties:{datasetId:d}},!1)};o.loadDataset2(b.dataset,c,a,e)}),o.addClickhandler(function(a){q.show(a),d&&d()})}function l(a){o=j("cesium-viewer",a),o.viewer.scene.imageryLayers.removeAll(),d(h,o,o.addImageryProvider),k(i(),a),o.stopLoading()}function m(){var f,g,l=!1;KR.Util.getLine(a,h.line,function(a){if(p=KR.CesiumUtils.getBounds(a),o=j("cesium-viewer",p),d(h,o,o.addImageryProvider),k(i(),p,function(){h.player&&(l=f.isRunning(),g.pause(),f.stop())}),o.build3DLine(a,function(a){var b=c(a,{color:Cesium.Color.DEEPSKYBLUE,glow:.25});o.viewer.zoomTo(o.viewer.entities.add(b)),o.stopLoading()}),h.player){var m=b(a);o.build3DLine(m,function(a){f=new KR.PathTracer(o.viewer,a,m),f.setPitchCorr(.1),g=new e(f),$("#playpause").removeClass("hidden"),$("#playpause").click(g.toggle)}),q.addCloseCb(function(){l&&g.play()})}})}function n(){h.bbox?l(h.bbox):h.komm?a.getMunicipalityBounds(h.komm,l):h.line?m():alert("Missing parameters!")}h=h||{},h=_.extend({player:!0,limitBounds:!1},h);var o,p,q=KR.CesiumSidebar($("#cesium-sidebar"),{});n()}}(KR);