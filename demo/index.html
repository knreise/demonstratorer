<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <link href="../bower_components/leaflet/dist/leaflet.css" rel="stylesheet"/>
        <link href='../common/css/fullscreenmap.css' rel='stylesheet' />
    </head>
    <body>
        <div id="map"></div>

        <script src="../bower_components/jquery/dist/jquery.min.js"></script>
        <script src="../bower_components/underscore/underscore-min.js"></script>
        <script src="../bower_components/leaflet/dist/leaflet.js"></script>

        <script src="../common/js/L.TileLayer.Kartverket.js"></script>
        <script src="../common/js/norvegiana.js"></script>

        <script type="text/javascript">
            (function () {
                'use strict';


                var popupTemplate = _.template('<h3><%= title %></h3><img width="400" src="<%=img %>" /><p><%= desc %>');

                var map = L.map('map');

                L.tileLayer.kartverket('topo2graatone').addTo(map);
                var pos = new L.LatLng(59.910586, 10.734329);
                map.setView(pos, 16);

                var api = new NorvegianaAPI();

                var layer;
                function getWithin(pos) {

                    api.getWithin('delving_spec:DiMu', pos, 5000, function (geoJson) {
                        if (layer) {
                            layer.clearLayers();
                        }
                        layer = L.geoJson(
                            geoJson,
                            {
                                onEachFeature: function (feature, layer) {
                                    layer.bindPopup(popupTemplate({
                                        title: feature.properties.dc_title,
                                        img: feature.properties.delving_thumbnail,
                                        desc: feature.properties.dc_description
                                    }), 
                                    {maxWidth: 500});
                                }
                            }
                        ).addTo(map);
                    });
                }

                map.on('click', function (e) {
                    getWithin(e.latlng);
                });

            }());

        </script>
    </body>
</html>
